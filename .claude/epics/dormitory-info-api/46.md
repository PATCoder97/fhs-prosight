---
name: Create database model and migration for dormitory_bills table
status: open
created: 2026-01-12T03:16:26Z
updated: 2026-01-12T03:25:14Z
github: https://github.com/PATCoder97/fhs-prosight/issues/46
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Create Database Model and Migration for dormitory_bills Table

## Description

Create the SQLAlchemy model for the dormitory_bills table and generate the Alembic migration. This table stores employee dormitory billing information including electricity, water, and management fees with a composite unique key on (employee_id, term_code, dorm_code).

## Acceptance Criteria

- [ ] DormitoryBill SQLAlchemy model created in `backend/app/models/dormitory_bill.py`
- [ ] Model includes all 15+ fields (employee_id, term_code, dorm_code, electricity, water, fees)
- [ ] Foreign key constraint to employees table on employee_id
- [ ] Unique constraint on (employee_id, term_code, dorm_code)
- [ ] CHECK constraints for data validation (curr_index >= last_index, amounts >= 0)
- [ ] Indexes created for search performance (employee_id, term_code, dorm_code, total_amount)
- [ ] Composite index on (term_code DESC, created_at DESC) for default sort
- [ ] Alembic migration generated with `alembic revision --autogenerate`
- [ ] Model registered in `backend/app/models/__init__.py`

## Technical Details

**Model File:** `backend/app/models/dormitory_bill.py`

```python
from sqlalchemy import Column, BigInteger, String, Numeric, DateTime, ForeignKey, UniqueConstraint, CheckConstraint, Index
from sqlalchemy.sql import func
from app.database.base import Base

class DormitoryBill(Base):
    __tablename__ = "dormitory_bills"

    # Primary Key
    bill_id = Column(BigInteger, primary_key=True, autoincrement=True)

    # Foreign Keys & Required Fields
    employee_id = Column(String(20), ForeignKey("employees.employee_id"), nullable=False, index=True)
    term_code = Column(String(10), nullable=False, index=True)
    dorm_code = Column(String(20), nullable=False, index=True)

    # Optional Fields
    factory_location = Column(String(100))

    # Electricity Billing
    elec_last_index = Column(Numeric(10, 2), default=0)
    elec_curr_index = Column(Numeric(10, 2), default=0)
    elec_usage = Column(Numeric(10, 2), default=0)
    elec_amount = Column(Numeric(15, 2), default=0)

    # Water Billing
    water_last_index = Column(Numeric(10, 2), default=0)
    water_curr_index = Column(Numeric(10, 2), default=0)
    water_usage = Column(Numeric(10, 2), default=0)
    water_amount = Column(Numeric(15, 2), default=0)

    # Fees
    shared_fee = Column(Numeric(15, 2), default=0)
    management_fee = Column(Numeric(15, 2), default=0)
    total_amount = Column(Numeric(15, 2), default=0, index=True)

    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Constraints
    __table_args__ = (
        UniqueConstraint('employee_id', 'term_code', 'dorm_code', name='uq_bill_entry'),
        CheckConstraint('elec_curr_index >= elec_last_index', name='chk_elec_index'),
        CheckConstraint('water_curr_index >= water_last_index', name='chk_water_index'),
        CheckConstraint('total_amount >= 0 AND elec_amount >= 0 AND water_amount >= 0 AND shared_fee >= 0 AND management_fee >= 0', name='chk_amounts'),
        Index('idx_dormitory_bills_sort', 'term_code', 'created_at', postgresql_using='btree', postgresql_ops={'term_code': 'DESC', 'created_at': 'DESC'}),
    )
```

**Update `backend/app/models/__init__.py`:**
```python
from app.models.dormitory_bill import DormitoryBill
```

**Generate Migration:**
```bash
cd backend
alembic revision --autogenerate -m "Add dormitory_bills table"
```

**Review Migration:** Verify the generated migration includes:
- Table creation with all columns
- Unique constraint on (employee_id, term_code, dorm_code)
- CHECK constraints for validation
- All indexes (individual + composite)
- Foreign key to employees table

## Dependencies

- [ ] `employees` table must exist with `employee_id` column
- [ ] Alembic configured and working
- [ ] Database connection available

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: false (foundation for all other tasks)

## Definition of Done

- [ ] Model file created with all fields and constraints
- [ ] Model registered in __init__.py
- [ ] Alembic migration generated
- [ ] Migration file reviewed for correctness
- [ ] All indexes present in migration
- [ ] CHECK constraints present in migration
- [ ] Committed with message: "Issue #XX: Add dormitory_bills table model and migration"
