---
name: Implement service layer for achievement queries
status: completed
created: 2026-01-10T01:12:36Z
updated: 2026-01-10T06:08:01Z
github: https://github.com/PATCoder97/fhs-prosight/issues/29
depends_on: [27, 28]
parallel: false
conflicts_with: []
---

# Task: Implement Service Layer for Achievement Queries

## Description

Add `get_employee_achievements()` method to the existing `backend/app/services/hrs_data_service.py` file. This service method handles business logic for achievement queries: employee ID validation, HRS API calls, employee name lookup, and error handling.

Mirrors the exact pattern of `get_employee_salary()` in the same file. Total new code: ~50 lines.

## Acceptance Criteria

- [ ] `get_employee_achievements()` async function created
- [ ] Employee ID validation (VNW0006204 → 6204)
- [ ] Calls `hrs_client.get_achievement_data(emp_num)`
- [ ] Looks up employee name from database (Employee model)
- [ ] Returns dict matching `AchievementResponse` schema
- [ ] Error handling: 400 (invalid ID), 404 (no data), 503 (HRS unavailable)
- [ ] Logging for API calls and errors
- [ ] Fallback to "Unknown" if employee not in database

## Technical Details

**File to modify**: `backend/app/services/hrs_data_service.py`

**New Method**:
```python
async def get_employee_achievements(
    db: AsyncSession,
    emp_id: str
) -> dict:
    """
    Get employee achievement/evaluation data.

    Args:
        db: Database session
        emp_id: Employee ID (e.g., "VNW0006204")

    Returns:
        dict matching AchievementResponse schema:
        {
            "employee_id": str,
            "employee_name": str,
            "achievements": [{"year": str, "score": str}]
        }

    Raises:
        HTTPException(400): Invalid employee ID format
        HTTPException(404): No achievement data found
        HTTPException(503): HRS API unavailable
    """
    # Convert emp_id format: VNW0006204 → 6204
    try:
        emp_num = int(emp_id.replace("VNW00", ""))
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid employee ID format: {emp_id}"
        )

    # Query HRS API
    logger.info(f"Fetching achievements for {emp_id}")
    hrs_client = FHSHRSClient()

    try:
        achievement_data = await hrs_client.get_achievement_data(emp_num)
    except Exception as e:
        logger.error(f"HRS API error for {emp_id}: {e}")
        raise HTTPException(
            status_code=503,
            detail="HRS API unavailable"
        )

    if not achievement_data:
        raise HTTPException(
            status_code=404,
            detail=f"No achievement data found for employee {emp_id}"
        )

    # Lookup employee name from database
    employee = await db.get(Employee, emp_id)
    emp_name = employee.name_en if employee else "Unknown"

    if not employee:
        logger.warning(f"Employee {emp_id} not found in database, using 'Unknown'")

    # Return structured response
    return {
        "employee_id": emp_id,
        "employee_name": emp_name,
        "achievements": achievement_data
    }
```

**Pattern to follow**: Mirror `get_employee_salary()` function in the same file

**Imports needed**: Already exist in the file (HTTPException, AsyncSession, Employee, FHSHRSClient, logger)

## Dependencies

- [ ] Task 001 completed (AchievementResponse schema exists)
- [ ] Task 002 completed (get_achievement_data() method exists)
- [ ] Employee model exists (from existing codebase)
- [ ] FHSHRSClient exists (from salary API)

## Effort Estimate

- Size: S
- Hours: 2 hours
- Parallel: false (depends on 001 and 002)

## Definition of Done

- [ ] Code implemented in hrs_data_service.py
- [ ] Employee ID validation working
- [ ] Database lookup working (with fallback)
- [ ] Error handling for all cases (400, 404, 503)
- [ ] Logging messages added
- [ ] Function returns dict matching AchievementResponse schema
- [ ] Committed with message: "Issue #XX: Implement service layer for achievement queries"
- [ ] No breaking changes to existing service methods
