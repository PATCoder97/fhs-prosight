---
name: Add tests and documentation for achievement API
status: completed
created: 2026-01-10T01:12:36Z
updated: 2026-01-10T06:21:03Z
github: https://github.com/PATCoder97/fhs-prosight/issues/31
depends_on: [27, 28, 29, 30]
parallel: false
conflicts_with: []
---

# Task: Add Tests and Documentation for Achievement API

## Description

Create comprehensive test suite and API documentation for the achievement endpoints. Follow the exact same patterns as the salary API tests, adapting for the simpler achievement data structure.

**Test Coverage**:
- Unit tests for `_split_blocks()` parsing (5 test cases)
- Unit tests for `get_employee_achievements()` service (5 test cases)
- Integration tests for both endpoints (10 test cases)
- API usage guide with examples

Total: ~20 unit tests + 10 integration tests + documentation

## Acceptance Criteria

### Unit Tests
- [ ] Test `_split_blocks()` with various formats
- [ ] Test `get_employee_achievements()` with success case
- [ ] Test employee name lookup (found and not found)
- [ ] Test error handling (invalid ID, no data, HRS failure)
- [ ] All unit tests passing (>90% code coverage)

### Integration Tests
- [ ] Test GET /achievements (own) - success
- [ ] Test GET /achievements (own) - unauthenticated (401)
- [ ] Test GET /achievements (own) - no data (404)
- [ ] Test GET /achievements/{employee_id} - success
- [ ] Test GET /achievements/{employee_id} - guest blocked (403)
- [ ] Test GET /achievements/{employee_id} - invalid ID (400)
- [ ] Test GET /achievements/{employee_id} - not found (404)
- [ ] Test GET /achievements/{employee_id} - unauthenticated (401)
- [ ] Test error handling for HRS API unavailable (503)
- [ ] All integration tests passing

### Documentation
- [ ] API usage guide created with examples
- [ ] Both endpoints documented with curl examples
- [ ] Authorization model explained
- [ ] Error codes documented (401, 403, 404, 503)
- [ ] Response schema examples provided
- [ ] Deployment notes (no migrations needed)

## Technical Details

### File 1: `backend/tests/test_hrs_data_service.py` (extend existing)

**Add Test Class**:
```python
class TestGetEmployeeAchievements:
    """Test get_employee_achievements() service method."""

    async def test_get_achievements_success(self, db_session, mock_hrs_client, sample_employee):
        """Test successful achievement retrieval."""
        # Mock HRS client
        mock_hrs_client.get_achievement_data.return_value = [
            {"year": "2024", "score": "甲"},
            {"year": "2023", "score": "甲"}
        ]

        result = await get_employee_achievements(db_session, "VNW0006204")

        assert result["employee_id"] == "VNW0006204"
        assert result["employee_name"] == sample_employee.name_en
        assert len(result["achievements"]) == 2
        assert result["achievements"][0]["year"] == "2024"

    async def test_get_achievements_employee_not_in_db(self, db_session, mock_hrs_client):
        """Test achievement retrieval when employee not in database."""
        mock_hrs_client.get_achievement_data.return_value = [
            {"year": "2024", "score": "甲"}
        ]

        result = await get_employee_achievements(db_session, "VNW0009999")

        assert result["employee_name"] == "Unknown"

    async def test_get_achievements_no_data(self, db_session, mock_hrs_client):
        """Test when HRS API returns no achievement data."""
        mock_hrs_client.get_achievement_data.return_value = []

        with pytest.raises(HTTPException) as exc:
            await get_employee_achievements(db_session, "VNW0006204")

        assert exc.value.status_code == 404

    async def test_get_achievements_invalid_id(self, db_session):
        """Test with invalid employee ID format."""
        with pytest.raises(HTTPException) as exc:
            await get_employee_achievements(db_session, "INVALID")

        assert exc.value.status_code == 400

    async def test_get_achievements_hrs_api_error(self, db_session, mock_hrs_client):
        """Test when HRS API fails."""
        mock_hrs_client.get_achievement_data.side_effect = Exception("HRS API down")

        with pytest.raises(HTTPException) as exc:
            await get_employee_achievements(db_session, "VNW0006204")

        assert exc.value.status_code == 503


class TestSplitBlocks:
    """Test _split_blocks() helper function."""

    def test_split_blocks_normal(self):
        """Test normal pipe-delimited format."""
        text = "2024|甲o|o2023|甲o|o2022|優o|o"
        blocks = _split_blocks(text)
        assert len(blocks) == 3
        assert blocks[0] == "2024|甲"

    def test_split_blocks_single(self):
        """Test single block."""
        text = "2024|甲"
        blocks = _split_blocks(text)
        assert len(blocks) == 1

    def test_split_blocks_empty(self):
        """Test empty string."""
        text = ""
        blocks = _split_blocks(text)
        assert len(blocks) == 0

    def test_split_blocks_with_whitespace(self):
        """Test blocks with extra whitespace."""
        text = " 2024|甲 o|o 2023|優 o|o"
        blocks = _split_blocks(text)
        assert len(blocks) == 2

    def test_split_blocks_malformed(self):
        """Test malformed input."""
        text = "o|o|o|o"
        blocks = _split_blocks(text)
        assert len(blocks) == 0  # All blocks are empty after strip
```

### File 2: `backend/tests/integration/test_achievement_endpoints.py` (new file)

**Create Integration Tests** (follow pattern from test_salary_endpoints.py):
- Test both endpoints with various scenarios
- Mock HRS client responses
- Test authentication/authorization
- Test error cases
- Use FastAPI TestClient

### File 3: `backend/docs/achievement-api-guide.md` (new file)

**Create Documentation**:
```markdown
# Achievement API Usage Guide

## Overview

The Achievement API provides endpoints for viewing employee performance evaluations/achievements across years.

## Endpoints

### 1. GET /api/hrs-data/achievements

Get current user's achievements.

**Authorization**: Bearer token (any authenticated user)

**Response 200**:
{
  "employee_id": "VNW0006204",
  "employee_name": "PHAN ANH TUẤN",
  "achievements": [
    {"year": "2024", "score": "甲"},
    {"year": "2023", "score": "甲"}
  ]
}

**Example**:
curl -H "Authorization: Bearer <token>" \
  http://localhost:8000/api/hrs-data/achievements

### 2. GET /api/hrs-data/achievements/{employee_id}

Get any employee's achievements (authenticated non-guest users only).

**Authorization**: Bearer token (blocks guests)

**Example**:
curl -H "Authorization: Bearer <token>" \
  http://localhost:8000/api/hrs-data/achievements/VNW0006204

## Error Codes

- 401: Unauthorized (missing or invalid token)
- 403: Forbidden (guest user)
- 404: No achievement data found
- 503: HRS API unavailable

## Deployment Notes

No database migrations required. This feature uses existing infrastructure.
```

### Pattern to Follow

- Mirror test structure from `test_salary_endpoints.py`
- Use unittest.mock for HRS client
- Follow pytest conventions
- Include fixtures for test data

## Dependencies

- [ ] Task 004 completed (endpoints exist)
- [ ] pytest installed (existing)
- [ ] unittest.mock available (Python standard library)
- [ ] Test patterns from salary API (reference)

## Effort Estimate

- Size: M
- Hours: 3 hours
- Parallel: false (depends on all previous tasks)

## Definition of Done

- [ ] Unit tests implemented (~10 tests)
- [ ] Integration tests implemented (~10 tests)
- [ ] All tests passing (no failures)
- [ ] Test coverage > 90% for new code
- [ ] API documentation created
- [ ] Documentation includes curl examples
- [ ] Manual testing with real HRS API successful
- [ ] Committed with message: "Issue #XX: Add tests and documentation for achievement API"
- [ ] No test failures in existing salary API tests (no regressions)
