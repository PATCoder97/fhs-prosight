---
name: Implement PIDKey.com integration client
status: closed
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
completed: 2026-01-12T09:12:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/56
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Implement PIDKey.com integration client

## Description
Create an async HTTP client for the PIDKey.com API that handles key validation requests, response parsing, error handling, and retry logic. Follow the existing FHSHRSClient pattern.

## Acceptance Criteria
- [ ] Client created at `backend/app/integrations/pidkey_client.py`
- [ ] Async check_keys() method that calls PIDKey.com API
- [ ] Key formatting: normalize keys with/without dashes to \r\n-separated format
- [ ] Response parsing: extract all 14 fields from JSON array
- [ ] Error handling: retry 3x with exponential backoff
- [ ] Timeout: 30 seconds per request
- [ ] Configuration: API key and base URL from environment variables
- [ ] Logging: log all API calls and responses for debugging
- [ ] Client imported in `backend/app/integrations/__init__.py`

## Technical Details

**File:** `backend/app/integrations/pidkey_client.py`

**Implementation Pattern:**
```python
import httpx
import logging
from typing import List, Dict, Optional
from tenacity import retry, stop_after_attempt, wait_exponential

logger = logging.getLogger(__name__)

class PIDKeyClient:
    """Client for PIDKey.com API - validates Microsoft product keys"""

    def __init__(self, api_key: str, base_url: str = "https://pidkey.com/ajax/pidms_api"):
        self.api_key = api_key
        self.base_url = base_url
        self.timeout = 30.0

    def _format_keys(self, keys: List[str]) -> str:
        """Normalize keys to \r\n-separated format without dashes"""
        normalized = []
        for key in keys:
            # Remove dashes and whitespace
            clean_key = key.replace("-", "").replace(" ", "").strip()
            normalized.append(clean_key)
        return "\\r\\n".join(normalized)

    @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
    async def check_keys(self, keys: List[str]) -> List[Dict]:
        """
        Check product keys against PIDKey.com API

        Args:
            keys: List of product keys (with or without dashes)

        Returns:
            List of dicts with key information from API
        """
        formatted_keys = self._format_keys(keys)

        params = {
            "keys": formatted_keys,
            "justgetdescription": "0",
            "apikey": self.api_key
        }

        try:
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                logger.info(f"Calling PIDKey.com API with {len(keys)} keys")
                resp = await client.get(self.base_url, params=params)
                resp.raise_for_status()

                data = resp.json()
                logger.info(f"PIDKey.com API returned {len(data)} results")
                return data

        except httpx.HTTPStatusError as e:
            logger.error(f"PIDKey.com API HTTP error: {e.response.status_code}")
            raise
        except httpx.RequestError as e:
            logger.error(f"PIDKey.com API request error: {e}")
            raise
        except Exception as e:
            logger.error(f"PIDKey.com API unexpected error: {e}")
            raise
```

**Environment Variables (add to .env):**
```bash
PIDKEY_API_KEY=nVHBz3RIsHpXHofLv3B89iFK8
PIDKEY_BASE_URL=https://pidkey.com/ajax/pidms_api
```

**Files Affected:**
- `backend/app/integrations/pidkey_client.py` (new)
- `backend/app/integrations/__init__.py` (update imports)
- `backend/app/core/config.py` (add PIDKEY_API_KEY, PIDKEY_BASE_URL settings)

## Dependencies
- [ ] httpx library installed
- [ ] tenacity library for retry logic
- [ ] Valid PIDKey.com API key available

## Effort Estimate
- Size: M
- Hours: 4-5 hours
- Parallel: true (no dependencies on other tasks)

## Definition of Done
- [x] Client implemented with all methods
- [x] Retry logic tested (simulate failures)
- [x] Timeout enforced and tested
- [x] Error handling covers all edge cases
- [x] Logging implemented for debugging
- [x] Manual testing with real PIDKey.com API
