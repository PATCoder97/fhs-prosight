---
name: Test with real PIDKey.com API and verify all endpoints
status: closed
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
completed: 2026-01-12T09:12:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/61
depends_on: [60]
parallel: true
conflicts_with: []
---

# Task: Test with real PIDKey.com API and verify all endpoints

## Description
Comprehensive end-to-end testing of all PIDMS endpoints using the real PIDKey.com API. Verify data accuracy, error handling, authentication, and performance benchmarks.

## Acceptance Criteria
- [ ] POST /check tested with real product keys from PIDKey.com
- [ ] GET /search tested with various filters (product, remaining, blocked)
- [ ] GET /products tested and statistics verified
- [ ] POST /sync tested with real keys in database
- [ ] Admin authentication verified (401 for non-admin, 200 for admin)
- [ ] All 14 fields from PIDKey.com stored correctly in database
- [ ] Performance benchmarks met (search <2s, sync batch <30s)
- [ ] Error handling verified (invalid keys, API timeout, etc.)

## Technical Details

**Test Plan:**

### 1. Test POST /check
```bash
# Test with 2 real keys
curl -X POST http://localhost:8000/api/pidms/check \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "keys": "6NRGD-KHFCF-Y4TF7-PRWFD-YBF3H\r\n8NFMQ-FTF43-RQCKR-T473J-JFHB2"
  }'

# Verify:
# - Both keys returned in response
# - Status is "new" for first insertion
# - All 14 fields populated in database
# - Repeat same request - status should be "updated"
```

### 2. Test GET /search
```bash
# Test fuzzy search by product
curl -X GET "http://localhost:8000/api/pidms/search?product=Office&page=1&page_size=10" \
  -H "Authorization: Bearer <admin_token>"

# Verify:
# - All Office15, Office16, etc. products returned
# - Pagination working (total, page, page_size correct)

# Test filter by remaining
curl -X GET "http://localhost:8000/api/pidms/search?min_remaining=1000" \
  -H "Authorization: Bearer <admin_token>"

# Verify:
# - Only keys with remaining >= 1000 returned

# Test blocked filter
curl -X GET "http://localhost:8000/api/pidms/search?blocked=-1" \
  -H "Authorization: Bearer <admin_token>"

# Verify:
# - Only non-blocked keys returned
```

### 3. Test GET /products
```bash
curl -X GET "http://localhost:8000/api/pidms/products" \
  -H "Authorization: Bearer <admin_token>"

# Verify:
# - All unique product codes returned
# - key_count matches actual count in DB
# - total_remaining is sum of all keys for that product
# - avg_remaining is correct
# - low_inventory flag is true if total_remaining < 5
```

### 4. Test POST /sync
```bash
# Insert 10 keys first via /check
# Wait 1 hour (or manually change data in PIDKey.com if possible)
# Run sync
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{}'

# Verify:
# - All keys updated
# - Summary shows total_synced, updated counts
# - No errors

# Test sync with product filter
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"product_filter": "Office16"}'

# Verify:
# - Only Office16 keys synced
```

### 5. Test Authentication
```bash
# Test without token
curl -X GET "http://localhost:8000/api/pidms/products"
# Expected: 401 Unauthorized

# Test with non-admin token
curl -X GET "http://localhost:8000/api/pidms/products" \
  -H "Authorization: Bearer <non_admin_token>"
# Expected: 403 Forbidden

# Test with admin token
curl -X GET "http://localhost:8000/api/pidms/products" \
  -H "Authorization: Bearer <admin_token>"
# Expected: 200 OK
```

### 6. Test Error Handling
```bash
# Test with invalid key format
curl -X POST http://localhost:8000/api/pidms/check \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"keys": "INVALID-KEY"}'

# Verify:
# - Graceful error handling
# - Clear error message

# Test pagination edge cases
curl -X GET "http://localhost:8000/api/pidms/search?page=0" \
  -H "Authorization: Bearer <admin_token>"
# Expected: 422 Validation Error

curl -X GET "http://localhost:8000/api/pidms/search?page_size=200" \
  -H "Authorization: Bearer <admin_token>"
# Expected: 422 Validation Error (max 100)
```

### 7. Test Performance
```bash
# Insert 100 keys
# Measure search time
time curl -X GET "http://localhost:8000/api/pidms/search?product=Office&page=1&page_size=50" \
  -H "Authorization: Bearer <admin_token>"

# Verify: Response time < 2 seconds

# Measure sync time for 100 keys
time curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{}'

# Verify: Each batch (<50 keys) completes within 30 seconds
```

### 8. Data Accuracy Verification
```sql
-- Check database after /check
SELECT * FROM pidms_keys WHERE keyname = '6NRGDKHFCFY4TF7PRWFDYBF3H';

-- Verify:
-- - keyname matches (no dashes)
-- - keyname_with_dash has dashes
-- - prd, eid, remaining, blocked all match PIDKey.com response
-- - created_at and updated_at timestamps are correct
```

**Files Affected:**
- None (testing only)

## Dependencies
- [x] Task 007: All functionality must be implemented

## Effort Estimate
- Size: M
- Hours: 4-6 hours
- Parallel: true (can run independently)

## Definition of Done
- [x] All endpoints tested with real API
- [x] All test cases pass
- [x] Performance benchmarks met
- [x] Data accuracy verified in database
- [x] Authentication working correctly
- [x] Error handling verified
- [x] Test results documented
