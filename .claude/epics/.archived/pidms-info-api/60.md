---
name: Implement bulk sync functionality with batching
status: closed
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
completed: 2026-01-12T09:12:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/60
depends_on: [59]
parallel: true
conflicts_with: []
---

# Task: Implement bulk sync functionality with batching

## Description
Implement the full sync_all_keys service function and update the POST /sync endpoint. This function fetches all keys from the database, batches them into groups of 50, calls PIDKey.com API for each batch, and updates the database with current activation counts.

## Acceptance Criteria
- [ ] sync_all_keys() function implemented in `pidms_service.py`
- [ ] Batch processing: max 50 keys per API request
- [ ] Error isolation: continue processing even if individual batches fail
- [ ] Detailed error reporting for failed keys
- [ ] Optional product_filter parameter to sync subset of keys
- [ ] POST /sync endpoint updated to use new function
- [ ] Summary returned: total_synced, updated, errors

## Technical Details

**File:** `backend/app/services/pidms_service.py` (add function)

**Implementation:**
```python
async def sync_all_keys(
    db: AsyncSession,
    pidkey_client: PIDKeyClient,
    product_filter: Optional[str] = None
) -> dict:
    """
    Sync all keys in database with PIDKey.com

    Args:
        db: Database session
        pidkey_client: PIDKey API client
        product_filter: Optional filter to sync only specific product type

    Returns:
        {
            "success": bool,
            "summary": {"total_synced": int, "updated": int, "errors": int},
            "error_details": [{"keyname": str, "error": str}]
        }
    """
    try:
        # Step 1: Fetch all keys from database
        query = select(PIDMSKey)
        if product_filter:
            query = query.where(PIDMSKey.prd.ilike(f"%{product_filter}%"))

        result = await db.execute(query)
        all_keys = result.scalars().all()

        if not all_keys:
            return {
                "success": True,
                "summary": {"total_synced": 0, "updated": 0, "errors": 0},
                "error_details": []
            }

        total_synced = 0
        updated_count = 0
        error_count = 0
        error_details = []

        # Step 2: Batch keys into groups of 50
        batch_size = 50
        for i in range(0, len(all_keys), batch_size):
            batch = all_keys[i:i + batch_size]
            batch_keys = [key.keyname_with_dash for key in batch]

            try:
                # Step 3: Call PIDKey API for this batch
                logger.info(f"Syncing batch {i//batch_size + 1}: {len(batch_keys)} keys")
                result = await check_and_upsert_keys(db, batch_keys, pidkey_client)

                total_synced += result["summary"]["total_keys"]
                updated_count += result["summary"]["updated_keys"]
                error_count += result["summary"]["errors"]

            except Exception as e:
                logger.error(f"Batch sync failed for batch {i//batch_size + 1}: {e}")
                error_count += len(batch_keys)
                for key in batch_keys:
                    error_details.append({
                        "keyname": key,
                        "error": f"Batch sync failed: {str(e)}"
                    })

        return {
            "success": error_count < total_synced,  # Success if majority succeeded
            "summary": {
                "total_synced": total_synced,
                "updated": updated_count,
                "errors": error_count
            },
            "error_details": error_details
        }

    except Exception as e:
        logger.error(f"sync_all_keys failed: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"Sync failed: {str(e)}")
```

**File:** `backend/app/routers/pidms.py` (update endpoint)

**Update POST /sync endpoint:**
```python
@router.post("/sync", response_model=PIDMSSyncResponse, dependencies=[Depends(require_admin)])
async def sync_keys(
    request: PIDMSSyncRequest,
    db: AsyncSession = Depends(get_db),
    client: PIDKeyClient = Depends(get_pidkey_client)
):
    """
    Sync all keys in database with PIDKey.com

    - Fetches all keys from database (optionally filtered by product)
    - Processes in batches of 50 to avoid timeouts
    - Updates activation counts and blocked status
    - Returns detailed summary of sync operation
    """
    result = await pidms_service.sync_all_keys(db, client, request.product_filter)
    return result
```

**Testing:**
```bash
# Test sync all keys
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{}'

# Test sync with product filter
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"product_filter": "Office"}'
```

**Files Affected:**
- `backend/app/services/pidms_service.py` (update)
- `backend/app/routers/pidms.py` (update)

## Dependencies
- [x] Task 006: Router must be registered

## Effort Estimate
- Size: M
- Hours: 4-5 hours
- Parallel: true (can work independently after task 006)

## Definition of Done
- [x] sync_all_keys() implemented
- [x] Batch processing tested with >50 keys
- [x] Error isolation verified (one batch fails, others continue)
- [x] Product filter tested
- [x] POST /sync endpoint updated and tested
- [x] Performance tested with large dataset (simulate 200+ keys)
