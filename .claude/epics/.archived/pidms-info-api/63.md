---
name: Documentation and deployment preparation
status: closed
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
completed: 2026-01-12T09:12:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/63
depends_on: [62]
parallel: true
conflicts_with: []
---

# Task: Documentation and deployment preparation

## Description
Create comprehensive documentation for the PIDMS API including setup guide, API reference, admin user guide, and deployment checklist. Prepare the system for production deployment.

## Acceptance Criteria
- [ ] API documentation auto-generated in OpenAPI/Swagger
- [ ] README.md created with setup instructions
- [ ] Admin user guide with example curl commands
- [ ] Environment setup guide (.env configuration)
- [ ] Deployment checklist created
- [ ] Database migration instructions documented
- [ ] Troubleshooting guide for common issues
- [ ] Code comments and docstrings reviewed

## Technical Details

### 1. OpenAPI/Swagger Documentation

**Verify auto-generated docs:**
```python
# Ensure all endpoints have proper descriptions
@router.post(
    "/check",
    response_model=PIDMSCheckResponse,
    summary="Check and import product keys",
    description="""
    Validate product keys against PIDKey.com and import into database.

    - Accepts newline-separated list of keys (with or without dashes)
    - Calls PIDKey.com API to validate keys
    - Inserts new keys or updates existing ones
    - Returns summary with new/updated counts

    **Example Request:**
    ```json
    {
        "keys": "6NRGD-KHFCF-Y4TF7-PRWFD-YBF3H\\r\\n8NFMQ-FTF43-RQCKR-T473J-JFHB2"
    }
    ```
    """,
    responses={
        200: {"description": "Keys successfully checked and imported"},
        401: {"description": "Unauthorized - admin access required"},
        422: {"description": "Validation error - invalid request format"},
        502: {"description": "PIDKey.com API error"},
        503: {"description": "Rate limited by PIDKey.com API"}
    },
    dependencies=[Depends(require_admin)]
)
```

**Access docs at:** `http://localhost:8000/docs`

### 2. README.md

**Create:** `.claude/epics/pidms-info-api/README.md`

```markdown
# PIDMS Info API

API for managing Microsoft product license keys via PIDKey.com integration.

## Features

- ✅ Check and import product keys from PIDKey.com
- ✅ Search keys with fuzzy product matching
- ✅ View product inventory statistics
- ✅ Bulk sync all keys with PIDKey.com
- ✅ Admin-only authentication

## Setup

### 1. Environment Configuration

Create `.env` file:
```bash
PIDKEY_API_KEY=your_api_key_here
PIDKEY_BASE_URL=https://pidkey.com/ajax/pidms_api
```

### 2. Database Migration

```bash
# Run migration
alembic upgrade head

# Verify table created
psql -d fhs_prosight -c "\d pidms_keys"
```

### 3. Start Server

```bash
cd backend
uvicorn app.main:app --reload
```

### 4. Access API Documentation

Open: http://localhost:8000/docs

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/pidms/check | Check and import keys |
| GET | /api/pidms/search | Search keys with filters |
| GET | /api/pidms/products | View product statistics |
| POST | /api/pidms/sync | Sync all keys with PIDKey.com |

## Usage Examples

See `USAGE.md` for detailed examples.

## Troubleshooting

See `TROUBLESHOOTING.md` for common issues.
```

### 3. Admin User Guide

**Create:** `.claude/epics/pidms-info-api/USAGE.md`

```markdown
# PIDMS API Usage Guide

## Authentication

All endpoints require admin authentication:
```bash
# Login to get admin token
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your_password"}'

# Use token in subsequent requests
export ADMIN_TOKEN="eyJ..."
```

## 1. Import Product Keys

```bash
curl -X POST http://localhost:8000/api/pidms/check \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "keys": "6NRGD-KHFCF-Y4TF7-PRWFD-YBF3H\r\n8NFMQ-FTF43-RQCKR-T473J-JFHB2"
  }'
```

**Response:**
```json
{
  "success": true,
  "summary": {
    "total_keys": 2,
    "new_keys": 2,
    "updated_keys": 0,
    "errors": 0
  },
  "results": [...]
}
```

## 2. Search for Office Keys

```bash
curl -X GET "http://localhost:8000/api/pidms/search?product=Office&min_remaining=100&page=1&page_size=20" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

## 3. View Product Inventory

```bash
curl -X GET "http://localhost:8000/api/pidms/products" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

## 4. Sync All Keys

```bash
# Sync all keys
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{}'

# Sync only Office products
curl -X POST http://localhost:8000/api/pidms/sync \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"product_filter": "Office"}'
```
```

### 4. Troubleshooting Guide

**Create:** `.claude/epics/pidms-info-api/TROUBLESHOOTING.md`

```markdown
# PIDMS API Troubleshooting

## Common Issues

### 1. "Invalid PIDKey.com API key"

**Cause:** PIDKEY_API_KEY environment variable not set or incorrect

**Solution:**
```bash
# Check .env file
cat .env | grep PIDKEY_API_KEY

# Verify value matches your PIDKey.com account
# Restart server after updating .env
```

### 2. "PIDKey.com API timeout"

**Cause:** Network issues or PIDKey.com service down

**Solution:**
- Check internet connectivity
- Verify PIDKey.com is accessible: `curl https://pidkey.com`
- Retry request (automatic retry logic in place)

### 3. "Rate limited by PIDKey.com"

**Cause:** Too many requests to PIDKey.com API

**Solution:**
- Wait for retry-after period (shown in error message)
- Reduce batch size in sync operations
- Contact PIDKey.com to increase rate limits

### 4. "Search query slow (>2s)"

**Cause:** Missing indexes or large dataset

**Solution:**
```sql
-- Verify indexes exist
\d pidms_keys

-- Should see:
-- idx_pidms_keys_prd
-- idx_pidms_keys_remaining
-- idx_pidms_keys_blocked

-- Analyze table statistics
ANALYZE pidms_keys;
```

### 5. "401 Unauthorized"

**Cause:** Missing or invalid admin token

**Solution:**
- Login to get fresh admin token
- Verify user has admin role
- Check token expiration

## Logs

View detailed logs:
```bash
# Application logs
tail -f logs/fhs-prosight.log

# Filter PIDMS logs
tail -f logs/fhs-prosight.log | grep "pidms"
```
```

### 5. Deployment Checklist

**Create:** `.claude/epics/pidms-info-api/DEPLOYMENT.md`

```markdown
# PIDMS API Deployment Checklist

## Pre-Deployment

- [ ] All 10 tasks completed and tested
- [ ] Database migration script tested (upgrade and downgrade)
- [ ] Environment variables documented
- [ ] API documentation reviewed
- [ ] Performance benchmarks met (search <2s, sync batch <30s)

## Environment Setup

- [ ] Set PIDKEY_API_KEY in production .env
- [ ] Set PIDKEY_BASE_URL in production .env
- [ ] Verify PostgreSQL database accessible
- [ ] Verify admin authentication system working

## Database Migration

```bash
# Backup database first
pg_dump fhs_prosight > backup_before_pidms.sql

# Run migration
alembic upgrade head

# Verify table
psql -d fhs_prosight -c "SELECT COUNT(*) FROM pidms_keys;"
```

## Post-Deployment Testing

- [ ] Test POST /api/pidms/check with real keys
- [ ] Test GET /api/pidms/search
- [ ] Test GET /api/pidms/products
- [ ] Test POST /api/pidms/sync
- [ ] Verify admin authentication (401 for non-admin)
- [ ] Check logs for errors

## Rollback Plan

If deployment fails:
```bash
# Rollback database migration
alembic downgrade -1

# Remove PIDMS router from main.py
# Restart application
```

## Monitoring

- [ ] Set up alerts for PIDKey.com API errors
- [ ] Monitor search query performance
- [ ] Track sync operation success rate
- [ ] Monitor database size growth
```

**Files Affected:**
- `.claude/epics/pidms-info-api/README.md` (new)
- `.claude/epics/pidms-info-api/USAGE.md` (new)
- `.claude/epics/pidms-info-api/TROUBLESHOOTING.md` (new)
- `.claude/epics/pidms-info-api/DEPLOYMENT.md` (new)
- `backend/app/routers/pidms.py` (update docstrings for OpenAPI)

## Dependencies
- [x] Task 009: All optimization and error handling complete

## Effort Estimate
- Size: S
- Hours: 3-4 hours
- Parallel: true (can work independently)

## Definition of Done
- [x] All documentation files created
- [x] OpenAPI docs verified
- [x] Setup instructions tested by fresh user
- [x] Deployment checklist reviewed
- [x] Troubleshooting guide covers common issues
- [x] Code comments and docstrings complete
