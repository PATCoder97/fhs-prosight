---
name: Implement service layer for salary queries and trend analysis
status: completed
created: 2026-01-09T09:59:30Z
updated: 2026-01-09T14:15:00Z
completed: 2026-01-09T14:15:00Z
github: https://github.com/PATCoder97/fhs-prosight/issues/22
depends_on: [21]
parallel: false
conflicts_with: []
---

# Task: Implement service layer for salary queries and trend analysis

## Description

Create service layer to orchestrate salary data retrieval from HRS client, employee name lookup from database, and trend analysis for multi-month queries. Implement 3 main service methods: single month query, multi-month history with trend, and helper for trend calculation. Use parallel API calls for performance.

**Key Deliverable:** `backend/app/services/hrs_data_service.py` with complete business logic

## Acceptance Criteria

- [x] File `backend/app/services/hrs_data_service.py` created
- [x] `get_employee_salary(db, emp_id, year, month)` method implemented
- [x] `get_salary_history(db, emp_id, year, from_month, to_month)` method implemented
- [x] `calculate_trend(monthly_data)` helper function implemented
- [x] Employee name lookup from database (fallback to "Unknown")
- [x] Parallel API calls using `asyncio.gather()` for multi-month queries
- [x] Trend analysis: average income/deductions/net, highest/lowest months
- [x] Significant changes detection: >10% or >500K VND month-over-month
- [x] Error handling: HRS API failures, employee not found, invalid period
- [x] Logging: API calls, errors, trend insights
- [x] Returns Pydantic schema-compatible dictionaries

## Technical Details

### Method 1: get_employee_salary()

**Purpose:** Fetch single month salary with employee info

```python
async def get_employee_salary(
    db: AsyncSession,
    emp_id: str,
    year: int,
    month: int
) -> dict:
    """
    Get employee salary for specific month.

    Args:
        db: Database session
        emp_id: Employee ID (e.g., "VNW0006204")
        year: Year (e.g., 2024)
        month: Month (1-12)

    Returns:
        dict matching SalaryResponse schema:
        {
            "employee_id": str,
            "employee_name": str,
            "period": {"year": int, "month": int},
            "summary": {...},
            "income": {...},
            "deductions": {...}
        }

    Raises:
        HTTPException(404): Salary not found or HRS API error
        HTTPException(503): HRS API unavailable
    """
    # Convert emp_id format: VNW0006204 → 6204
    try:
        emp_num = int(emp_id.replace("VNW00", ""))
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid employee ID format: {emp_id}"
        )

    # Query HRS API
    logger.info(f"Fetching salary for {emp_id} ({year}-{month:02d})")
    hrs_client = FHSHRSClient()
    salary_data = await hrs_client.get_salary_data(emp_num, year, month)

    if not salary_data:
        raise HTTPException(
            status_code=404,
            detail=f"Salary not found for employee {emp_id} in {year}-{month:02d}"
        )

    # Lookup employee name from database
    employee = await db.get(Employee, emp_id)
    emp_name = employee.name_en if employee else "Unknown"

    if not employee:
        logger.warning(f"Employee {emp_id} not found in database, using 'Unknown'")

    # Return structured response
    return {
        "employee_id": emp_id,
        "employee_name": emp_name,
        "period": {"year": year, "month": month},
        **salary_data  # Includes: summary, income, deductions
    }
```

### Method 2: get_salary_history()

**Purpose:** Fetch multi-month salary with trend analysis

```python
async def get_salary_history(
    db: AsyncSession,
    emp_id: str,
    year: int,
    from_month: int,
    to_month: int
) -> dict:
    """
    Get employee salary history with trend analysis.

    Args:
        db: Database session
        emp_id: Employee ID (e.g., "VNW0006204")
        year: Year (e.g., 2024)
        from_month: Start month (1-12)
        to_month: End month (1-12)

    Returns:
        dict matching SalaryHistoryResponse schema:
        {
            "employee_id": str,
            "employee_name": str,
            "period": {"year": int, "month": f"{from_month}-{to_month}"},
            "months": [MonthlySalary],
            "trend": SalaryTrend
        }

    Raises:
        HTTPException(422): Invalid month range
        HTTPException(404): No salary data found for any month
    """
    # Validate month range
    if from_month > to_month:
        raise HTTPException(
            status_code=422,
            detail=f"Invalid month range: from_month ({from_month}) > to_month ({to_month})"
        )

    if not (1 <= from_month <= 12 and 1 <= to_month <= 12):
        raise HTTPException(
            status_code=422,
            detail=f"Month must be between 1-12: from_month={from_month}, to_month={to_month}"
        )

    # Lookup employee name (once, not per month)
    employee = await db.get(Employee, emp_id)
    emp_name = employee.name_en if employee else "Unknown"

    # Fetch salary for all months in parallel
    logger.info(
        f"Fetching salary history for {emp_id} "
        f"({year}-{from_month:02d} to {year}-{to_month:02d})"
    )

    month_range = range(from_month, to_month + 1)
    emp_num = int(emp_id.replace("VNW00", ""))
    hrs_client = FHSHRSClient()

    # Parallel API calls using asyncio.gather()
    tasks = [
        hrs_client.get_salary_data(emp_num, year, month)
        for month in month_range
    ]
    results = await asyncio.gather(*tasks, return_exceptions=True)

    # Process results
    monthly_data = []
    for month, result in zip(month_range, results):
        if isinstance(result, Exception):
            logger.error(f"Error fetching salary for {emp_id} {year}-{month:02d}: {result}")
            continue

        if result is None:
            logger.warning(f"No salary data for {emp_id} {year}-{month:02d}")
            continue

        monthly_data.append({
            "month": month,
            "summary": result["summary"],
            "income": result["income"],
            "deductions": result["deductions"]
        })

    # Require at least one successful month
    if not monthly_data:
        raise HTTPException(
            status_code=404,
            detail=f"No salary data found for employee {emp_id} in {year}"
        )

    # Calculate trend analysis
    trend = calculate_trend(monthly_data)

    logger.info(
        f"Fetched {len(monthly_data)} months for {emp_id}. "
        f"Average net: {trend['average_net']:,.0f} VND"
    )

    return {
        "employee_id": emp_id,
        "employee_name": emp_name,
        "period": {"year": year, "month": f"{from_month}-{to_month}"},
        "months": monthly_data,
        "trend": trend
    }
```

### Method 3: calculate_trend()

**Purpose:** Analyze salary trends from monthly data

```python
def calculate_trend(monthly_data: List[dict]) -> dict:
    """
    Calculate salary trend analysis from monthly data.

    Args:
        monthly_data: List of {month, summary, income, deductions}

    Returns:
        dict matching SalaryTrend schema:
        {
            "average_income": float,
            "average_deductions": float,
            "average_net": float,
            "highest_month": MonthlySalary,
            "lowest_month": MonthlySalary,
            "significant_changes": [SalaryChange]
        }
    """
    if not monthly_data:
        return None

    # Calculate averages
    total_income = sum(m["summary"]["tong_tien_cong"] for m in monthly_data)
    total_deductions = sum(m["summary"]["tong_tien_tru"] for m in monthly_data)
    total_net = sum(m["summary"]["thuc_linh"] for m in monthly_data)
    count = len(monthly_data)

    avg_income = total_income / count
    avg_deductions = total_deductions / count
    avg_net = total_net / count

    # Find highest and lowest net salary months
    sorted_by_net = sorted(
        monthly_data,
        key=lambda m: m["summary"]["thuc_linh"],
        reverse=True
    )
    highest_month = sorted_by_net[0]
    lowest_month = sorted_by_net[-1]

    # Detect significant month-over-month changes
    significant_changes = []
    sorted_by_month = sorted(monthly_data, key=lambda m: m["month"])

    for i in range(1, len(sorted_by_month)):
        prev = sorted_by_month[i - 1]
        curr = sorted_by_month[i]

        prev_net = prev["summary"]["thuc_linh"]
        curr_net = curr["summary"]["thuc_linh"]
        change = curr_net - prev_net
        percentage = (change / prev_net * 100) if prev_net != 0 else 0

        # Significant if: >10% change OR >500K VND change
        if abs(percentage) > 10 or abs(change) > 500000:
            significant_changes.append({
                "from_month": prev["month"],
                "to_month": curr["month"],
                "field": "thuc_linh",
                "change": change,
                "percentage": percentage,
                "direction": "increase" if change > 0 else "decrease"
            })

    return {
        "average_income": avg_income,
        "average_deductions": avg_deductions,
        "average_net": avg_net,
        "highest_month": highest_month,
        "lowest_month": lowest_month,
        "significant_changes": significant_changes
    }
```

### Imports and Dependencies

```python
import asyncio
from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import HTTPException

from app.models.employee import Employee
from app.integrations.fhs_hrs_client import FHSHRSClient
from app.core.logging import get_logger

logger = get_logger(__name__)
```

### Error Handling Strategy

1. **HRS API Down (503):**
   - Catch connection errors from hrs_client
   - Raise HTTPException(503, "HRS API unavailable")

2. **Salary Not Found (404):**
   - hrs_client returns None
   - Raise HTTPException(404, "Salary not found")

3. **Invalid Input (422):**
   - Invalid month range (from > to)
   - Month out of range (< 1 or > 12)
   - Raise HTTPException(422, detail message)

4. **Partial Failures (History):**
   - Some months succeed, some fail
   - Log errors, continue with successful months
   - Require at least 1 month successful

### Performance Optimization

**Sequential vs Parallel:**

```python
# Sequential (slow): 12 months × 2 seconds = 24 seconds
for month in range(1, 13):
    await hrs_client.get_salary_data(emp_id, year, month)

# Parallel (fast): max(2 seconds) ≈ 2-3 seconds
tasks = [hrs_client.get_salary_data(emp_id, year, month) for month in range(1, 13)]
results = await asyncio.gather(*tasks, return_exceptions=True)
```

**Impact:** 10x faster for 12-month queries

## Dependencies

- [x] Task 002: Enhanced HRS client (structured response)
- [x] Employee model from sync-employee-info epic
- [x] Database session (AsyncSession)
- [x] HTTPException for error handling

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
  - 2h: Implement `get_employee_salary()` method
  - 2h: Implement `get_salary_history()` method
  - 1h: Implement `calculate_trend()` function
  - 1h: Error handling and edge cases
  - 1h: Testing with real HRS API (single month)
  - 1h: Testing multi-month history and trend
- **Parallel:** false (depends on Task 002)

## Definition of Done

- [x] All 3 methods implemented in `backend/app/services/hrs_data_service.py`
- [x] Employee name lookup from database works
- [x] Parallel API calls implemented with `asyncio.gather()`
- [x] Trend calculation correct (averages, highest/lowest, changes)
- [x] Error handling for all failure cases
- [x] Logging for API calls and errors
- [ ] Tested with single month query (emp_id=6204) - Ready for testing
- [ ] Tested with multi-month history (12 months) - Ready for testing
- [ ] Verified parallel performance (12 months < 5 seconds) - Ready for testing
- [x] Code follows existing service patterns
- [x] Ready for use in API endpoints (Task 004)

## Testing Checklist

Manual testing:

```python
# Test single month
salary = await get_employee_salary(db, "VNW0006204", 2024, 12)
assert salary["employee_name"] == "PHAN ANH TUẤN"
assert salary["summary"]["thuc_linh"] > 0

# Test multi-month history
history = await get_salary_history(db, "VNW0006204", 2024, 1, 12)
assert len(history["months"]) == 12
assert history["trend"]["average_net"] > 0
assert history["trend"]["highest_month"]["month"] in range(1, 13)

# Test trend calculation
monthly_data = [
    {"month": 1, "summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000}, ...},
    {"month": 2, "summary": {"tong_tien_cong": 20000000, "tong_tien_tru": 4000000, "thuc_linh": 16000000}, ...},
]
trend = calculate_trend(monthly_data)
assert trend["average_net"] == 14000000
assert len(trend["significant_changes"]) > 0  # 33% increase detected
```

## Related Files

**Create:**
- `backend/app/services/hrs_data_service.py`

**Reference:**
- `backend/app/integrations/fhs_hrs_client.py` (Task 002 output)
- `backend/app/models/employee.py` (existing)
- `backend/app/schemas/hrs_data.py` (Task 001 output)

**Pattern Reference:**
- `backend/app/services/employee_service.py` (similar pattern)
