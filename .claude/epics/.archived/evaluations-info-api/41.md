---
name: Create upload endpoint with admin authorization
status: completed
created: 2026-01-10T09:10:21Z
updated: 2026-01-10T09:48:44Z
github: https://github.com/PATCoder97/fhs-prosight/issues/41
depends_on: [38, 39, 40]
parallel: false
conflicts_with: []
---

# Task: Create Upload Endpoint with Admin Authorization

## Description

Create the POST /api/evaluations/upload endpoint that accepts Excel file uploads via multipart/form-data. Enforce admin-only authorization, handle file validation, save to temp location, call upload service, and clean up temp file. Return upload summary with created/updated counts and error details.

## Acceptance Criteria

- [ ] Router file created at `backend/app/routers/evaluations.py`
- [ ] POST /upload endpoint implemented
- [ ] Admin-only authorization enforced with `require_admin` dependency
- [ ] File upload handling with FastAPI's `UploadFile`
- [ ] File extension validation (.xlsx, .xls)
- [ ] File size validation (max 10MB)
- [ ] Temp file creation, processing, and cleanup (try/finally)
- [ ] Service layer call to `upload_evaluations_from_excel()`
- [ ] Response model: `UploadSummary`
- [ ] Error handling: 400 (invalid file), 403 (not admin), 413 (file too large), 500 (processing error)
- [ ] OpenAPI documentation with examples

## Technical Details

**Router Endpoint** (`backend/app/routers/evaluations.py`):

```python
@router.post(
    "/upload",
    response_model=UploadSummary,
    summary="Upload evaluation Excel file",
    description="Upload Excel file to import/update employee evaluations (admin only)"
)
async def upload_evaluations(
    file: UploadFile = File(..., description="Excel file (.xlsx or .xls)"),
    current_user: dict = Depends(require_admin),
    db: AsyncSession = Depends(get_db)
):
    """
    Upload evaluation data from Excel file.

    **Access:** Admin only
    **Response:** 200: Upload summary with created/updated counts
                 400: Invalid file format or missing columns
                 403: Forbidden (not admin)
                 413: File too large (>10MB)
                 500: Processing error
    """
```

**Processing Flow**:
1. Validate file extension (must be .xlsx or .xls)
2. Validate file size (max 10MB)
3. Create temp file: `tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx')`
4. Write uploaded content to temp file
5. Call service: `result = await evaluation_service.upload_evaluations_from_excel(db, temp_path)`
6. Clean up temp file in finally block: `os.unlink(temp_path)`
7. Return `UploadSummary` response

**File Validation**:
- Check `file.filename.endswith(('.xlsx', '.xls'))`
- Check `file.size <= 10 * 1024 * 1024` (10MB)

**Authorization**:
- Use `require_admin` dependency (existing from other APIs)
- Returns 403 if user is not admin

**Error Handling**:
- 400: Invalid file format, missing required columns
- 403: Not admin (from dependency)
- 413: File too large
- 500: Unexpected processing error (catch all exceptions, log, return generic error)

## Dependencies

- [ ] Task 003 completed (upload service exists)
- [ ] `require_admin` dependency available (existing)
- [ ] FastAPI's `UploadFile` and `File` (existing)
- [ ] `tempfile` and `os` modules (Python standard library)

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: false (depends on Task 003)

## Definition of Done

- [ ] POST /upload endpoint created
- [ ] Admin authorization enforced (non-admin gets 403)
- [ ] File validation works (rejects .txt, .pdf, etc.)
- [ ] File size limit enforced (>10MB rejected with 413)
- [ ] Temp file cleanup happens even on errors (finally block)
- [ ] Upload summary returned with accurate counts
- [ ] Error responses clear and actionable
- [ ] OpenAPI docs show endpoint with examples
- [ ] Tested with sample Excel file (manual test)
- [ ] Committed with message: "Issue #XX: Add upload endpoint with admin authorization"
