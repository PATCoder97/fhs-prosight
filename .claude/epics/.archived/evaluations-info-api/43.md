---
name: Create search endpoint with authenticated user authorization
status: completed
created: 2026-01-10T09:10:21Z
updated: 2026-01-12T00:20:52Z
github: https://github.com/PATCoder97/fhs-prosight/issues/43
depends_on: [39, 42]
parallel: false
conflicts_with: [41]
---

# Task: Create Search Endpoint with Authenticated User Authorization

## Description

Create the GET /api/evaluations/search endpoint that accepts filter query parameters and returns paginated evaluation results. Enforce authenticated user authorization (block guests), validate query parameters, and call search service.

## Acceptance Criteria

- [ ] GET /search endpoint added to `backend/app/routers/evaluations.py`
- [ ] Authenticated user authorization enforced with `require_authenticated_user` dependency
- [ ] Query parameters: employee_id, term_code, dept_code, page, page_size (all optional)
- [ ] Query parameter validation (page >= 1, page_size <= 100)
- [ ] Service layer call to `search_evaluations()`
- [ ] Response model: `SearchResponse`
- [ ] Error handling: 403 (guest user), 422 (invalid params)
- [ ] OpenAPI documentation with examples

## Technical Details

**Router Endpoint** (`backend/app/routers/evaluations.py`):

```python
@router.get(
    "/search",
    response_model=SearchResponse,
    summary="Search evaluation records",
    description="Search employee evaluations with filters and pagination"
)
async def search_evaluations_endpoint(
    employee_id: Optional[str] = Query(None, description="Filter by employee ID (exact match)"),
    term_code: Optional[str] = Query(None, description="Filter by term code (exact match, e.g., '25B')"),
    dept_code: Optional[str] = Query(None, description="Filter by department code (prefix match, e.g., '78')"),
    page: int = Query(1, ge=1, description="Page number (1-indexed)"),
    page_size: int = Query(50, ge=1, le=100, description="Items per page (max 100)"),
    current_user: dict = Depends(require_authenticated_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Search evaluation records with filters.

    **Access:** Authenticated users only (blocks guest)
    **Response:** 200: Paginated search results
                 403: Forbidden (guest user)
                 422: Invalid query parameters
    """
```

**Query Parameter Validation**:
- `page`: Must be >= 1 (FastAPI Query validation)
- `page_size`: Must be >= 1 and <= 100 (FastAPI Query validation)
- All filters are optional (default to None)

**Authorization**:
- Use `require_authenticated_user` dependency (existing)
- Blocks guest users with 403 response
- Allows all authenticated users (regular users + admin)

**Processing Flow**:
1. Validate query params (FastAPI handles via Query constraints)
2. Log search request with user ID and filters
3. Call service: `result = await evaluation_service.search_evaluations(db, employee_id, term_code, dept_code, page, page_size)`
4. Return SearchResponse

**Error Handling**:
- 403: Guest user (from dependency)
- 422: Invalid query parameters (page < 1, page_size > 100) - handled by FastAPI
- 500: Unexpected error (catch all, log, return generic error)

## Dependencies

- [ ] Task 002 completed (SearchResponse schema exists)
- [ ] Task 005 completed (search service exists)
- [ ] `require_authenticated_user` dependency available (existing)

## Effort Estimate

- Size: S
- Hours: 1
- Parallel: false (depends on Task 005)

## Definition of Done

- [ ] GET /search endpoint created
- [ ] Authenticated user authorization enforced (guest gets 403)
- [ ] All query parameters work correctly
- [ ] Page validation works (page < 1 rejected with 422)
- [ ] Page size validation works (page_size > 100 rejected with 422)
- [ ] Filters passed correctly to service layer
- [ ] Paginated response returned with correct structure
- [ ] OpenAPI docs show endpoint with parameter descriptions
- [ ] Tested with various filter combinations (manual test)
- [ ] Committed with message: "Issue #XX: Add search endpoint with authenticated user authorization"
