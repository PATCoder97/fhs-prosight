---
name: Implement search service with filters and pagination
status: completed
created: 2026-01-12T03:16:26Z
updated: 2026-01-12T04:43:21Z
github: https://github.com/PATCoder97/fhs-prosight/issues/49
depends_on: [46, 47]
parallel: true
conflicts_with: [48]
---

# Task: Implement Search Service with Filters and Pagination

## Description

Implement the service layer method for searching dormitory bills with filters (employee_id, term_code, dorm_code, amount range) and pagination. Returns flat bill objects sorted by term_code DESC, created_at DESC.

## Acceptance Criteria

- [ ] Service method `search_bills()` implemented in `backend/app/services/dormitory_bill_service.py`
- [ ] Query building with optional filters (all exact match)
- [ ] Amount range filter (min_amount, max_amount)
- [ ] Pagination validation (page >= 1, page_size 1-100)
- [ ] Total count query before pagination
- [ ] Default sort: term_code DESC, created_at DESC
- [ ] LIMIT/OFFSET pagination
- [ ] Return dict matching SearchResponse schema
- [ ] Error handling for invalid pagination parameters

## Technical Details

**Add to Service File:** `backend/app/services/dormitory_bill_service.py`

```python
async def search_bills(
    db: AsyncSession,
    employee_id: Optional[str] = None,
    term_code: Optional[str] = None,
    dorm_code: Optional[str] = None,
    min_amount: Optional[float] = None,
    max_amount: Optional[float] = None,
    page: int = 1,
    page_size: int = 50
) -> dict:
    """
    Search dormitory bills with filters and pagination.

    Args:
        db: Database session
        employee_id: Exact match filter (e.g., 'VNW0012345')
        term_code: Exact match filter (e.g., '25A')
        dorm_code: Exact match filter (e.g., 'A01')
        min_amount: Minimum total_amount filter
        max_amount: Maximum total_amount filter
        page: Page number (1-indexed)
        page_size: Items per page (1-100)

    Returns:
        {
            "total": int,
            "page": int,
            "page_size": int,
            "results": List[DormitoryBillResponse]
        }
    """
    # Validate pagination
    if page < 1:
        raise HTTPException(status_code=422, detail="Page number must be >= 1")
    if page_size < 1 or page_size > 100:
        raise HTTPException(status_code=422, detail="Page size must be between 1 and 100")

    logger.info(f"Searching bills: employee_id={employee_id}, term_code={term_code}, dorm_code={dorm_code}, min_amount={min_amount}, max_amount={max_amount}, page={page}, page_size={page_size}")

    # Build query with filters
    query = select(DormitoryBill)

    if employee_id:
        query = query.where(DormitoryBill.employee_id == employee_id)
    if term_code:
        query = query.where(DormitoryBill.term_code == term_code)
    if dorm_code:
        query = query.where(DormitoryBill.dorm_code == dorm_code)
    if min_amount is not None:
        query = query.where(DormitoryBill.total_amount >= min_amount)
    if max_amount is not None:
        query = query.where(DormitoryBill.total_amount <= max_amount)

    # Count total (before pagination)
    count_query = select(func.count()).select_from(query.subquery())
    total = (await db.execute(count_query)).scalar()

    # Apply sort (term_code DESC, created_at DESC)
    query = query.order_by(DormitoryBill.term_code.desc(), DormitoryBill.created_at.desc())

    # Apply pagination
    offset = (page - 1) * page_size
    query = query.offset(offset).limit(page_size)

    # Execute query
    result = await db.execute(query)
    bills = result.scalars().all()

    logger.info(f"Search complete: found {total} total, returning {len(bills)} results")

    return {
        "total": total,
        "page": page,
        "page_size": page_size,
        "results": bills
    }
```

**Import Dependencies:**
```python
from typing import Optional
from sqlalchemy import func
```

## Dependencies

- [ ] Task 46 completed (DormitoryBill model exists)
- [ ] Task 47 completed (SearchResponse schema exists)
- [ ] SQLAlchemy AsyncSession available

## Effort Estimate

- Size: S
- Hours: 1.5
- Parallel: true (can be implemented alongside Task 48)

## Definition of Done

- [ ] Service method implemented with all filters
- [ ] Employee ID filter works (exact match)
- [ ] Term code filter works (exact match)
- [ ] Dorm code filter works (exact match)
- [ ] Amount range filter works (min_amount, max_amount)
- [ ] Pagination works correctly (accurate total count)
- [ ] Default sort works (term_code DESC, created_at DESC)
- [ ] Pagination validation works (rejects page < 1, page_size > 100)
- [ ] Committed with message: "Issue #XX: Implement search service with filters and pagination"
