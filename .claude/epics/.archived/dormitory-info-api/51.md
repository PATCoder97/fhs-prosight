---
name: Create search endpoint with authenticated user authorization
status: open
created: 2026-01-12T03:16:26Z
updated: 2026-01-12T03:25:14Z
github: https://github.com/PATCoder97/fhs-prosight/issues/51
depends_on: [47, 49]
parallel: false
conflicts_with: []
---

# Task: Create Search Endpoint with Authenticated User Authorization

## Description

Create the GET /api/dormitory-bills/search endpoint that accepts query parameters for filtering and returns paginated results. Enforce authenticated user authorization and wire up to the search service.

## Acceptance Criteria

- [ ] GET /search endpoint added to `backend/app/routers/dormitory_bills.py`
- [ ] Authenticated user authorization enforced with `require_authenticated_user` dependency
- [ ] Query parameters: employee_id, term_code, dorm_code, min_amount, max_amount, page, page_size (all optional except page/page_size)
- [ ] Query parameter validation (page >= 1, page_size <= 100)
- [ ] Service layer call to `search_bills()`
- [ ] Response model: SearchResponse
- [ ] Error handling: 403 (guest user), 422 (invalid params), 500 (server error)
- [ ] OpenAPI documentation with examples

## Technical Details

**Add to Router File:** `backend/app/routers/dormitory_bills.py`

```python
from typing import Optional
from fastapi import Query


@router.get(
    "/search",
    response_model=SearchResponse,
    summary="Search dormitory bills",
    description="Search dormitory billing records with filters and pagination (authenticated users)"
)
async def search_dormitory_bills(
    employee_id: Optional[str] = Query(None, description="Filter by employee ID (exact match, e.g., 'VNW0012345')"),
    term_code: Optional[str] = Query(None, description="Filter by term code (exact match, e.g., '25A')"),
    dorm_code: Optional[str] = Query(None, description="Filter by room code (exact match, e.g., 'A01')"),
    min_amount: Optional[float] = Query(None, ge=0, description="Minimum total amount filter (VND)"),
    max_amount: Optional[float] = Query(None, ge=0, description="Maximum total amount filter (VND)"),
    page: int = Query(1, ge=1, description="Page number (1-indexed, default: 1)"),
    page_size: int = Query(50, ge=1, le=100, description="Items per page (default: 50, max: 100)"),
    current_user: dict = Depends(require_authenticated_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Search dormitory bills with flexible filters.

    **Access:** Authenticated users only (blocks guest users)

    **Query Parameters:**
    - employee_id: Exact match on employee ID (e.g., 'VNW0012345')
    - term_code: Exact match on billing term (e.g., '25A')
    - dorm_code: Exact match on room code (e.g., 'A01')
    - min_amount: Minimum total amount (VND)
    - max_amount: Maximum total amount (VND)
    - page: Page number starting from 1
    - page_size: Number of records per page (1-100)

    **Response:**
    - 200: Paginated search results
    - 403: Forbidden (guest user not allowed)
    - 422: Invalid query parameters (page < 1 or page_size > 100)
    - 500: Server error

    **Example Response:**
    ```json
    {
      "total": 250,
      "page": 1,
      "page_size": 50,
      "results": [
        {
          "bill_id": 1234,
          "employee_id": "VNW0012345",
          "term_code": "25A",
          "dorm_code": "A01",
          "factory_location": "North Wing",
          "elec_last_index": 1000.5,
          "elec_curr_index": 1250.3,
          "elec_usage": 249.8,
          "elec_amount": 1249000,
          "water_last_index": 500.2,
          "water_curr_index": 565.7,
          "water_usage": 65.5,
          "water_amount": 327500,
          "shared_fee": 100000,
          "management_fee": 200000,
          "total_amount": 1876500,
          "created_at": "2026-01-12T03:00:00Z",
          "updated_at": null
        }
      ]
    }
    ```
    """
    logger.info(f"User {current_user.get('localId')} searching bills: employee_id={employee_id}, term_code={term_code}, dorm_code={dorm_code}, min_amount={min_amount}, max_amount={max_amount}, page={page}, page_size={page_size}")

    try:
        # Call service layer
        result = await dormitory_bill_service.search_bills(
            db=db,
            employee_id=employee_id,
            term_code=term_code,
            dorm_code=dorm_code,
            min_amount=min_amount,
            max_amount=max_amount,
            page=page,
            page_size=page_size
        )

        logger.info(f"Search complete: returned {len(result['results'])} results (total: {result['total']})")
        return result

    except HTTPException:
        # Re-raise HTTP exceptions from service layer
        raise

    except Exception as e:
        logger.error(f"Unexpected error during search: {e}", exc_info=True)
        raise HTTPException(
            status_code=500,
            detail=f"Failed to search bills: {str(e)}"
        )
```

## Dependencies

- [ ] Task 47 completed (SearchResponse schema exists)
- [ ] Task 49 completed (Search service exists)
- [ ] `require_authenticated_user` dependency available

## Effort Estimate

- Size: S
- Hours: 1
- Parallel: false (depends on Tasks 47, 49)

## Definition of Done

- [ ] GET /search endpoint created
- [ ] Authenticated user authorization enforced (guest gets 403)
- [ ] All query parameters work correctly
- [ ] Page validation works (page < 1 rejected with 422)
- [ ] Page size validation works (page_size > 100 rejected with 422)
- [ ] Filters passed correctly to service layer
- [ ] Paginated response returned with correct structure
- [ ] OpenAPI docs show endpoint with parameter descriptions
- [ ] Tested with various filter combinations
- [ ] Committed with message: "Issue #XX: Add search endpoint with authenticated user authorization"
