---
name: Deploy migration + code lên staging, verify, deploy production
status: closed
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T13:30:00Z
completed: 2026-01-08T13:30:00Z
github: https://github.com/PATCoder97/fhs-prosight/issues/9
depends_on: [8]
parallel: false
conflicts_with: []
---

# Task: Deploy migration + code lên staging, verify, deploy production

## Description

Deploy tất cả changes lên staging, verify functionality, sau đó deploy production:
1. Backup databases (staging + production)
2. Run Alembic migration trên staging
3. Deploy updated backend code lên staging
4. Run E2E tests trên staging
5. Monitor logs và metrics
6. Deploy lên production (migration + code)
7. Post-deployment verification
8. Monitor production metrics

Đảm bảo zero-downtime deployment và có rollback plan sẵn sàng.

## Acceptance Criteria

### Staging Deployment
- [ ] Staging database backed up
- [ ] Migration chạy thành công trên staging
- [ ] Code deployed lên staging
- [ ] E2E tests pass trên staging
- [ ] No errors trong staging logs
- [ ] Performance metrics đạt yêu cầu

### Production Deployment
- [ ] Production database backed up
- [ ] Rollback plan documented và tested
- [ ] Migration chạy thành công trên production
- [ ] Code deployed lên production (zero downtime)
- [ ] Smoke tests pass trên production
- [ ] Existing users vẫn login được
- [ ] New users có role='guest'
- [ ] Login success rate > 95%

### Post-Deployment
- [ ] Monitor logs trong 24h đầu
- [ ] No critical errors
- [ ] Performance metrics stable
- [ ] Rollback plan ready (trong 2 tuần)

## Technical Details

### Phase 1: Staging Deployment

#### Step 1: Backup Staging Database

```bash
# PostgreSQL backup
pg_dump -h staging-db-host -U username -d database_name > backup_staging_$(date +%Y%m%d_%H%M%S).sql

# Verify backup
ls -lh backup_staging_*.sql
```

#### Step 2: Run Migration on Staging

```bash
# Connect to staging server
ssh staging-server

# Navigate to project
cd /path/to/project

# Activate virtual environment
source venv/bin/activate

# Run migration
alembic upgrade head

# Verify migration
alembic current

# Check schema
psql -h staging-db -U user -d dbname -c "\d users"
# Should show localId column
```

#### Step 3: Deploy Code to Staging

```bash
# Pull latest code
git pull origin main

# Install dependencies (nếu có thay đổi)
pip install -r requirements.txt

# Restart backend service
sudo systemctl restart backend-api

# Check service status
sudo systemctl status backend-api

# Check logs
tail -f /var/log/backend-api/app.log
```

#### Step 4: Run E2E Tests on Staging

```bash
# Run manual E2E tests theo test plan (Task 007)
# hoặc automated tests:
pytest tests/e2e/ --env=staging

# Checklist:
# - New user Google login → role='guest', localId=null
# - Admin assign localId → successful
# - User re-login → has localId
# - GitHub login → works
# - Admin endpoints → authorized properly
```

#### Step 5: Verify Staging Metrics

```bash
# Check API health
curl https://staging-api.example.com/health

# Check login success rate
# Monitor logs hoặc analytics dashboard

# Performance test
# Measure OAuth callback time, token validation time
```

### Phase 2: Production Deployment

#### Pre-Deployment Checklist

- [ ] All staging tests passed
- [ ] Code reviewed và approved
- [ ] Rollback plan documented
- [ ] Team notified về deployment window
- [ ] Monitoring dashboard ready

#### Step 1: Backup Production Database

```bash
# CRITICAL: Backup trước khi migration
pg_dump -h prod-db-host -U username -d database_name > backup_prod_$(date +%Y%m%d_%H%M%S).sql

# Upload to S3 for safe keeping
aws s3 cp backup_prod_*.sql s3://backups/database/

# Verify backup integrity
pg_restore --list backup_prod_*.sql
```

#### Step 2: Run Migration on Production

```bash
# Enable maintenance mode (optional, nếu cần)
# Hoặc deploy during low-traffic window

ssh production-server
cd /path/to/project
source venv/bin/activate

# Run migration
alembic upgrade head

# Verify
alembic current
psql -h prod-db -U user -d dbname -c "SELECT column_name FROM information_schema.columns WHERE table_name='users' AND column_name='localId';"
# Should return: localId
```

#### Step 3: Deploy Code to Production

```bash
# Zero-downtime deployment (example với systemd)
# Deploy new version
git pull origin main
pip install -r requirements.txt

# Restart with zero downtime
# Option 1: Rolling restart nếu có multiple instances
# Option 2: Blue-green deployment
# Option 3: systemd reload

sudo systemctl reload backend-api

# Check logs immediately
tail -f /var/log/backend-api/app.log | grep ERROR
```

#### Step 4: Smoke Tests on Production

```bash
# Critical flows test
# 1. Health check
curl https://api.example.com/health

# 2. Existing user login
# Use real account để test OAuth flow

# 3. Check database
psql -c "SELECT COUNT(*) FROM users WHERE localId IS NOT NULL;"
# Should be >= 0 (existing users have NULL)

psql -c "SELECT COUNT(*) FROM users WHERE role='guest';"
# Should be >= 0 (only new users after deployment)

# 4. Admin endpoint test
# Try to assign localId to a test user
```

### Phase 3: Post-Deployment Monitoring

#### Metrics to Monitor (First 24 Hours)

```yaml
Critical Metrics:
  - Login success rate: Should be > 95%
  - OAuth callback errors: Should be minimal
  - Token validation errors: Should not increase
  - API response time: Should be stable
  - Database query performance: Should be < 50ms

Error Monitoring:
  - 500 errors: Should be 0
  - 403 errors: Normal (non-admin accessing admin endpoints)
  - 401 errors: Normal (expired tokens)

User Impact:
  - Existing users can still login: YES
  - New users get role='guest': YES
  - Admin can assign localId: YES
```

#### Rollback Plan

**If critical issues found:**

```bash
# Step 1: Rollback code
git checkout <previous-commit-hash>
sudo systemctl restart backend-api

# Step 2: Rollback migration
alembic downgrade -1

# Step 3: Verify rollback
psql -c "\d users"  # Should not have localId column

# Step 4: Test existing functionality
# Run smoke tests

# Step 5: Restore database from backup (last resort)
psql -h prod-db -U user -d dbname < backup_prod_TIMESTAMP.sql
```

**Rollback Triggers:**
- Login success rate drops below 90%
- Critical errors spike
- Database performance degrades
- Data corruption detected

### Key Considerations

1. **Zero Downtime:**
   - Use rolling restart hoặc blue-green deployment
   - Migration không lock tables lâu (only ADD COLUMN)
   - Code backward compatible với old schema

2. **Backward Compatibility:**
   - Old JWT tokens (without localId) vẫn valid
   - Existing users giữ nguyên role
   - No breaking changes trong API response

3. **Communication:**
   - Notify team trước deployment
   - Status updates during deployment
   - Post-deployment summary

## Dependencies

- [x] Task 007 completed (all tests passing)
- [ ] Staging environment ready
- [ ] Production environment ready
- [ ] Database credentials
- [ ] Deployment permissions
- [ ] Monitoring tools setup

## Effort Estimate

- **Size:** L (Large)
- **Hours:** 6-8 hours
  - 1h: Staging deployment
  - 2h: Staging verification và testing
  - 1h: Production deployment prep
  - 2h: Production deployment
  - 2h: Post-deployment monitoring và fixes
- **Parallel:** false (phải sequential, depends on task 007)

## Definition of Done

- [ ] Staging deployed successfully
- [ ] Staging E2E tests pass
- [ ] Production database backed up
- [ ] Production migration successful
- [ ] Production code deployed
- [ ] Smoke tests pass on production
- [ ] No critical errors in logs
- [ ] Login success rate > 95%
- [ ] Performance metrics meet requirements
- [ ] Monitoring active
- [ ] Rollback plan documented
- [ ] Team notified về deployment success
- [ ] Post-deployment report written
