---
name: Update OAuth callback handlers (Google + GitHub)
status: closed
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T10:30:00Z
completed: 2026-01-08T10:30:00Z
github: https://github.com/PATCoder97/fhs-prosight/issues/5
depends_on: [3, 4]
parallel: false
conflicts_with: [3, 4]
---

# Task: Update OAuth callback handlers (Google + GitHub)

## Description

Cập nhật OAuth callback handlers để:
1. Truyền `localId` và `provider` vào `create_access_token()`
2. Update response schemas để include `localId`
3. Đảm bảo cả Google và GitHub callbacks return consistent format
4. Test full OAuth flow end-to-end

Files cần update:
- `backend/app/services/auth_service.py` - callback handlers
- `backend/app/schemas/auth.py` - response schemas

## Acceptance Criteria

- [ ] `handle_google_callback()` truyền `localId` và `provider='google'` vào `create_access_token()`
- [ ] `handle_github_callback()` truyền `localId` và `provider='github'` vào `create_access_token()`
- [ ] `SocialLoginUser` schema có field `localId: Optional[str]`
- [ ] Response từ `/auth/google/callback` chứa `user.localId`
- [ ] Response từ `/auth/github/callback` chứa `user.localId`
- [ ] JWT token có `oauth_provider` field
- [ ] Tested: new user login → role='guest', localId=None
- [ ] Tested: existing user login → nhận đúng localId từ DB

## Technical Details

### Files to Modify

**1. `backend/app/schemas/auth.py`**

Update `SocialLoginUser` schema:
```python
from pydantic import BaseModel
from typing import Optional

class SocialLoginUser(BaseModel):
    id: int
    social_id: str
    provider: str
    email: str
    full_name: Optional[str]
    avatar: Optional[str]
    role: str
    localId: Optional[str] = None  # NEW field
    is_active: bool
    is_verified: bool
    is_new_user: bool = False

class LoginResponse(BaseModel):
    access_token: str
    token_type: str
    user: SocialLoginUser
```

**2. `backend/app/services/auth_service.py`**

Update `handle_google_callback()`:
```python
async def handle_google_callback(request) -> LoginResponse:
    userinfo = await google_auth.get_user_info(request)

    social_id = userinfo.get("sub")
    email = userinfo.get("email")
    full_name = userinfo.get("name")
    avatar = userinfo.get("picture")

    # Get or create user in database
    user_data = await get_or_create_user(
        social_id=social_id,
        provider="google",
        email=email,
        full_name=full_name,
        avatar=avatar,
    )

    # Create access token with localId and provider
    access_token = create_access_token(
        user_id=str(user_data["id"]),
        full_name=user_data["full_name"],
        role=user_data["role"],
        localId=user_data.get("localId"),  # NEW: Pass localId
        provider="google",  # NEW: Pass provider
        scope="access",
    )

    # Format response
    user = SocialLoginUser(
        id=user_data["id"],
        social_id=user_data["social_id"],
        provider=user_data["provider"],
        email=user_data["email"],
        full_name=user_data["full_name"],
        avatar=user_data["avatar"],
        role=user_data["role"],
        localId=user_data.get("localId"),  # NEW: Include localId
        is_active=user_data["is_active"],
        is_verified=user_data["is_verified"],
        is_new_user=user_data["id"] == 0,
    )

    response = LoginResponse(
        access_token=access_token,
        token_type="bearer",
        user=user
    )

    return response
```

Update `handle_github_callback()` (tương tự):
```python
async def handle_github_callback(request) -> LoginResponse:
    userinfo = await github_auth.get_user_info(request)

    social_id = str(userinfo.get("id"))
    email = userinfo.get("email")
    full_name = userinfo.get("name")
    avatar = userinfo.get("avatar_url")

    # Get or create user in database
    user_data = await get_or_create_user(
        social_id=social_id,
        provider="github",
        email=email,
        full_name=full_name,
        avatar=avatar,
    )

    # Create access token with localId and provider
    access_token = create_access_token(
        user_id=str(user_data["id"]),
        full_name=user_data["full_name"],
        role=user_data["role"],
        localId=user_data.get("localId"),  # NEW: Pass localId
        provider="github",  # NEW: Pass provider
        scope="access",
    )

    user = SocialLoginUser(
        id=user_data["id"],
        social_id=user_data["social_id"],
        provider=user_data["provider"],
        email=user_data["email"],
        full_name=user_data["full_name"],
        avatar=user_data["avatar"],
        role=user_data["role"],
        localId=user_data.get("localId"),  # NEW: Include localId
        is_active=user_data["is_active"],
        is_verified=user_data["is_verified"],
        is_new_user=user_data["id"] == 0,
    )

    response = LoginResponse(
        access_token=access_token,
        token_type="bearer",
        user=user
    )

    return response
```

### Testing Strategy

**Test cases:**

1. **New user login via Google:**
   - Expected: role='guest', localId=None, provider='google' in token

2. **New user login via GitHub:**
   - Expected: role='guest', localId=None, provider='github' in token

3. **Existing user login (no localId assigned):**
   - Expected: role from DB, localId=None, correct provider in token

4. **Existing user login (with localId assigned):**
   - Admin đã assign localId='VNW0014732'
   - Expected: role from DB, localId='VNW0014732', correct provider

5. **JWT token verification:**
   - Decode token và check có fields: user_id, role, localId, oauth_provider

### Key Considerations

1. **Null Safety:**
   - Use `user_data.get("localId")` instead of `user_data["localId"]`
   - Pydantic schema có `Optional[str]` để handle None

2. **Consistency:**
   - Cả Google và GitHub callbacks phải return cùng format
   - Provider name: lowercase ("google", "github")

3. **Backward Compatibility:**
   - Response vẫn có tất cả fields cũ
   - Chỉ thêm `localId` mới

## Dependencies

- [x] Task 002 completed (auth service returns localId)
- [x] Task 003 completed (JWT handler accepts localId, provider)
- [ ] OAuth integrations working (Google, GitHub)
- [ ] Database có user records để test

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 3-4 hours
  - 1h: Update schemas
  - 1h: Update Google callback
  - 1h: Update GitHub callback
  - 1h: End-to-end testing với real OAuth flow
- **Parallel:** false (depends on 002 và 003, conflicts with them)

## Definition of Done

- [ ] Schemas updated với `localId` field
- [ ] Google callback passes localId và provider to JWT
- [ ] GitHub callback passes localId và provider to JWT
- [ ] Response JSON chứa `user.localId`
- [ ] JWT token có `oauth_provider` field
- [ ] Tested: new user → role='guest', localId=null
- [ ] Tested: existing user → correct role và localId từ DB
- [ ] Tested: decode JWT → có đầy đủ fields
- [ ] No breaking changes - existing clients vẫn hoạt động
- [ ] Code formatted, có type hints
- [ ] Ready for admin endpoints (Task 005)
