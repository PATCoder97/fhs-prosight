---
name: API endpoints - REST API router with 6 admin endpoints
status: completed
created: 2026-01-09T02:15:19Z
updated: 2026-01-09T04:59:18Z
github: https://github.com/PATCoder97/fhs-prosight/issues/15
depends_on: [14]
parallel: false
conflicts_with: []
---

# Task: API endpoints - REST API router with 6 admin endpoints

## Description

Create the employees router (`app/routers/employees.py`) with 6 REST API endpoints, all protected by admin authorization. Register router in main.py and ensure OpenAPI documentation is generated correctly.

**Endpoints:**
1. POST /api/employees/sync - Single employee sync
2. POST /api/employees/bulk-sync - Bulk sync (from_id to to_id)
3. GET /api/employees/search - Search with filters
4. GET /api/employees/{emp_id} - Get employee details
5. PUT /api/employees/{emp_id} - Update employee
6. DELETE /api/employees/{emp_id} - Delete employee

## Acceptance Criteria

- [ ] Router created: `app/routers/employees.py`
- [ ] All 6 endpoints implemented
- [ ] All endpoints require admin role: `Depends(require_role("admin"))`
- [ ] POST /sync accepts SyncEmployeeRequest, returns EmployeeResponse
- [ ] POST /bulk-sync accepts BulkSyncRequest, returns BulkSyncResponse
- [ ] GET /search accepts query params (name, dept_code, dorm_id, skip, limit), returns EmployeeListResponse
- [ ] GET /{emp_id} returns EmployeeResponse or 404
- [ ] PUT /{emp_id} accepts UpdateEmployeeRequest, returns EmployeeResponse
- [ ] DELETE /{emp_id} returns DeleteResponse
- [ ] Router registered in main.py: `app.include_router(employees.router, prefix="/api")`
- [ ] OpenAPI tags added for documentation grouping
- [ ] Error responses documented (401, 403, 404, 422, 500)

## Technical Details

```python
# app/routers/employees.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional

from app.core.security import require_role
from app.database.session import get_db
from app.services import employee_service
from app.schemas.employees import (
    SyncEmployeeRequest,
    BulkSyncRequest,
    EmployeeResponse,
    EmployeeListResponse,
    BulkSyncResponse,
    UpdateEmployeeRequest,
    DeleteResponse
)

router = APIRouter(prefix="/employees", tags=["employees"])


@router.post("/sync", response_model=EmployeeResponse)
async def sync_single_employee(
    request: SyncEmployeeRequest,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Sync single employee from HRS or COVID API"""
    if request.source == "hrs":
        employee = await employee_service.sync_employee_from_hrs(db, request.emp_id)
    elif request.source == "covid":
        if not request.token:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Token required for COVID source"
            )
        employee = await employee_service.sync_employee_from_covid(
            db, request.emp_id, request.token
        )
    else:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Invalid source"
        )

    return employee


@router.post("/bulk-sync", response_model=BulkSyncResponse)
async def bulk_sync_employees(
    request: BulkSyncRequest,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Bulk sync employees from HRS or COVID API"""
    result = await employee_service.bulk_sync_employees(
        db,
        request.from_id,
        request.to_id,
        request.source,
        request.token
    )
    return result


@router.get("/search", response_model=EmployeeListResponse)
async def search_employees(
    name: Optional[str] = None,
    department_code: Optional[str] = None,
    dorm_id: Optional[str] = None,
    skip: int = 0,
    limit: int = 100,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Search employees with filters"""
    employees = await employee_service.search_employees(
        db, name, department_code, dorm_id, skip, limit
    )

    # Get total count (for pagination)
    # (simplified: return len(employees), or add count query to service)
    return {
        "items": employees,
        "total": len(employees),
        "skip": skip,
        "limit": limit
    }


@router.get("/{emp_id}", response_model=EmployeeResponse)
async def get_employee(
    emp_id: str,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Get employee by ID"""
    employee = await employee_service.get_employee_by_id(db, emp_id)
    if not employee:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Employee {emp_id} not found"
        )
    return employee


@router.put("/{emp_id}", response_model=EmployeeResponse)
async def update_employee(
    emp_id: str,
    request: UpdateEmployeeRequest,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Update employee information"""
    update_data = request.dict(exclude_unset=True)
    employee = await employee_service.update_employee(db, emp_id, update_data)
    return employee


@router.delete("/{emp_id}", response_model=DeleteResponse)
async def delete_employee(
    emp_id: str,
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Delete employee"""
    deleted = await employee_service.delete_employee(db, emp_id)
    if deleted:
        return {"success": True, "message": f"Employee {emp_id} deleted"}
    else:
        return {"success": False, "message": f"Employee {emp_id} not found"}
```

Register in main.py:
```python
from app.routers import auth, users, employees

app.include_router(auth.router, prefix="/api")
app.include_router(users.router, prefix="/api")
app.include_router(employees.router, prefix="/api")  # NEW
```

## Dependencies

- [x] Task 14: Service layer methods
- [x] Schemas from Task 12
- [x] Admin authorization available (require_role)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 4-6 hours
  - 3h: Implement 6 endpoints
  - 1h: Register router and test routing
  - 1h: OpenAPI documentation
  - 1h: Test all endpoints with curl/Postman
- **Parallel:** false (depends on 14)

## Definition of Done

- [ ] All 6 endpoints implemented
- [ ] Router registered in main.py
- [ ] Admin authorization works (403 for non-admin)
- [ ] Validation works (422 for invalid input)
- [ ] Tested with curl/Postman:
  - POST /sync with HRS source (no token)
  - POST /sync with COVID source (with token)
  - POST /bulk-sync with range
  - GET /search with filters
  - GET /{emp_id} with valid ID
  - PUT /{emp_id} with update data
  - DELETE /{emp_id}
- [ ] OpenAPI docs available at /docs
- [ ] Swagger UI shows all endpoints under "employees" tag
