---
name: Unit tests - Clients, services, and utilities with mocks
status: open
created: 2026-01-09T02:15:19Z
updated: 2026-01-09T02:15:19Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002, 003]
parallel: true
conflicts_with: []
---

# Task: Unit tests - Clients, services, and utilities with mocks

## Description

Create comprehensive unit tests for integration clients, service layer, and utility functions using mocked dependencies. Tests should cover happy paths, error scenarios, and edge cases. Aim for >80% code coverage.

**Test Files:**
1. tests/test_fhs_hrs_client.py - HRS client tests
2. tests/test_fhs_covid_client.py - COVID client tests
3. tests/test_employee_service.py - Service layer tests
4. tests/test_text_utils.py - Text utility tests
5. tests/test_date_utils.py - Date parsing tests

## Acceptance Criteria

### Client Tests (Mocked HTTP)
- [ ] test_fhs_hrs_client.py created (8+ tests)
  - Test get_employee_info() success
  - Test get_employee_info() with 404
  - Test get_employee_info() with timeout
  - Test get_employee_info() with invalid format
  - Test bulk_get_employees() success
  - Test bulk_get_employees() with partial failures
  - Test UTF-8 encoding (Chinese names)
  - Test UTF-8 encoding (Vietnamese names)

- [ ] test_fhs_covid_client.py created (8+ tests)
  - Test get_user_info() success
  - Test get_user_info() with invalid token
  - Test get_user_info() with 404
  - Test get_user_info() with timeout
  - Test bulk_get_users() success
  - Test bulk_get_users() with partial failures
  - Test bearer token in headers
  - Test UTF-8 encoding

### Service Tests (Mocked DB)
- [ ] test_employee_service.py created (15+ tests)
  - Test sync_employee_from_hrs() - create new
  - Test sync_employee_from_hrs() - update existing
  - Test sync_employee_from_hrs() - API error raises HTTPException
  - Test sync_employee_from_covid() - create new
  - Test sync_employee_from_covid() - merge with existing
  - Test sync_employee_from_covid() - invalid token raises HTTPException
  - Test bulk_sync_employees() - HRS source
  - Test bulk_sync_employees() - COVID source
  - Test bulk_sync_employees() - partial failures continue
  - Test bulk_sync_employees() - summary counts correct
  - Test search_employees() - name filter (ILIKE)
  - Test search_employees() - department_code filter
  - Test search_employees() - pagination
  - Test get_employee_by_id() - found
  - Test get_employee_by_id() - not found
  - Test update_employee() - success
  - Test update_employee() - not found raises 404
  - Test delete_employee() - success
  - Test delete_employee() - not found returns False

### Utility Tests
- [ ] test_text_utils.py created (6+ tests)
  - Test chuan_hoa_ten() with Vietnamese names
  - Test chuan_hoa_ten() with empty/None
  - Test parse_number() with commas
  - Test parse_number() with empty string
  - Test first_block() with multiline text
  - Test first_block() with single line

- [ ] test_date_utils.py created (6+ tests)
  - Test parse_date() with YYYYMMDD format
  - Test parse_date() with YYYY/MM/DD format
  - Test parse_date() with invalid format returns None
  - Test parse_date() with empty string returns None
  - Test parse_date() with edge dates (leap year, etc.)

## Technical Details

### Mock Strategy

```python
# tests/test_fhs_hrs_client.py
import pytest
from unittest.mock import AsyncMock, patch
from app.integrations.fhs_hrs_client import FHSHRSClient

@pytest.mark.asyncio
async def test_get_employee_info_success():
    """Test successful employee fetch"""
    client = FHSHRSClient()

    # Mock HTTP response
    mock_response = "陳玉俊|PHAN ANH TUẤN|19970420|20190805|冶金技術部|工程師|..."

    with patch.object(client, '_fetch_text', return_value=mock_response):
        result = await client.get_employee_info(6204)

        assert result is not None
        assert result["employee_id"] == "VNW0006204"
        assert result["chinese_name"] == "陳玉俊"


@pytest.mark.asyncio
async def test_get_employee_info_not_found():
    """Test employee not found (404)"""
    client = FHSHRSClient()

    with patch.object(client, '_fetch_text', side_effect=Exception("404 Not Found")):
        result = await client.get_employee_info(9999)
        assert result is None


@pytest.mark.asyncio
async def test_bulk_get_employees_partial_failures():
    """Test bulk fetch with some failures"""
    client = FHSHRSClient()

    # Mock: ID 6201 succeeds, 6202 fails, 6203 succeeds
    async def mock_get(emp_id):
        if emp_id == 6202:
            return None
        return {"employee_id": f"VNW00{emp_id:05d}", "chinese_name": "Test"}

    with patch.object(client, 'get_employee_info', side_effect=mock_get):
        results = await client.bulk_get_employees(6201, 6203)

        assert len(results) == 3
        assert results[0] is not None
        assert results[1] is None  # Failed
        assert results[2] is not None
```

```python
# tests/test_employee_service.py
import pytest
from unittest.mock import AsyncMock, MagicMock
from app.services import employee_service
from app.models.employee import Employee

@pytest.mark.asyncio
async def test_sync_employee_from_hrs_create_new():
    """Test syncing new employee from HRS"""
    mock_db = AsyncMock()
    mock_db.get.return_value = None  # Employee doesn't exist

    # Mock client response
    with patch('app.services.employee_service.hrs_client.get_employee_info') as mock_client:
        mock_client.return_value = {
            "employee_id": "VNW0006204",
            "chinese_name": "陳玉俊",
            # ... other fields
        }

        employee = await employee_service.sync_employee_from_hrs(mock_db, 6204)

        assert employee is not None
        mock_db.add.assert_called_once()
        mock_db.commit.assert_called_once()


@pytest.mark.asyncio
async def test_bulk_sync_employees_continues_on_failure():
    """Test bulk sync continues when individual IDs fail"""
    mock_db = AsyncMock()

    # Mock bulk results: [success, None, success, error]
    with patch('app.services.employee_service.hrs_client.bulk_get_employees') as mock_client:
        mock_client.return_value = [
            {"employee_id": "VNW0006200", "chinese_name": "A"},
            None,  # Skipped
            {"employee_id": "VNW0006202", "chinese_name": "C"},
        ]

        result = await employee_service.bulk_sync_employees(
            mock_db, 6200, 6202, "hrs"
        )

        assert result["total"] == 3
        assert result["success"] == 2
        assert result["skipped"] == 1
        assert result["failed"] == 0
```

```python
# tests/test_text_utils.py
from app.utils.text_utils import chuan_hoa_ten, parse_number, first_block

def test_chuan_hoa_ten():
    """Test Vietnamese name normalization"""
    assert chuan_hoa_ten("phan anh tuấn") == "Phan Anh Tuấn"
    assert chuan_hoa_ten("NGUYỄN VĂN A") == "Nguyễn Văn A"
    assert chuan_hoa_ten("") == ""
    assert chuan_hoa_ten(None) == ""

def test_parse_number():
    """Test number parsing with commas"""
    assert parse_number("7,205,600") == 7205600
    assert parse_number("1,000") == 1000
    assert parse_number("") == 0
    assert parse_number("abc") raises ValueError or returns 0
```

### Test Configuration

```ini
# pytest.ini (update if needed)
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
asyncio_mode = auto
markers =
    asyncio: mark test as async
    unit: mark test as unit test
addopts = -v --tb=short --strict-markers --cov=app --cov-report=term --cov-report=html
```

## Dependencies

- [x] Task 001: Models and schemas
- [x] Task 002: Integration clients
- [x] Task 003: Service layer
- [x] pytest, pytest-asyncio, pytest-cov installed

## Effort Estimate

- **Size:** L (Large)
- **Hours:** 8-10 hours
  - 2h: Client tests (16 tests)
  - 4h: Service tests (19 tests)
  - 1h: Utility tests (12 tests)
  - 2h: Fix coverage gaps, refine mocks
  - 1h: Generate coverage report, document
- **Parallel:** true (can develop alongside Task 004 API endpoints)

## Definition of Done

- [ ] All test files created (5 files)
- [ ] 47+ test cases total
- [ ] All tests pass: `pytest -v`
- [ ] Code coverage > 80%: `pytest --cov=app --cov-report=html`
- [ ] Coverage report generated in htmlcov/
- [ ] Mocks used correctly (no real HTTP calls, no real DB)
- [ ] Tests cover happy paths and error scenarios
- [ ] Tests cover UTF-8 encoding (Chinese + Vietnamese)
- [ ] Tests cover edge cases (None, empty, invalid data)
- [ ] Test execution time < 10 seconds (all tests)
