---
name: Database setup - Employee model, migration, and schemas
status: open
created: 2026-01-09T02:15:19Z
updated: 2026-01-09T02:15:19Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Database setup - Employee model, migration, and schemas

## Description

Create the foundation for employee data storage by implementing the Employee database model, Alembic migration, and Pydantic schemas. This task sets up the database structure to store 20+ employee fields including Chinese/Vietnamese names, department info, salary, addresses, and audit timestamps.

**Key Components:**
1. SQLAlchemy Employee model (`app/models/employee.py`)
2. Alembic migration for employees table (`alembic/versions/xxx_add_employees_table.py`)
3. Pydantic schemas for request/response validation (`app/schemas/employees.py`)

## Acceptance Criteria

- [ ] Employee model created with all 20+ fields (id, name_tw, name_en, dob, start_date, dept, department_code, job_title, salary, addresses, phones, identity_number, sex, nationality, spouse_name, dorm_id, created_at, updated_at)
- [ ] Primary key: id (VARCHAR(10)) format VNW00XXXXX
- [ ] Indexes created on: department_code, identity_number
- [ ] Unique constraint on identity_number (CMND/CCCD)
- [ ] Alembic migration file generated and tested on dev database
- [ ] Migration is reversible (downgrade drops table)
- [ ] Pydantic schemas created:
  - SyncEmployeeRequest (emp_id, source, token?)
  - BulkSyncRequest (from_id, to_id, source, token?)
  - UpdateEmployeeRequest (all optional fields)
  - EmployeeResponse (full employee data)
  - EmployeeListResponse (items, total, skip, limit)
  - BulkSyncResponse (total, success, failed, skipped, errors)
  - DeleteResponse (success, message)
- [ ] Validators for:
  - Range validation (to_id >= from_id, range <= 1000)
  - Token required when source="covid"
  - Source pattern: "hrs" or "covid"

## Technical Details

### Employee Model Structure

```python
# app/models/employee.py
from sqlalchemy import Column, String, Integer, Date, DateTime
from sqlalchemy.sql import func
from app.database.session import Base

class Employee(Base):
    __tablename__ = "employees"

    # Primary Key
    id = Column(String(10), primary_key=True, index=True)  # VNW0006204

    # Names
    name_tw = Column(String(100))      # Chinese name (陳玉俊)
    name_en = Column(String(100))      # Vietnamese name (PHAN ANH TUẤN)

    # Dates
    dob = Column(Date, nullable=True)         # Date of birth
    start_date = Column(Date, nullable=True)  # Date of joining

    # Job Info
    dept = Column(String(100))                    # Department name (冶金技術部)
    department_code = Column(String(8), index=True)  # Code (7410)
    job_title = Column(String(100))               # Position (工程師)
    job_type = Column(String(100))                # Job type

    # Salary & Personal
    salary = Column(Integer, default=0)
    address1 = Column(String(200))  # Current address
    address2 = Column(String(200))  # Household registration
    phone1 = Column(String(20))
    phone2 = Column(String(20))

    # Family & Legal
    spouse_name = Column(String(100), nullable=True)
    nationality = Column(String(20))
    identity_number = Column(String(32), unique=True, index=True)  # CMND/CCCD
    sex = Column(String(8))  # Male/Female or 男/女

    # Dormitory (placeholder for future dorms feature)
    dorm_id = Column(String(20), nullable=True)

    # Audit timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

### Alembic Migration

```bash
# Generate migration
alembic revision -m "add_employees_table"

# Migration content:
# - Create employees table with all columns
# - Add indexes: idx_employees_department_code, idx_employees_identity_number
# - Add unique constraint: uq_employees_identity_number
# - Downgrade: drop table employees
```

### Pydantic Schemas

```python
# app/schemas/employees.py
from pydantic import BaseModel, Field, validator
from typing import Optional, List
from datetime import date, datetime

# Request schemas
class SyncEmployeeRequest(BaseModel):
    emp_id: int = Field(..., ge=1)
    source: str = Field(..., pattern="^(hrs|covid)$")
    token: Optional[str] = None

class BulkSyncRequest(BaseModel):
    from_id: int = Field(..., ge=1)
    to_id: int = Field(..., ge=1)
    source: str = Field(..., pattern="^(hrs|covid)$")
    token: Optional[str] = None

    @validator('to_id')
    def validate_range(cls, v, values):
        if 'from_id' in values and v < values['from_id']:
            raise ValueError('to_id must be >= from_id')
        if 'from_id' in values and v - values['from_id'] > 1000:
            raise ValueError('Range too large (max: 1000)')
        return v

    @validator('token')
    def validate_token_required_for_covid(cls, v, values):
        if 'source' in values and values['source'] == 'covid' and not v:
            raise ValueError('token is required when source is covid')
        return v

# Response schemas with from_attributes = True for ORM compatibility
```

### Files to Create

1. `app/models/employee.py` - SQLAlchemy model
2. `alembic/versions/xxx_add_employees_table.py` - Migration
3. `app/schemas/employees.py` - Pydantic schemas

### Import Registration

- Update `app/models/__init__.py` to export Employee
- Ensure alembic env.py imports all models for auto-generation

## Dependencies

- [x] PostgreSQL database available (ktxn258.duckdns.org:6543)
- [x] Alembic configured and working
- [x] SQLAlchemy Base class exists

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 4-6 hours
  - 1h: Employee model
  - 1h: Alembic migration
  - 2-3h: Pydantic schemas (7 schemas with validators)
  - 1h: Testing migration on dev database
- **Parallel:** false (foundation task, others depend on this)

## Definition of Done

- [ ] Employee model implemented and imported correctly
- [ ] Migration file created with upgrade/downgrade functions
- [ ] Migration successfully applied to dev database
- [ ] Verify table created: `SELECT * FROM employees LIMIT 1;`
- [ ] Verify indexes exist: Check pg_indexes for employees table
- [ ] Verify unique constraint: Try inserting duplicate identity_number (should fail)
- [ ] All 7 Pydantic schemas created with correct validators
- [ ] Validators tested (to_id validation, token validation, source pattern)
- [ ] UTF-8 encoding verified in database (collation utf8mb4 or UTF8)
- [ ] Code follows project structure (matches existing models/schemas pattern)
- [ ] No syntax errors, imports work correctly
