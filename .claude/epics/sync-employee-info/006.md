---
name: Integration tests - API endpoints end-to-end testing
status: open
created: 2026-01-09T02:15:19Z
updated: 2026-01-09T02:15:19Z
github: [Will be updated when synced to GitHub]
depends_on: [004]
parallel: true
conflicts_with: []
---

# Task: Integration tests - API endpoints end-to-end testing

## Description

Create integration tests for all 6 employee API endpoints testing the full request/response cycle including authentication, authorization, validation, and database operations. Tests use TestClient with real database transactions (rollback after each test).

**Test Files:**
1. tests/integration/test_employee_endpoints.py - All 6 endpoints
2. tests/integration/test_employee_workflows.py - Complete workflows

## Acceptance Criteria

### Endpoint Integration Tests
- [ ] test_employee_endpoints.py created (20+ tests)

**POST /api/employees/sync:**
- [ ] Test sync from HRS (admin, success)
- [ ] Test sync from COVID with token (admin, success)
- [ ] Test sync from COVID without token (400 error)
- [ ] Test sync as non-admin (403 error)
- [ ] Test sync with invalid employee ID (404 error)
- [ ] Test sync with invalid source (400 error)

**POST /api/employees/bulk-sync:**
- [ ] Test bulk sync from HRS (admin, success)
- [ ] Test bulk sync from COVID with token (admin, success)
- [ ] Test bulk sync with invalid range (422 error)
- [ ] Test bulk sync as non-admin (403 error)
- [ ] Test bulk sync returns correct summary (total, success, failed, skipped)

**GET /api/employees/search:**
- [ ] Test search by name (ILIKE match)
- [ ] Test search by department_code
- [ ] Test search by dorm_id
- [ ] Test search with pagination (skip, limit)
- [ ] Test search as non-admin (403 error)
- [ ] Test search returns EmployeeListResponse format

**GET /api/employees/{emp_id}:**
- [ ] Test get existing employee (admin, success)
- [ ] Test get non-existent employee (404 error)
- [ ] Test get as non-admin (403 error)

**PUT /api/employees/{emp_id}:**
- [ ] Test update employee (admin, success)
- [ ] Test update non-existent employee (404 error)
- [ ] Test update as non-admin (403 error)
- [ ] Test update with invalid data (422 error)

**DELETE /api/employees/{emp_id}:**
- [ ] Test delete existing employee (admin, success)
- [ ] Test delete non-existent employee (returns false)
- [ ] Test delete as non-admin (403 error)

### Workflow Tests
- [ ] test_employee_workflows.py created (5+ tests)
- [ ] Test complete workflow: sync → search → get → update → delete
- [ ] Test bulk sync → search shows all employees
- [ ] Test update employee → get shows updated data
- [ ] Test sync existing employee → updates data (not duplicate)
- [ ] Test multiple syncs from different sources (HRS then COVID)

## Technical Details

### Test Setup

```python
# tests/integration/test_employee_endpoints.py
import pytest
from httpx import AsyncClient
from fastapi import status

from app.main import app
from app.core.jwt_handler import create_access_token
from app.database.session import AsyncSessionLocal
from app.models.employee import Employee

# Fixtures
@pytest.fixture
async def admin_token():
    """Generate admin JWT token"""
    token = create_access_token(
        user_id="admin-user",
        role="admin",
        full_name="Admin User"
    )
    return token

@pytest.fixture
async def user_token():
    """Generate non-admin JWT token"""
    token = create_access_token(
        user_id="regular-user",
        role="user",
        full_name="Regular User"
    )
    return token

@pytest.fixture
async def test_db():
    """Database session that rolls back after test"""
    async with AsyncSessionLocal() as session:
        yield session
        await session.rollback()

@pytest.fixture
async def sample_employee(test_db):
    """Create a sample employee for testing"""
    employee = Employee(
        id="VNW0006204",
        name_tw="陳玉俊",
        name_en="PHAN ANH TUẤN",
        department_code="7410",
        identity_number="044090004970"
    )
    test_db.add(employee)
    await test_db.commit()
    await test_db.refresh(employee)
    return employee


# Tests
@pytest.mark.asyncio
async def test_sync_employee_from_hrs_success(admin_token):
    """Test syncing employee from HRS API"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post(
            "/api/employees/sync",
            json={"emp_id": 6204, "source": "hrs"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert data["id"] == "VNW0006204"
        assert "name_tw" in data
        assert "name_en" in data


@pytest.mark.asyncio
async def test_sync_employee_as_non_admin(user_token):
    """Test non-admin cannot sync employees"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post(
            "/api/employees/sync",
            json={"emp_id": 6204, "source": "hrs"},
            headers={"Authorization": f"Bearer {user_token}"}
        )

        assert response.status_code == status.HTTP_403_FORBIDDEN


@pytest.mark.asyncio
async def test_bulk_sync_returns_summary(admin_token):
    """Test bulk sync returns correct summary format"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post(
            "/api/employees/bulk-sync",
            json={"from_id": 6200, "to_id": 6210, "source": "hrs"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert "total" in data
        assert "success" in data
        assert "failed" in data
        assert "skipped" in data
        assert "errors" in data
        assert data["total"] == 11


@pytest.mark.asyncio
async def test_search_employees_by_name(admin_token, sample_employee):
    """Test search employees by name"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get(
            "/api/employees/search",
            params={"name": "陳玉"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert "items" in data
        assert len(data["items"]) >= 1
        assert data["items"][0]["id"] == "VNW0006204"


@pytest.mark.asyncio
async def test_get_employee_by_id(admin_token, sample_employee):
    """Test get employee by ID"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get(
            "/api/employees/VNW0006204",
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert data["id"] == "VNW0006204"
        assert data["name_tw"] == "陳玉俊"


@pytest.mark.asyncio
async def test_update_employee(admin_token, sample_employee):
    """Test update employee"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.put(
            "/api/employees/VNW0006204",
            json={"job_title": "Senior Engineer"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert data["job_title"] == "Senior Engineer"


@pytest.mark.asyncio
async def test_delete_employee(admin_token, sample_employee):
    """Test delete employee"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.delete(
            "/api/employees/VNW0006204",
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert data["success"] is True
```

### Workflow Tests

```python
# tests/integration/test_employee_workflows.py
@pytest.mark.asyncio
async def test_complete_employee_lifecycle(admin_token):
    """Test: sync → get → update → search → delete"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 1. Sync employee
        sync_resp = await client.post(
            "/api/employees/sync",
            json={"emp_id": 6204, "source": "hrs"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert sync_resp.status_code == 200

        # 2. Get employee
        get_resp = await client.get(
            "/api/employees/VNW0006204",
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert get_resp.status_code == 200

        # 3. Update employee
        update_resp = await client.put(
            "/api/employees/VNW0006204",
            json={"job_title": "Lead Engineer"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert update_resp.status_code == 200
        assert update_resp.json()["job_title"] == "Lead Engineer"

        # 4. Search finds updated employee
        search_resp = await client.get(
            "/api/employees/search",
            params={"name": "陳玉"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert search_resp.status_code == 200
        assert len(search_resp.json()["items"]) >= 1

        # 5. Delete employee
        delete_resp = await client.delete(
            "/api/employees/VNW0006204",
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert delete_resp.status_code == 200
        assert delete_resp.json()["success"] is True

        # 6. Verify deleted
        get_after_delete = await client.get(
            "/api/employees/VNW0006204",
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert get_after_delete.status_code == 404
```

## Dependencies

- [x] Task 004: API endpoints
- [x] Test database available
- [x] TestClient from httpx

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
  - 4h: Endpoint tests (25 tests)
  - 2h: Workflow tests (5 tests)
  - 2h: Fixtures, setup, debugging
- **Parallel:** true (can develop alongside Task 005 unit tests)

## Definition of Done

- [ ] test_employee_endpoints.py created (25+ tests)
- [ ] test_employee_workflows.py created (5+ tests)
- [ ] All tests pass with real database (rollback after each)
- [ ] Tests cover all 6 endpoints
- [ ] Tests cover authentication (401) and authorization (403)
- [ ] Tests cover validation (422)
- [ ] Tests cover not found (404)
- [ ] Workflow tests verify complete lifecycles
- [ ] Database rollback works (no test data persists)
- [ ] Test execution time < 30 seconds
