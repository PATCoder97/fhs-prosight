---
name: Integration clients - FHS HRS and COVID API clients with utilities
status: open
created: 2026-01-09T02:15:19Z
updated: 2026-01-09T02:28:23Z
github: https://github.com/PATCoder97/fhs-prosight/issues/13
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Integration clients - FHS HRS and COVID API clients with utilities

## Description

Implement HTTP clients for FHS HRS and COVID APIs following the existing OAuth client pattern (GoogleAuthClient, GitHubAuthClient). Each client supports both single employee fetch and bulk fetch methods. Include utility functions for text parsing, date conversion, and Vietnamese name normalization.

**Key Components:**
1. FHSHRSClient - Fetch from HRS API (22 fields, no authentication)
2. FHSCovidClient - Fetch from COVID API (fewer fields, requires bearer token)
3. Utility functions for parsing and text normalization

## Acceptance Criteria

### FHS HRS Client
- [ ] Class `FHSHRSClient` created in `app/integrations/fhs_hrs_client.py`
- [ ] Base URL: `https://www.fhs.com.tw/ads/api/Furnace/rest/json/hr`
- [ ] Method: `async get_employee_info(emp_id: int) -> Optional[Dict]`
  - Convert emp_id to VNW00{emp_id:05d} format
  - Call endpoint: `s10/{emp_id_str}`
  - Parse 22 pipe-separated fields
  - Force UTF-8 encoding
  - Return None on error (no exceptions)
- [ ] Method: `async bulk_get_employees(from_id: int, to_id: int) -> List[Optional[Dict]]`
  - Loop from from_id to to_id
  - Call get_employee_info() for each
  - Continue on individual failures
  - Return list with None for failed IDs

### FHS COVID Client
- [ ] Class `FHSCovidClient` created in `app/integrations/fhs_covid_client.py`
- [ ] Base URL: `https://www.fhs.com.tw/fhs_covid_api/api/reportVaccines/detail`
- [ ] Method: `async get_user_info(emp_id: int, token: str) -> Optional[Dict]`
  - Convert emp_id to VNW00{emp_id:05d} format
  - Query params: `?isFHS=true&isFull=false&userName={emp_id_str}`
  - Headers: `Authorization: Bearer {token}`
  - Force UTF-8 encoding
  - Return None on error (no exceptions)
- [ ] Method: `async bulk_get_users(from_id: int, to_id: int, token: str) -> List[Optional[Dict]]`
  - Loop from from_id to to_id
  - Call get_user_info() for each
  - Same token for all requests
  - Continue on individual failures
  - Return list with None for failed IDs

### Utility Functions
- [ ] `chuan_hoa_ten(name: str) -> str` in `app/utils/text_utils.py`
  - Normalize Vietnamese names (capitalize, trim spaces)
- [ ] `parse_date(date_str: str) -> Optional[date]` in `app/utils/date_utils.py`
  - Parse dates from HRS API (multiple formats)
  - Handle: YYYYMMDD, YYYY/MM/DD, etc.
- [ ] `parse_number(num_str: str) -> int` in `app/utils/text_utils.py`
  - Parse salary and numeric fields
  - Handle commas in numbers (7,205,600 → 7205600)
- [ ] `first_block(raw_text: str) -> str` in `app/utils/text_utils.py`
  - Extract first data block from HRS API response

## Technical Details

### Client Pattern (Follow Existing OAuth Clients)

```python
# app/integrations/fhs_hrs_client.py
import httpx
import logging
from typing import Optional, Dict, List

logger = logging.getLogger(__name__)

class FHSHRSClient:
    def __init__(self):
        self.base_url = "https://www.fhs.com.tw/ads/api/Furnace/rest/json/hr"
        self.timeout = 30.0
        self.headers = {
            "User-Agent": "FHSHRSClient/1.0",
            "Accept": "text/plain",
        }

    async def _fetch_text(self, path: str) -> str:
        """Internal helper to fetch raw text from API"""
        url = f"{self.base_url}/{path.lstrip('/')}"
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            try:
                resp = await client.get(url, headers=self.headers)
                resp.raise_for_status()
                resp.encoding = "utf-8"  # Force UTF-8
                return resp.text
            except Exception as e:
                logger.error(f"HRS API error: {url} - {e}")
                raise

    async def get_employee_info(self, emp_id: int) -> Optional[Dict]:
        """Fetch single employee from HRS API"""
        emp_id_str = f"VNW00{emp_id:05d}"
        path = f"s10/{emp_id_str}"

        try:
            raw_text = await self._fetch_text(path)
            fields = _first_block(raw_text).split("|")

            if len(fields) < 22:
                logger.error(f"Insufficient fields for {emp_id_str}: {len(fields)}")
                return None

            return {
                "employee_id": emp_id_str,
                "chinese_name": fields[0],
                "vietnamese_name": chuan_hoa_ten(fields[1]),
                "date_of_birth": _parse_date(fields[2]),
                # ... map all 22 fields
            }
        except Exception as e:
            logger.error(f"Error fetching {emp_id_str}: {e}")
            return None

    async def bulk_get_employees(self, from_id: int, to_id: int) -> List[Optional[Dict]]:
        """Bulk fetch employees"""
        results = []
        for emp_id in range(from_id, to_id + 1):
            result = await self.get_employee_info(emp_id)
            results.append(result)
        return results
```

### COVID Client Pattern

```python
# app/integrations/fhs_covid_client.py
class FHSCovidClient:
    def __init__(self):
        self.base_url = "https://www.fhs.com.tw/fhs_covid_api/api/reportVaccines/detail"
        self.timeout = 30.0

    async def get_user_info(self, emp_id: int, token: str) -> Optional[Dict]:
        """Fetch single user from COVID API"""
        emp_id_str = f"VNW00{emp_id:05d}"
        url = f"{self.base_url}?isFHS=true&isFull=false&userName={emp_id_str}"

        headers = {
            "Authorization": f"Bearer {token}",
            "User-Agent": "CovidWebClient/1.0",
            "Accept": "application/json",
        }

        async with httpx.AsyncClient(timeout=self.timeout) as client:
            try:
                resp = await client.get(url, headers=headers)
                resp.raise_for_status()
                resp.encoding = "utf-8"
                data = resp.json()

                return {
                    "userName": data.get("userName"),
                    "fullName": data.get("fullName"),
                    "departmentCode": data.get("departmentCode"),
                    # ... map all fields
                }
            except Exception as e:
                logger.error(f"COVID API error for {emp_id_str}: {e}")
                return None
```

### Utility Functions

```python
# app/utils/text_utils.py
def chuan_hoa_ten(name: str) -> str:
    """Normalize Vietnamese name"""
    if not name:
        return ""
    return " ".join(word.capitalize() for word in name.split())

def parse_number(num_str: str) -> int:
    """Parse number with commas: 7,205,600 → 7205600"""
    if not num_str:
        return 0
    return int(num_str.replace(",", "").replace(".", ""))

def first_block(raw_text: str) -> str:
    """Extract first data block"""
    return raw_text.split("\n")[0].strip()
```

```python
# app/utils/date_utils.py
from datetime import date
from typing import Optional

def parse_date(date_str: str) -> Optional[date]:
    """Parse date from multiple formats"""
    if not date_str:
        return None

    # Try YYYYMMDD
    if len(date_str) == 8 and date_str.isdigit():
        return date(int(date_str[:4]), int(date_str[4:6]), int(date_str[6:8]))

    # Try YYYY/MM/DD
    if "/" in date_str:
        parts = date_str.split("/")
        return date(int(parts[0]), int(parts[1]), int(parts[2]))

    return None
```

### Files to Create

1. `app/integrations/fhs_hrs_client.py` - HRS API client
2. `app/integrations/fhs_covid_client.py` - COVID API client
3. `app/utils/text_utils.py` - Text utilities
4. `app/utils/date_utils.py` - Date parsing

### Update Imports

- Update `app/integrations/__init__.py` to export both clients
- Update `app/utils/__init__.py` to export utilities

## Dependencies

- [x] httpx library installed (already available)
- [x] Access to FHS APIs (URLs available)
- [ ] Bearer token for COVID API testing (admin must provide)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
  - 2h: FHS HRS Client (22 fields parsing)
  - 2h: FHS COVID Client (bearer token auth)
  - 1h: Utility functions
  - 2h: Testing with real APIs
  - 1h: Error handling and retry logic
- **Parallel:** true (can work independently from database setup)

## Definition of Done

- [ ] FHSHRSClient implemented with both methods
- [ ] FHSCovidClient implemented with both methods
- [ ] All 4 utility functions implemented
- [ ] Tested with real HRS API (single + bulk)
- [ ] Tested with real COVID API (single + bulk with token)
- [ ] UTF-8 encoding works for Chinese names (陳玉俊)
- [ ] UTF-8 encoding works for Vietnamese names (PHAN ANH TUẤN)
- [ ] Error handling: returns None on failure (no exceptions raised to caller)
- [ ] Logging: all errors logged with context
- [ ] Timeout: 30 seconds per request
- [ ] Code follows existing OAuth client pattern
- [ ] Imports registered in __init__.py files
