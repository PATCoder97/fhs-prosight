---
name: Implement Excel upload service with upsert logic
status: completed
created: 2026-01-10T09:10:21Z
updated: 2026-01-10T09:42:36Z
github: https://github.com/PATCoder97/fhs-prosight/issues/40
depends_on: [38, 39]
parallel: false
conflicts_with: []
---

# Task: Implement Excel Upload Service with Upsert Logic

## Description

Implement the service layer method for parsing Excel files and importing evaluation data. Use openpyxl to read Excel files, map 27 columns from Chinese headers to database fields, and implement transaction-based upsert logic (UPDATE if exists, INSERT if new) based on composite key (term_code, employee_id).

## Acceptance Criteria

- [ ] Service file created/updated at `backend/app/services/evaluation_service.py`
- [ ] `upload_evaluations_from_excel()` async method implemented
- [ ] Excel column mapping dictionary with 27 mappings (Chinese → English)
- [ ] Header row validation (checks required columns exist)
- [ ] Row-by-row processing with upsert logic
- [ ] Transaction-based processing (commit all or rollback)
- [ ] Error handling for individual rows (collect errors, don't fail entire upload)
- [ ] Return summary with counts (total_rows, created, updated, errors)
- [ ] Return error details list with row numbers and error messages

## Technical Details

**Service Method** (`backend/app/services/evaluation_service.py`):

```python
async def upload_evaluations_from_excel(
    db: AsyncSession,
    file_path: str
) -> dict:
    """
    Parse Excel file and import/update evaluation records.

    Returns:
        {
            "success": True,
            "summary": {
                "total_rows": 150,
                "created": 120,
                "updated": 30,
                "errors": 0
            },
            "error_details": []
        }
    """
```

**Excel Column Mapping**:
```python
EXCEL_COLUMN_MAPPING = {
    "評核年月": "term_code",
    "工號": "employee_id",
    "姓名": "employee_name",
    "職等": "job_level",
    "國籍": "nation",
    "部門代碼": "dept_code",
    "部門名稱": "dept_name",
    "職等六碼": "grade_code",
    "職等名稱": "grade_name",
    "初核成績": "init_score",
    "初核評語": "init_comment",
    "初核主管": "init_reviewer",
    "複核成績": "review_score",
    "複核評語": "review_comment",
    "複核主管": "review_reviewer",
    "核定成績": "final_score",
    "核定評語": "final_comment",
    "核定主管": "final_reviewer",
    "經理室初核成績": "mgr_init_score",
    "經理室初核評語": "mgr_init_comment",
    "經理室初核主管": "mgr_init_reviewer",
    "經理室複核成績": "mgr_review_score",
    "經理室複核評語": "mgr_review_comment",
    "經理室複核主管": "mgr_review_reviewer",
    "經理室核定成績": "mgr_final_score",
    "經理室核定評語": "mgr_final_comment",
    "經理室核定主管": "mgr_final_reviewer",
    "請假總日數": "leave_days",
}
```

**Processing Flow**:
1. Open Excel file with `openpyxl.load_workbook(file_path, read_only=True)`
2. Get active sheet
3. Read header row (row 1), validate required columns ("評核年月", "工號") exist
4. For each data row (starting row 2):
   - Map columns using EXCEL_COLUMN_MAPPING
   - Validate term_code and employee_id are not empty
   - Check if record exists: `SELECT id FROM evaluations WHERE term_code=X AND employee_id=Y`
   - If exists: UPDATE with new values, increment `updated` counter
   - If not: INSERT new record, increment `created` counter
   - If error: catch exception, add to error_details, increment `errors` counter
5. Commit transaction
6. Return summary dict

**Error Handling**:
- Catch row-level exceptions (don't fail entire upload)
- Log error with row number and message
- Continue processing remaining rows
- Return error_details list in response

## Dependencies

- [ ] Task 001 completed (Evaluation model exists)
- [ ] Task 002 completed (schemas available)
- [ ] openpyxl library installed (to be added in Task 007)
- [ ] SQLAlchemy AsyncSession available

## Effort Estimate

- Size: L
- Hours: 3
- Parallel: false (depends on Tasks 001, 002)

## Definition of Done

- [ ] Service method implemented with full upsert logic
- [ ] Excel parsing works with openpyxl (read-only mode)
- [ ] All 27 columns correctly mapped
- [ ] Upsert logic correctly updates existing records (no duplicates)
- [ ] Transaction ensures atomicity
- [ ] Error handling collects errors without failing upload
- [ ] Summary counts are accurate (created + updated + errors = total_rows)
- [ ] Tested with sample Excel file (manual test)
- [ ] Committed with message: "Issue #XX: Implement Excel upload service with upsert logic"
