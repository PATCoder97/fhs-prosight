---
name: Implement search service with filters and pagination
status: completed
created: 2026-01-10T09:10:21Z
updated: 2026-01-10T09:53:34Z
github: https://github.com/PATCoder97/fhs-prosight/issues/42
depends_on: [38, 39]
parallel: true
conflicts_with: [40]
---

# Task: Implement Search Service with Filters and Pagination

## Description

Implement the service layer method for searching evaluation records with flexible filters (employee_id, term_code, dept_code) and pagination support. Transform flat database rows into nested response structure with dept_evaluation and mgr_evaluation groups.

## Acceptance Criteria

- [ ] Service method `search_evaluations()` implemented in `backend/app/services/evaluation_service.py`
- [ ] Query building with optional filters (employee_id exact, term_code exact, dept_code prefix)
- [ ] Total count query (before pagination)
- [ ] Pagination logic (LIMIT/OFFSET)
- [ ] Response transformation (flat fields â†’ nested evaluation groups)
- [ ] Default pagination values (page=1, page_size=50)
- [ ] Max page_size validation (max 100)
- [ ] Return dict matching SearchResponse schema

## Technical Details

**Service Method** (`backend/app/services/evaluation_service.py`):

```python
async def search_evaluations(
    db: AsyncSession,
    employee_id: Optional[str] = None,
    term_code: Optional[str] = None,
    dept_code: Optional[str] = None,
    page: int = 1,
    page_size: int = 50
) -> dict:
    """
    Search evaluation records with filters and pagination.

    Args:
        employee_id: Exact match filter (e.g., 'VNW0018983')
        term_code: Exact match filter (e.g., '25B')
        dept_code: Prefix match filter (e.g., '78' matches '7800', '7810')
        page: Page number (1-indexed)
        page_size: Items per page (max 100)

    Returns:
        {
            "total": 250,
            "page": 1,
            "page_size": 50,
            "results": [...]
        }
    """
```

**Query Building**:
1. Start with base query: `SELECT * FROM evaluations`
2. Apply filters conditionally:
   - If employee_id: `WHERE employee_id = :employee_id`
   - If term_code: `WHERE term_code = :term_code`
   - If dept_code: `WHERE dept_code LIKE :dept_code%` (starts with)
3. Count total: `SELECT COUNT(*) FROM evaluations WHERE [filters]`
4. Apply pagination: `LIMIT :page_size OFFSET (:page - 1) * :page_size`
5. Execute query and fetch results

**Response Transformation**:
- For each row, group fields into nested structure:
```python
{
    "id": row.id,
    "term_code": row.term_code,
    "employee_id": row.employee_id,
    # ... other flat fields
    "dept_evaluation": {
        "init": {"score": row.init_score, "comment": row.init_comment, "reviewer": row.init_reviewer},
        "review": {"score": row.review_score, "comment": row.review_comment, "reviewer": row.review_reviewer},
        "final": {"score": row.final_score, "comment": row.final_comment, "reviewer": row.final_reviewer}
    },
    "mgr_evaluation": {
        "init": {"score": row.mgr_init_score, "comment": row.mgr_init_comment, "reviewer": row.mgr_init_reviewer},
        "review": {"score": row.mgr_review_score, "comment": row.mgr_review_comment, "reviewer": row.mgr_review_reviewer},
        "final": {"score": row.mgr_final_score, "comment": row.mgr_final_comment, "reviewer": row.mgr_final_reviewer}
    }
}
```

**Pagination Validation**:
- Validate `page >= 1`
- Validate `page_size <= 100` (enforce max to prevent performance issues)
- Use defaults if not provided: page=1, page_size=50

## Dependencies

- [ ] Task 001 completed (Evaluation model exists)
- [ ] Task 002 completed (SearchResponse schema exists)
- [ ] SQLAlchemy AsyncSession available

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: true (can be implemented alongside Task 003 since they use different service methods)

## Definition of Done

- [ ] Service method implemented with all filters
- [ ] Employee ID filter works (exact match)
- [ ] Term code filter works (exact match)
- [ ] Dept code filter works (prefix match, e.g., '78' matches '7800', '7810')
- [ ] Pagination works correctly (no duplicates across pages)
- [ ] Total count accurate (matches filter criteria)
- [ ] Nested response structure matches schema
- [ ] Max page_size enforced (100)
- [ ] Tested with various filter combinations (manual test)
- [ ] Committed with message: "Issue #XX: Implement search service with filters and pagination"
