---
name: Extend HRS client with year bonus retrieval
status: open
created: 2026-01-10T07:10:50Z
updated: 2026-01-10T07:17:03Z
github: https://github.com/PATCoder97/fhs-prosight/issues/34
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Extend HRS Client with Year Bonus Retrieval

## Description

Add `get_year_bonus()` async method to the existing `FHSHRSClient` class in `backend/app/integrations/fhs_hrs_client.py`. This method calls 2 HRS API endpoints in parallel (pre-Tet and post-Tet bonuses) and parses pipe-delimited responses using exact field positions.

**Key implementation**: Use `asyncio.gather()` for parallel calls, `_first_block()` helper for parsing, and exact field index positions provided by user.

Total new code: ~45 lines.

## Acceptance Criteria

- [ ] `get_year_bonus(emp_id: int, year: int)` async method created
- [ ] Constructs 2 HRS paths: BEF and AFT with exact format
- [ ] Calls both endpoints in parallel using `asyncio.gather()`
- [ ] Parses BEF response: extracts fields [0,1,2,3,4,9,10]
- [ ] Parses AFT response: extracts last field [-1]
- [ ] Returns dict with all 8 fields (or empty dict on total failure)
- [ ] Uses `return_exceptions=True` for graceful error handling
- [ ] Validates BEF has ≥11 fields before parsing
- [ ] Logs warnings for incomplete/malformed data

## Technical Details

**File to modify**: `backend/app/integrations/fhs_hrs_client.py`

**New Method** (add to FHSHRSClient class):

```python
async def get_year_bonus(self, emp_id: int, year: int) -> dict:
    """Fetch employee year bonus data from HRS API (pre-Tet + post-Tet).

    Args:
        emp_id: Employee numeric ID (e.g., 6204 for VNW0006204)
        year: Bonus year (e.g., 2024)

    Returns:
        Dict with bonus data fields:
        {
            "mnv": str, "tlcb": str, "stdltbtn": str, "capbac": str,
            "tile": str, "stienthuong": str, "tpnttt": str, "tpntst": str
        }
        Returns empty dict if both API calls fail or data is invalid.

    Raises:
        Exception: If HRS API is completely unavailable (caller handles)
    """
    emp_str = f"VNW00{emp_id:05d}"
    path_bef = f"s19/{emp_str}vkokvbefvkokv{year}"
    path_aft = f"s19/{emp_str}vkokvaftvkokv{year}"

    # Call both endpoints in parallel
    try:
        results = await asyncio.gather(
            self._fetch_text(path_bef),
            self._fetch_text(path_aft),
            return_exceptions=True,
        )
    except Exception as e:
        logger.error(f"Error fetching year bonus for emp_id {emp_id}, year {year}: {e}")
        raise

    text_bef = results[0] if isinstance(results[0], str) else ""
    text_aft = results[1] if isinstance(results[1], str) else ""

    # Parse responses
    data = {}
    try:
        # Parse BEF (pre-Tet bonus)
        if text_bef:
            bef_parts = _first_block(text_bef).split("|")
            if len(bef_parts) >= 11:
                data.update({
                    "mnv": bef_parts[0],
                    "tlcb": bef_parts[1],
                    "stdltbtn": bef_parts[2],
                    "capbac": bef_parts[3],
                    "tile": bef_parts[4],
                    "stienthuong": bef_parts[9],
                    "tpnttt": bef_parts[10],
                })
            else:
                logger.warning(
                    f"Year bonus BEF data insufficient for emp_id {emp_id}, year {year}: "
                    f"expected ≥11 fields, got {len(bef_parts)}"
                )

        # Parse AFT (post-Tet bonus) - extract last field
        if text_aft:
            aft_parts = _first_block(text_aft).split("|")
            if aft_parts:
                data["tpntst"] = aft_parts[-1]
            else:
                logger.warning(f"Year bonus AFT data empty for emp_id {emp_id}, year {year}")

    except (IndexError, ValueError) as e:
        logger.error(f"Error parsing year bonus data for emp_id {emp_id}, year {year}: {e}")

    return data
```

**Pattern to follow**: Follow the structure of `get_salary_data()` and `get_achievement_data()` in the same file

**Imports needed**: `asyncio` (already imported in file)

**Critical**: Use exact field positions [0,1,2,3,4,9,10] for BEF and [-1] for AFT as provided by user

## Dependencies

- [ ] FHSHRSClient class exists (from existing codebase)
- [ ] `_fetch_text()` method exists (from salary API)
- [ ] `_first_block()` helper exists (from salary API)
- [ ] Logger configured (from existing file)
- [ ] `asyncio` module imported

## Effort Estimate

- Size: S
- Hours: 2 hours
- Parallel: false (can run in parallel with Task 001, but typically done after schema)

## Definition of Done

- [ ] Method `get_year_bonus()` implemented in FHSHRSClient class
- [ ] Parallel API calls using asyncio.gather() working
- [ ] Field positions exactly match user specification
- [ ] Error handling for partial failures (one API fails)
- [ ] Logging for warnings and errors
- [ ] Returns empty dict on total failure (not exception)
- [ ] Manual test with sample employee ID and year successful
- [ ] Committed with message: "Issue #XX: Extend HRS client with year bonus retrieval"
- [ ] No breaking changes to existing HRS client methods
