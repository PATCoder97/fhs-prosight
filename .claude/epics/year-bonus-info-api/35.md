---
name: Implement service layer for year bonus queries
status: open
created: 2026-01-10T07:10:50Z
updated: 2026-01-10T07:17:03Z
github: https://github.com/PATCoder97/fhs-prosight/issues/35
depends_on: [33, 34]
parallel: false
conflicts_with: []
---

# Task: Implement Service Layer for Year Bonus Queries

## Description

Add `get_employee_year_bonus()` method to the existing `backend/app/services/hrs_data_service.py` file. This service method handles business logic for year bonus queries: employee ID validation, year validation, HRS API calls, employee name lookup, and error handling.

Mirrors the exact pattern of `get_employee_salary()` and `get_employee_achievements()` in the same file. Total new code: ~65 lines.

## Acceptance Criteria

- [ ] `get_employee_year_bonus()` async function created
- [ ] Employee ID validation (VNW0006204 → 6204)
- [ ] Year validation (range 2000-2030)
- [ ] Calls `hrs_client.get_year_bonus(emp_num, year)`
- [ ] Looks up employee name from database (Employee model)
- [ ] Returns dict matching `YearBonusResponse` schema
- [ ] Error handling: 400 (invalid ID/year), 404 (no data), 503 (HRS unavailable)
- [ ] Logging for API calls and errors
- [ ] Fallback to "Unknown" if employee not in database

## Technical Details

**File to modify**: `backend/app/services/hrs_data_service.py`

**New Method**:

```python
async def get_employee_year_bonus(
    db: AsyncSession,
    emp_id: str,
    year: int
) -> dict:
    """
    Get employee year bonus data.

    Args:
        db: Database session
        emp_id: Employee ID (e.g., "VNW0006204")
        year: Bonus year (e.g., 2024)

    Returns:
        dict matching YearBonusResponse schema:
        {
            "employee_id": str,
            "employee_name": str,
            "year": int,
            "bonus_data": {
                "mnv": str, "tlcb": str, "stdltbtn": str, "capbac": str,
                "tile": str, "stienthuong": str, "tpnttt": str, "tpntst": str
            }
        }

    Raises:
        HTTPException(400): Invalid employee ID or year format
        HTTPException(404): No bonus data found
        HTTPException(503): HRS API unavailable
    """
    # Convert emp_id format: VNW0006204 → 6204
    try:
        emp_num = int(emp_id.replace("VNW00", ""))
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid employee ID format: {emp_id}"
        )

    # Validate year range
    if not (2000 <= year <= 2030):
        raise HTTPException(
            status_code=400,
            detail=f"Invalid year: {year}. Must be between 2000 and 2030."
        )

    # Query HRS API
    logger.info(f"Fetching year bonus for {emp_id}, year {year}")
    hrs_client = FHSHRSClient()

    try:
        bonus_data = await hrs_client.get_year_bonus(emp_num, year)
    except Exception as e:
        logger.error(f"HRS API error for {emp_id}, year {year}: {e}")
        raise HTTPException(
            status_code=503,
            detail="HRS API unavailable"
        )

    if not bonus_data:
        raise HTTPException(
            status_code=404,
            detail=f"No year bonus data found for employee {emp_id} in {year}"
        )

    # Lookup employee name from database
    employee = await db.get(Employee, emp_id)
    emp_name = employee.name_en if employee else "Unknown"

    if not employee:
        logger.warning(f"Employee {emp_id} not found in database, using 'Unknown'")

    # Return structured response
    return {
        "employee_id": emp_id,
        "employee_name": emp_name,
        "year": year,
        "bonus_data": bonus_data
    }
```

**Pattern to follow**: Mirror `get_employee_salary()` and `get_employee_achievements()` functions in the same file

**Imports needed**: Already exist in the file (HTTPException, AsyncSession, Employee, FHSHRSClient, logger)

**Update module docstring** to include year bonus queries:
```python
"""
Service layer for HRS data queries and trend analysis.

This module provides business logic for:
1. Single month salary queries with employee info lookup
2. Multi-month salary history with parallel API calls
3. Trend analysis (averages, highest/lowest, significant changes)
4. Employee achievement/evaluation data queries
5. Year bonus queries (pre-Tet + post-Tet bonuses)
"""
```

## Dependencies

- [ ] Task 001 completed (YearBonusResponse schema exists)
- [ ] Task 002 completed (get_year_bonus() method exists)
- [ ] Employee model exists (from existing codebase)
- [ ] FHSHRSClient exists (from existing codebase)

## Effort Estimate

- Size: S
- Hours: 2 hours
- Parallel: false (depends on 001 and 002)

## Definition of Done

- [ ] Code implemented in hrs_data_service.py
- [ ] Module docstring updated
- [ ] Employee ID validation working
- [ ] Year validation working (2000-2030 range)
- [ ] Database lookup working (with fallback to "Unknown")
- [ ] Error handling for all cases (400, 404, 503)
- [ ] Logging messages added
- [ ] Function returns dict matching YearBonusResponse schema
- [ ] Committed with message: "Issue #XX: Implement service layer for year bonus queries"
- [ ] No breaking changes to existing service methods
