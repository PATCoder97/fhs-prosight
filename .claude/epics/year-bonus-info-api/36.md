---
name: Create REST API endpoint for year bonus queries
status: open
created: 2026-01-10T07:10:50Z
updated: 2026-01-10T07:17:03Z
github: https://github.com/PATCoder97/fhs-prosight/issues/36
depends_on: [33, 34, 35]
parallel: false
conflicts_with: []
---

# Task: Create REST API Endpoint for Year Bonus Queries

## Description

Add 1 new endpoint to the existing `backend/app/routers/hrs_data.py` router to expose year bonus data. This endpoint follows the exact same pattern as the salary and achievement endpoints in the same file.

Total new code: ~55 lines (endpoint with OpenAPI documentation).

## Acceptance Criteria

- [ ] Endpoint: `GET /api/hrs-data/year-bonus/{employee_id}/{year}` created
- [ ] Uses `YearBonusResponse` as response model
- [ ] Authorization: Uses `require_authenticated_user` (blocks guests)
- [ ] Path parameters validated: employee_id (str), year (int)
- [ ] OpenAPI documentation with summary, description, examples
- [ ] Error handling: 400, 401, 403, 404, 503
- [ ] Logging for all requests
- [ ] Router docstring updated to list 7 endpoints

## Technical Details

**File to modify**: `backend/app/routers/hrs_data.py`

**Update Router Docstring** (at top of file):
```python
"""
HRS Data API Router.

Provides 7 endpoints:
1. GET /salary - View own salary (authenticated users)
2. GET /salary/history - View salary history with trend (authenticated users)
3. GET /salary/history/{employee_id} - View any employee's salary history (authenticated users)
4. GET /salary/{employee_id} - View any employee's salary (authenticated users)
5. GET /achievements - View own achievements (authenticated users)
6. GET /achievements/{employee_id} - View any employee's achievements (authenticated users)
7. GET /year-bonus/{employee_id}/{year} - View any employee's year bonus (authenticated users)
"""
```

**Add to imports**:
```python
from app.schemas.hrs_data import SalaryResponse, SalaryHistoryResponse, AchievementResponse, YearBonusResponse
```

**New Endpoint**:
```python
@router.get(
    "/year-bonus/{employee_id}/{year}",
    response_model=YearBonusResponse,
    summary="Get employee year bonus",
    description="Get employee's year-end bonus data (pre-Tet + post-Tet bonuses)"
)
async def get_employee_year_bonus(
    employee_id: str,
    year: int,
    current_user: dict = Depends(require_authenticated_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Get employee's year-end bonus data.

    **Access:** Authenticated users (excludes guest)

    **Path Parameters:**
    - employee_id: Employee ID (e.g., VNW0006204)
    - year: Bonus year (e.g., 2024)

    **Response:**
    - 200: Year bonus data returned
    - 400: Invalid employee ID or year format
    - 403: Forbidden (guest user)
    - 404: No bonus data found for specified year
    - 503: HRS API unavailable

    **Example:**
    ```
    GET /api/hrs-data/year-bonus/VNW0006204/2024
    ```
    """
    logger.info(
        f"User {current_user['localId']} querying year bonus for {employee_id}, year {year}"
    )

    try:
        bonus_data = await hrs_data_service.get_employee_year_bonus(db, employee_id, year)
        return bonus_data
    except HTTPException:
        raise
    except Exception as e:
        logger.error(
            f"Unexpected error getting year bonus for {employee_id}, year {year}: {e}",
            exc_info=True
        )
        raise HTTPException(
            status_code=503,
            detail="Failed to retrieve year bonus data. Please try again later."
        )
```

**Location**: Add after the last achievement endpoint, before the end of file

**Pattern to follow**: Mirror the structure of achievement endpoints in the same file

## Dependencies

- [ ] Task 001 completed (YearBonusResponse schema exists)
- [ ] Task 002 completed (HRS client method exists)
- [ ] Task 003 completed (service method exists)
- [ ] Authorization functions exist (from existing codebase)

## Effort Estimate

- Size: S
- Hours: 2 hours
- Parallel: false (depends on 001, 34, 003)

## Definition of Done

- [ ] Code implemented in hrs_data.py
- [ ] Endpoint added and working
- [ ] Router docstring updated (lists 7 endpoints)
- [ ] Import statement updated with YearBonusResponse
- [ ] Authorization working (blocks guests, allows authenticated users)
- [ ] Error handling for all cases (400, 401, 403, 404, 503)
- [ ] OpenAPI documentation auto-generated
- [ ] Logging messages added
- [ ] Manual testing successful (test with real employee ID and year)
- [ ] Committed with message: "Issue #XX: Create REST API endpoint for year bonus queries"
- [ ] No breaking changes to existing endpoints
