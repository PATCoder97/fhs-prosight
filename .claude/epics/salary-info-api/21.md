---
name: Enhance HRS client to return structured salary data
status: open
created: 2026-01-09T09:59:30Z
updated: 2026-01-09T10:21:38Z
github: https://github.com/PATCoder97/fhs-prosight/issues/21
depends_on: [20]
parallel: false
conflicts_with: []
---

# Task: Enhance HRS client to return structured salary data

## Description

Optimize the existing `get_salary_data()` method in FHS HRS client to return structured 3-tier response (summary + income + deductions) instead of flat 45-field dictionary. Add helper function `_parse_salary_response()` to transform raw HRS API fields into organized structure. Include field validation and calculation verification.

**Key Deliverable:** Enhanced `backend/app/integrations/fhs_hrs_client.py` with optimized salary parsing

## Acceptance Criteria

- [ ] `get_salary_data()` method enhanced to return structured response
- [ ] `_parse_salary_response(fields)` helper function created
- [ ] Response structure matches schemas from Task 001:
  - `summary`: {tong_tien_cong, tong_tien_tru, thuc_linh}
  - `income`: {32 income fields}
  - `deductions`: {10 deduction fields}
- [ ] Field validation: ensure len(fields) >= 45 before parsing
- [ ] Calculation verification: validate `tong_tien_cong - tong_tien_tru ≈ thuc_linh`
- [ ] Warning logged if calculation mismatch > 100 VND
- [ ] All 32 income fields mapped correctly from HRS response
- [ ] All 10 deduction fields mapped correctly from HRS response
- [ ] Backward compatible: same method signature `get_salary_data(emp_id, year, month)`
- [ ] UTF-8 encoding preserved for Vietnamese field names
- [ ] Error handling: return None if parsing fails

## Technical Details

### Current Implementation (User's Code)

```python
async def get_salary_data(self, emp_id: int, year: int, month: int) -> Optional[dict]:
    """Lấy bảng lương (S16). Trả về None nếu lỗi."""
    path = f"s16/VNW00{emp_id:05d}vkokv{year}-{month:02d}"
    try:
        raw_text = await self._fetch_text(path)
        fields = _first_block(raw_text).split("|")

        if len(fields) < 45:
            logger.error(f"Dữ liệu lương không đủ trường...")
            return None

        return {
            "tien_phat_thuc_te": _parse_number(fields[43]),
            "tong_so_luong": _parse_number(fields[32]),
            "luong_co_ban": _parse_number(fields[44]),
            "thuong_nang_suat": _parse_number(fields[2]),
            # ... 40+ more flat fields
        }
```

### Enhanced Implementation

**Step 1: Add Helper Function**

```python
def _parse_salary_response(fields: List[str]) -> dict:
    """
    Parse HRS salary response into structured format.

    Args:
        fields: List of pipe-delimited fields from HRS API (45+ fields)

    Returns:
        dict with structure:
        {
            "summary": {tong_tien_cong, tong_tien_tru, thuc_linh},
            "income": {32 income fields},
            "deductions": {10 deduction fields}
        }
    """
    # Parse income fields (32 fields)
    income = {
        "luong_co_ban": _parse_number(fields[44]),
        "thuong_nang_suat": _parse_number(fields[2]),
        "phu_cap_chuc_vu": _parse_number(fields[3]),
        "phu_cap_trach_nhiem": _parse_number(fields[4]),
        "phu_cap_sinh_hoat": _parse_number(fields[5]),
        "phu_cap_di_lai": _parse_number(fields[6]),
        "phu_cap_nha_o": _parse_number(fields[7]),
        "phu_cap_dien_thoai": _parse_number(fields[8]),
        "phu_cap_an_trua": _parse_number(fields[9]),
        "phu_cap_xang_xe": _parse_number(fields[10]),
        "phu_cap_doc_hai": _parse_number(fields[11]),
        "phu_cap_lam_dem": _parse_number(fields[12]),
        "phu_cap_tieng_anh": _parse_number(fields[13]),
        "phu_cap_khac": _parse_number(fields[14]),
        "luong_lam_them_150": _parse_number(fields[15]),
        "luong_lam_them_200": _parse_number(fields[16]),
        "luong_lam_them_300": _parse_number(fields[17]),
        "luong_ngay_le": _parse_number(fields[18]),
        "luong_ngay_thuong": _parse_number(fields[19]),
        "thuong_hieu_qua": _parse_number(fields[20]),
        "thuong_khac": _parse_number(fields[21]),
        "tro_cap_khac": _parse_number(fields[22]),
        "bu_luong_thang_truoc": _parse_number(fields[23]),
        "luong_nghi_phep": _parse_number(fields[24]),
        "luong_nghi_om": _parse_number(fields[25]),
        "luong_con_nho": _parse_number(fields[26]),
        "thu_nhap_khac_1": _parse_number(fields[27]),
        "thu_nhap_khac_2": _parse_number(fields[28]),
        "thu_nhap_khac_3": _parse_number(fields[29]),
        "thu_nhap_khac_4": _parse_number(fields[30]),
        "thu_nhap_khac_5": _parse_number(fields[31]),
        # Note: Adjust field indices based on actual HRS API mapping
    }

    # Parse deduction fields (10 fields)
    deductions = {
        "bhxh": _parse_number(fields[33]),
        "bhtn": _parse_number(fields[34]),
        "bhyt": _parse_number(fields[35]),
        "thue_tncn": _parse_number(fields[36]),
        "tam_ung": _parse_number(fields[37]),
        "phi_cong_doan": _parse_number(fields[38]),
        "phat": _parse_number(fields[39]),
        "khau_tru_khac_1": _parse_number(fields[40]),
        "khau_tru_khac_2": _parse_number(fields[41]),
        "khau_tru_khac_3": _parse_number(fields[42]),
    }

    # Calculate totals
    tong_tien_cong = _parse_number(fields[32])
    tong_tien_tru = sum(deductions.values())
    thuc_linh = _parse_number(fields[43])

    # Verify calculation (allow 100 VND tolerance for rounding)
    expected_net = tong_tien_cong - tong_tien_tru
    if abs(expected_net - thuc_linh) > 100:
        logger.warning(
            f"Salary calculation mismatch: "
            f"expected {expected_net:.2f} (income - deductions), "
            f"got {thuc_linh:.2f} from API. "
            f"Difference: {abs(expected_net - thuc_linh):.2f} VND"
        )

    return {
        "summary": {
            "tong_tien_cong": tong_tien_cong,
            "tong_tien_tru": tong_tien_tru,
            "thuc_linh": thuc_linh
        },
        "income": income,
        "deductions": deductions
    }
```

**Step 2: Update get_salary_data() Method**

```python
async def get_salary_data(self, emp_id: int, year: int, month: int) -> Optional[dict]:
    """
    Lấy bảng lương (S16) từ HRS API.

    Args:
        emp_id: Employee ID number (e.g., 6204)
        year: Year (e.g., 2024)
        month: Month (1-12)

    Returns:
        dict với cấu trúc:
        {
            "summary": {tong_tien_cong, tong_tien_tru, thuc_linh},
            "income": {32 income fields},
            "deductions": {10 deduction fields}
        }
        Trả về None nếu lỗi hoặc không tìm thấy dữ liệu.
    """
    path = f"s16/VNW00{emp_id:05d}vkokv{year}-{month:02d}"

    try:
        raw_text = await self._fetch_text(path)
        if not raw_text:
            logger.error(f"No salary data returned for emp_id={emp_id}, {year}-{month:02d}")
            return None

        fields = _first_block(raw_text).split("|")

        # Validate field count
        if len(fields) < 45:
            logger.error(
                f"Dữ liệu lương không đủ trường: "
                f"nhận {len(fields)} trường, cần ít nhất 45 trường. "
                f"emp_id={emp_id}, {year}-{month:02d}"
            )
            return None

        # Parse and structure the response
        structured_data = _parse_salary_response(fields)

        logger.info(
            f"Successfully fetched salary for emp_id={emp_id}, {year}-{month:02d}. "
            f"Net salary: {structured_data['summary']['thuc_linh']:,.0f} VND"
        )

        return structured_data

    except Exception as e:
        logger.error(f"Error fetching salary data: {e}", exc_info=True)
        return None
```

### Field Mapping Validation

**Important:** Verify field indices match actual HRS API response:

1. Cross-reference with user's original code (lines 150-208)
2. Test with real employee data (emp_id=6204)
3. Verify totals: tong_tien_cong - tong_tien_tru = thuc_linh
4. Check all income fields sum to tong_tien_cong
5. Check all deduction fields sum to tong_tien_tru

### Edge Cases to Handle

1. **Missing Fields:** If fields[i] is empty string, `_parse_number()` returns 0.0
2. **Extra Fields:** If len(fields) > 45, ignore extra fields
3. **Calculation Mismatch:** Log warning but still return data
4. **UTF-8 Encoding:** Ensure logger messages handle Vietnamese characters
5. **None Response:** Propagate None to service layer (handled as 404)

## Dependencies

- [x] Task 001: Schemas defined (for understanding structure)
- [x] Existing `_parse_number()` helper function
- [x] Existing `_first_block()` helper function
- [x] Existing `_fetch_text()` method

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 4-6 hours
  - 1h: Map all 45 fields to correct schema structure
  - 2h: Implement `_parse_salary_response()` function
  - 1h: Update `get_salary_data()` method
  - 1h: Test with real HRS API data
  - 1h: Verify calculations and handle edge cases
- **Parallel:** false (depends on Task 001)

## Definition of Done

- [ ] `_parse_salary_response()` function implemented
- [ ] `get_salary_data()` method returns structured response
- [ ] All 45+ fields mapped correctly
- [ ] Field validation (len >= 45) implemented
- [ ] Calculation verification implemented (tolerance 100 VND)
- [ ] Warning logged if calculation mismatch
- [ ] Error handling for missing/invalid data
- [ ] Tested with real HRS API (at least 1 employee)
- [ ] Calculation verified: income - deductions = net
- [ ] UTF-8 encoding preserved
- [ ] Code follows existing patterns in fhs_hrs_client.py
- [ ] Docstrings updated with new return structure
- [ ] Ready for use in service layer (Task 003)

## Testing Checklist

Manual testing with real HRS API:

```python
# Test with real employee
client = FHSHRSClient()
result = await client.get_salary_data(6204, 2024, 12)

# Verify structure
assert "summary" in result
assert "income" in result
assert "deductions" in result

# Verify totals
summary = result["summary"]
assert summary["tong_tien_cong"] - summary["tong_tien_tru"] == summary["thuc_linh"]

# Verify income fields
assert result["income"]["luong_co_ban"] > 0
assert result["income"]["thuong_nang_suat"] >= 0

# Verify deduction fields
assert result["deductions"]["bhxh"] > 0
```

## Related Files

**Modify:**
- `backend/app/integrations/fhs_hrs_client.py`

**Reference:**
- `backend/app/schemas/hrs_data.py` (Task 001 output)
- User's original code for field mapping

**Test With:**
- Real HRS API: emp_id=6204, year=2024, month=12
