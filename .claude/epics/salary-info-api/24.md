---
name: Add tests and documentation for salary API
status: open
created: 2026-01-09T09:59:30Z
updated: 2026-01-09T10:21:38Z
github: https://github.com/PATCoder97/fhs-prosight/issues/24
depends_on: [23]
parallel: false
conflicts_with: []
---

# Task: Add tests and documentation for salary API

## Description

Create comprehensive test suite (unit + integration tests) and documentation (API usage guide) for the salary API feature. Ensure all endpoints, service methods, and authorization logic are thoroughly tested. Provide clear examples for API consumers.

**Key Deliverables:**
- Unit tests for service layer and trend calculation
- Integration tests for all 3 API endpoints
- API usage guide with examples
- Deployment notes (no migrations needed)

## Acceptance Criteria

### Unit Tests
- [ ] File `backend/tests/test_hrs_data_service.py` created
- [ ] Test `calculate_trend()` with various scenarios:
  - Single month (no trend)
  - Multiple months with consistent salary
  - Multiple months with significant changes (>10% or >500K)
  - Edge cases (empty data, identical values)
- [ ] Test employee name lookup (found vs not found)
- [ ] Test error handling (HRS API returns None)
- [ ] Mock HRS client for predictable results
- [ ] Unit tests pass: `pytest backend/tests/test_hrs_data_service.py`

### Integration Tests
- [ ] File `backend/tests/integration/test_salary_endpoints.py` created
- [ ] Test GET /salary (own, current month) → 200 OK
- [ ] Test GET /salary (own, specific month) → 200 OK
- [ ] Test GET /salary (not authenticated) → 401 Unauthorized
- [ ] Test GET /salary (salary not found) → 404 Not Found
- [ ] Test GET /salary/history (own, full year) → 200 OK
- [ ] Test GET /salary/history (own, partial year) → 200 OK
- [ ] Test GET /salary/history (invalid month range) → 422 Validation Error
- [ ] Test GET /salary/{employee_id} (admin) → 200 OK
- [ ] Test GET /salary/{employee_id} (non-admin) → 403 Forbidden
- [ ] Test GET /salary/{employee_id} (invalid employee ID) → 400 Bad Request
- [ ] Mock HRS client responses for consistent tests
- [ ] Integration tests pass: `pytest backend/tests/integration/test_salary_endpoints.py`

### Documentation
- [ ] File `backend/docs/salary-api-guide.md` created
- [ ] Overview and authentication requirements
- [ ] Documentation for all 3 endpoints:
  - Request/response format
  - Query parameters
  - cURL examples
  - Python examples
  - Error responses
- [ ] Authorization model explained (user vs admin)
- [ ] Data structure breakdown (summary, income, deductions)
- [ ] Trend analysis explanation
- [ ] Best practices (caching recommendations, rate limiting)
- [ ] Troubleshooting guide
- [ ] Related documentation links

### Deployment Notes
- [ ] Update `backend/docs/employee-deployment.md` or create addendum
- [ ] Document: No database migrations needed (read-only feature)
- [ ] Document: New router `/api/hrs-data/` registered
- [ ] Document: Restart application service required
- [ ] Document: Verify HRS API connectivity
- [ ] Document: Health check commands

## Technical Details

### Unit Tests Structure

**File:** `backend/tests/test_hrs_data_service.py`

```python
import pytest
from unittest.mock import AsyncMock, Mock
from app.services.hrs_data_service import calculate_trend, get_employee_salary, get_salary_history

class TestCalculateTrend:
    def test_single_month_no_trend(self):
        """Test trend calculation with single month (no trend analysis)"""
        monthly_data = [
            {
                "month": 1,
                "summary": {
                    "tong_tien_cong": 15000000,
                    "tong_tien_tru": 3000000,
                    "thuc_linh": 12000000
                },
                "income": {},
                "deductions": {}
            }
        ]
        trend = calculate_trend(monthly_data)

        assert trend["average_net"] == 12000000
        assert trend["highest_month"]["month"] == 1
        assert trend["lowest_month"]["month"] == 1
        assert len(trend["significant_changes"]) == 0

    def test_multiple_months_with_significant_change(self):
        """Test trend calculation with >10% salary increase"""
        monthly_data = [
            {
                "month": 1,
                "summary": {
                    "tong_tien_cong": 15000000,
                    "tong_tien_tru": 3000000,
                    "thuc_linh": 12000000
                },
                "income": {},
                "deductions": {}
            },
            {
                "month": 2,
                "summary": {
                    "tong_tien_cong": 20000000,
                    "tong_tien_tru": 4000000,
                    "thuc_linh": 16000000
                },
                "income": {},
                "deductions": {}
            }
        ]
        trend = calculate_trend(monthly_data)

        assert trend["average_net"] == 14000000
        assert trend["highest_month"]["month"] == 2
        assert trend["lowest_month"]["month"] == 1
        assert len(trend["significant_changes"]) == 1

        change = trend["significant_changes"][0]
        assert change["from_month"] == 1
        assert change["to_month"] == 2
        assert change["change"] == 4000000
        assert change["percentage"] == pytest.approx(33.33, rel=0.01)
        assert change["direction"] == "increase"

    def test_empty_data(self):
        """Test trend calculation with no data"""
        trend = calculate_trend([])
        assert trend is None

    def test_identical_salary_no_significant_changes(self):
        """Test trend with consistent salary (no significant changes)"""
        monthly_data = [
            {
                "month": i,
                "summary": {
                    "tong_tien_cong": 15000000,
                    "tong_tien_tru": 3000000,
                    "thuc_linh": 12000000
                },
                "income": {},
                "deductions": {}
            }
            for i in range(1, 13)
        ]
        trend = calculate_trend(monthly_data)

        assert trend["average_net"] == 12000000
        assert len(trend["significant_changes"]) == 0

    def test_large_absolute_change_small_percentage(self):
        """Test 600K change (>500K) but <10% triggers significant change"""
        monthly_data = [
            {
                "month": 1,
                "summary": {"tong_tien_cong": 10000000, "tong_tien_tru": 2000000, "thuc_linh": 8000000},
                "income": {},
                "deductions": {}
            },
            {
                "month": 2,
                "summary": {"tong_tien_cong": 10600000, "tong_tien_tru": 2000000, "thuc_linh": 8600000},
                "income": {},
                "deductions": {}
            }
        ]
        trend = calculate_trend(monthly_data)

        # 600K change is 7.5% (< 10%) but > 500K threshold
        assert len(trend["significant_changes"]) == 1


@pytest.mark.asyncio
class TestGetEmployeeSalary:
    async def test_successful_salary_fetch(self, mock_db, mock_hrs_client):
        """Test successful salary retrieval with employee name"""
        # Mock HRS client response
        mock_hrs_client.get_salary_data.return_value = {
            "summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000},
            "income": {"luong_co_ban": 10000000},
            "deductions": {"bhxh": 1500000}
        }

        # Mock database employee lookup
        mock_employee = Mock()
        mock_employee.name_en = "PHAN ANH TUẤN"
        mock_db.get.return_value = mock_employee

        # Call service
        result = await get_employee_salary(mock_db, "VNW0006204", 2024, 12)

        assert result["employee_id"] == "VNW0006204"
        assert result["employee_name"] == "PHAN ANH TUẤN"
        assert result["period"]["year"] == 2024
        assert result["period"]["month"] == 12
        assert result["summary"]["thuc_linh"] == 12000000

    async def test_employee_not_in_database(self, mock_db, mock_hrs_client):
        """Test salary fetch when employee not in database"""
        mock_hrs_client.get_salary_data.return_value = {
            "summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000},
            "income": {},
            "deductions": {}
        }
        mock_db.get.return_value = None  # Employee not found

        result = await get_employee_salary(mock_db, "VNW0099999", 2024, 12)

        assert result["employee_name"] == "Unknown"

    async def test_hrs_api_returns_none(self, mock_db, mock_hrs_client):
        """Test error when HRS API returns None (404)"""
        mock_hrs_client.get_salary_data.return_value = None

        with pytest.raises(HTTPException) as exc_info:
            await get_employee_salary(mock_db, "VNW0006204", 1990, 1)

        assert exc_info.value.status_code == 404
        assert "Salary not found" in exc_info.value.detail
```

### Integration Tests Structure

**File:** `backend/tests/integration/test_salary_endpoints.py`

```python
import pytest
from httpx import AsyncClient
from unittest.mock import patch, AsyncMock

@pytest.mark.asyncio
class TestSalaryEndpoints:

    async def test_get_own_salary_success(self, client: AsyncClient, user_token: str):
        """Test GET /salary returns own salary"""
        with patch("app.integrations.fhs_hrs_client.FHSHRSClient.get_salary_data") as mock:
            mock.return_value = {
                "summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000},
                "income": {"luong_co_ban": 10000000},
                "deductions": {"bhxh": 1500000}
            }

            response = await client.get(
                "/api/hrs-data/salary?year=2024&month=12",
                headers={"Authorization": f"Bearer {user_token}"}
            )

            assert response.status_code == 200
            data = response.json()
            assert data["employee_id"] == "VNW0006204"
            assert data["period"]["year"] == 2024
            assert data["summary"]["thuc_linh"] == 12000000

    async def test_get_salary_unauthenticated(self, client: AsyncClient):
        """Test GET /salary without authentication returns 401"""
        response = await client.get("/api/hrs-data/salary")
        assert response.status_code == 401

    async def test_get_salary_not_found(self, client: AsyncClient, user_token: str):
        """Test GET /salary returns 404 when salary not found"""
        with patch("app.integrations.fhs_hrs_client.FHSHRSClient.get_salary_data") as mock:
            mock.return_value = None

            response = await client.get(
                "/api/hrs-data/salary?year=1990&month=1",
                headers={"Authorization": f"Bearer {user_token}"}
            )

            assert response.status_code == 404
            assert "not found" in response.json()["detail"].lower()

    async def test_get_salary_history_success(self, client: AsyncClient, user_token: str):
        """Test GET /salary/history returns history with trend"""
        with patch("app.integrations.fhs_hrs_client.FHSHRSClient.get_salary_data") as mock:
            # Return 3 months of data
            mock.side_effect = [
                {"summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000}, "income": {}, "deductions": {}},
                {"summary": {"tong_tien_cong": 16000000, "tong_tien_tru": 3200000, "thuc_linh": 12800000}, "income": {}, "deductions": {}},
                {"summary": {"tong_tien_cong": 15500000, "tong_tien_tru": 3100000, "thuc_linh": 12400000}, "income": {}, "deductions": {}},
            ]

            response = await client.get(
                "/api/hrs-data/salary/history?year=2024&from_month=1&to_month=3",
                headers={"Authorization": f"Bearer {user_token}"}
            )

            assert response.status_code == 200
            data = response.json()
            assert len(data["months"]) == 3
            assert "trend" in data
            assert data["trend"]["average_net"] == pytest.approx(12400000)

    async def test_get_salary_history_invalid_range(self, client: AsyncClient, user_token: str):
        """Test GET /salary/history with invalid month range returns 422"""
        response = await client.get(
            "/api/hrs-data/salary/history?year=2024&from_month=6&to_month=3",
            headers={"Authorization": f"Bearer {user_token}"}
        )

        assert response.status_code == 422
        assert "Invalid month range" in response.json()["detail"]

    async def test_get_employee_salary_admin_success(self, client: AsyncClient, admin_token: str):
        """Test GET /salary/{employee_id} as admin returns salary"""
        with patch("app.integrations.fhs_hrs_client.FHSHRSClient.get_salary_data") as mock:
            mock.return_value = {
                "summary": {"tong_tien_cong": 20000000, "tong_tien_tru": 4000000, "thuc_linh": 16000000},
                "income": {},
                "deductions": {}
            }

            response = await client.get(
                "/api/hrs-data/salary/VNW0009999?year=2024&month=12",
                headers={"Authorization": f"Bearer {admin_token}"}
            )

            assert response.status_code == 200
            data = response.json()
            assert data["employee_id"] == "VNW0009999"

    async def test_get_employee_salary_non_admin_forbidden(self, client: AsyncClient, user_token: str):
        """Test GET /salary/{employee_id} as non-admin returns 403"""
        response = await client.get(
            "/api/hrs-data/salary/VNW0009999?year=2024&month=12",
            headers={"Authorization": f"Bearer {user_token}"}
        )

        assert response.status_code == 403
        assert "admin" in response.json()["detail"].lower()

    async def test_get_employee_salary_invalid_id(self, client: AsyncClient, admin_token: str):
        """Test GET /salary/{employee_id} with invalid ID returns 400"""
        response = await client.get(
            "/api/hrs-data/salary/INVALID123?year=2024&month=12",
            headers={"Authorization": f"Bearer {admin_token}"}
        )

        assert response.status_code == 400
        assert "Invalid employee ID" in response.json()["detail"]
```

### Documentation Structure

**File:** `backend/docs/salary-api-guide.md`

```markdown
# Salary API Usage Guide

## Overview

The Salary API provides read-only access to employee salary information from the FHS HRS system. Employees can view their own salary data, while administrators can view any employee's salary.

**Base URL:** `/api/hrs-data/`

**Features:**
- View current or specific month salary
- View salary history with trend analysis (multiple months)
- Admin: view any employee's salary
- Structured response: summary + income breakdown + deduction breakdown
- Real-time data (no caching, queries HRS API directly)

## Authentication

All endpoints require JWT authentication. Include your token in the Authorization header:

```bash
Authorization: Bearer {your_jwt_token}
```

**Roles:**
- **User:** Can view only their own salary
- **Admin:** Can view any employee's salary

## Endpoints

### 1. GET /api/hrs-data/salary

View your own salary for current month or specific month.

**Authorization:** User (any role)

**Query Parameters:**
- `year` (optional): Year (2000-2100), defaults to current year
- `month` (optional): Month (1-12), defaults to current month

**Response:** SalaryResponse (200 OK)

**cURL Example:**
```bash
# Current month
curl -X GET "http://localhost:8000/api/hrs-data/salary" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Specific month
curl -X GET "http://localhost:8000/api/hrs-data/salary?year=2024&month=12" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Python Example:**
```python
import httpx

async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/api/hrs-data/salary",
        params={"year": 2024, "month": 12},
        headers={"Authorization": f"Bearer {token}"}
    )
    salary = response.json()
    print(f"Net salary: {salary['summary']['thuc_linh']:,} VND")
```

**Response Example:**
```json
{
  "employee_id": "VNW0006204",
  "employee_name": "PHAN ANH TUẤN",
  "period": {"year": 2024, "month": 12},
  "summary": {
    "tong_tien_cong": 15000000,
    "tong_tien_tru": 3331510,
    "thuc_linh": 11668490
  },
  "income": {
    "luong_co_ban": 7205600,
    "thuong_nang_suat": 2000000,
    "phu_cap_chuc_vu": 1500000,
    ...
  },
  "deductions": {
    "bhxh": 1080840,
    "bhyt": 144112,
    "bhtn": 72056,
    ...
  }
}
```

### 2. GET /api/hrs-data/salary/history

View your salary history with trend analysis.

**Authorization:** User (any role)

**Query Parameters:**
- `year` (required): Year
- `from_month` (optional): Start month (1-12), default 1
- `to_month` (optional): End month (1-12), default 12

**Response:** SalaryHistoryResponse (200 OK)

**cURL Example:**
```bash
# Full year
curl -X GET "http://localhost:8000/api/hrs-data/salary/history?year=2024" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Partial year (Jan-Jun)
curl -X GET "http://localhost:8000/api/hrs-data/salary/history?year=2024&from_month=1&to_month=6" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response Example:**
```json
{
  "employee_id": "VNW0006204",
  "employee_name": "PHAN ANH TUẤN",
  "period": {"year": 2024, "month": "1-12"},
  "months": [
    {
      "month": 1,
      "summary": {"tong_tien_cong": 15000000, "tong_tien_tru": 3000000, "thuc_linh": 12000000},
      "income": {...},
      "deductions": {...}
    },
    ...
  ],
  "trend": {
    "average_income": 15500000,
    "average_deductions": 3100000,
    "average_net": 12400000,
    "highest_month": {...},
    "lowest_month": {...},
    "significant_changes": [
      {
        "from_month": 3,
        "to_month": 4,
        "field": "thuc_linh",
        "change": 2000000,
        "percentage": 16.67,
        "direction": "increase"
      }
    ]
  }
}
```

### 3. GET /api/hrs-data/salary/{employee_id}

**Admin only:** View any employee's salary.

**Authorization:** Admin

**Path Parameters:**
- `employee_id`: Employee ID (e.g., VNW0006204)

**Query Parameters:**
- `year` (required): Year
- `month` (required): Month (1-12)

**Response:** SalaryResponse (200 OK)

**cURL Example:**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/VNW0006204?year=2024&month=12" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

## Data Structure

### Summary
- `tong_tien_cong`: Total income (sum of all income fields)
- `tong_tien_tru`: Total deductions (sum of all deduction fields)
- `thuc_linh`: Net salary (tong_tien_cong - tong_tien_tru)

### Income (32 fields)
Basic salary, bonuses, allowances, overtime, and other income components.

### Deductions (10 fields)
Social insurance, health insurance, unemployment insurance, taxes, and other deductions.

## Error Handling

| Status | Error | Description |
|--------|-------|-------------|
| 400 | Bad Request | Invalid employee ID format |
| 401 | Unauthorized | Missing or invalid JWT token |
| 403 | Forbidden | User trying to access admin-only endpoint |
| 404 | Not Found | Salary not found for specified period |
| 422 | Validation Error | Invalid month range or parameters |
| 503 | Service Unavailable | HRS API unavailable |

## Best Practices

1. **Cache Responses:** Salary data changes monthly, consider caching for 1 hour
2. **Error Handling:** Always handle 404 (salary not available for old periods)
3. **Parallel Queries:** For multi-month queries, use history endpoint (optimized)
4. **Rate Limiting:** Be mindful of HRS API load, avoid excessive queries

## Troubleshooting

**Q: Getting 404 for old months?**
A: HRS API may not retain salary data beyond certain period. Check with HR.

**Q: Calculation doesn't match (tong_tien_cong - tong_tien_tru ≠ thuc_linh)?**
A: Small differences (<100 VND) are acceptable due to rounding. Check logs for warnings.

**Q: Getting 503 errors?**
A: HRS API may be temporarily unavailable. Wait and retry.
```

## Dependencies

- [x] Task 004: API endpoints implemented
- [x] pytest framework (already installed)
- [x] httpx for async HTTP testing
- [x] Mocking libraries (unittest.mock)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
  - 2h: Write unit tests (service layer)
  - 2h: Write integration tests (API endpoints)
  - 2h: Write API usage guide documentation
  - 0.5h: Update deployment documentation
  - 1h: Run all tests, fix issues
  - 0.5h: Review and polish documentation
- **Parallel:** false (depends on Task 004)

## Definition of Done

- [ ] Unit tests created and passing
- [ ] Integration tests created and passing
- [ ] Test coverage > 80% for service layer
- [ ] All 3 endpoints tested with auth/error cases
- [ ] API usage guide complete with examples
- [ ] Deployment notes updated
- [ ] All tests pass: `pytest backend/tests`
- [ ] Documentation reviewed for clarity
- [ ] Code follows existing test patterns
- [ ] Ready for deployment

## Related Files

**Create:**
- `backend/tests/test_hrs_data_service.py`
- `backend/tests/integration/test_salary_endpoints.py`
- `backend/docs/salary-api-guide.md`

**Update:**
- `backend/docs/employee-deployment.md` (add salary API deployment notes)

**Reference:**
- `backend/tests/test_date_utils.py` (unit test patterns)
- `backend/tests/integration/test_employee_endpoints.py` (integration test patterns)
- `backend/docs/employee-api-guide.md` (documentation format)
