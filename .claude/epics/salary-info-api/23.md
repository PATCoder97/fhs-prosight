---
name: Create REST API endpoints for salary queries
status: open
created: 2026-01-09T09:59:30Z
updated: 2026-01-09T10:21:38Z
github: https://github.com/PATCoder97/fhs-prosight/issues/23
depends_on: [22]
parallel: false
conflicts_with: []
---

# Task: Create REST API endpoints for salary queries

## Description

Create new API router `/api/hrs-data/` with 3 endpoints for salary queries. Implement authorization (users view own salary, admins view any employee's salary), input validation, error handling, and OpenAPI documentation. Register router in main application.

**Key Deliverable:** `backend/app/routers/hrs_data.py` with 3 REST endpoints

## Acceptance Criteria

- [ ] File `backend/app/routers/hrs_data.py` created
- [ ] Router prefix: `/hrs-data`, tags: `["hrs-data"]`
- [ ] Endpoint 1: `GET /salary` - View own salary (authenticated user)
- [ ] Endpoint 2: `GET /salary/history` - View salary history with trend (authenticated user)
- [ ] Endpoint 3: `GET /salary/{employee_id}` - Admin view any employee's salary
- [ ] Authorization implemented:
  - Endpoints 1-2: require authentication (`get_current_user`)
  - Endpoint 3: require admin role (`require_role("admin")`)
- [ ] Input validation with Query parameters (year, month, from_month, to_month)
- [ ] Default to current year/month if not provided (Endpoint 1)
- [ ] Response models match Pydantic schemas (SalaryResponse, SalaryHistoryResponse)
- [ ] Error handling: 400, 404, 422, 503 with descriptive messages
- [ ] OpenAPI documentation with descriptions and examples
- [ ] Router registered in `main.py`
- [ ] CORS headers configured (if needed)

## Technical Details

### Router Setup

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime

from app.schemas.hrs_data import SalaryResponse, SalaryHistoryResponse
from app.services import hrs_data_service
from app.core.database import get_db
from app.core.security import get_current_user, require_role
from app.core.logging import get_logger

logger = get_logger(__name__)

router = APIRouter(
    prefix="/hrs-data",
    tags=["hrs-data"]
)
```

### Endpoint 1: GET /salary (Own Salary)

```python
@router.get(
    "/salary",
    response_model=SalaryResponse,
    summary="Get own salary",
    description="Get current user's salary for specific month (default: current month)"
)
async def get_own_salary(
    year: int = Query(None, ge=2000, le=2100, description="Year (default: current year)"),
    month: int = Query(None, ge=1, le=12, description="Month (default: current month)"),
    current_user: dict = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Get current user's salary for specific month.

    **Access:** Authenticated users (any role)

    **Query Parameters:**
    - year: Year (2000-2100), default to current year
    - month: Month (1-12), default to current month

    **Response:**
    - 200: Salary data returned
    - 404: Salary not found for specified month
    - 503: HRS API unavailable

    **Example:**
    ```
    GET /api/hrs-data/salary?year=2024&month=12
    ```
    """
    emp_id = current_user["localId"]

    # Default to current year/month
    if year is None or month is None:
        now = datetime.now()
        year = year or now.year
        month = month or now.month

    logger.info(f"User {emp_id} querying own salary: {year}-{month:02d}")

    try:
        salary = await hrs_data_service.get_employee_salary(
            db, emp_id, year, month
        )
        return salary
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Unexpected error getting salary: {e}", exc_info=True)
        raise HTTPException(
            status_code=503,
            detail="Failed to retrieve salary data. Please try again later."
        )
```

### Endpoint 2: GET /salary/history (Own History)

```python
@router.get(
    "/salary/history",
    response_model=SalaryHistoryResponse,
    summary="Get salary history with trend",
    description="Get current user's salary history for specified month range with trend analysis"
)
async def get_salary_history(
    year: int = Query(..., ge=2000, le=2100, description="Year"),
    from_month: int = Query(1, ge=1, le=12, description="Start month (default: 1)"),
    to_month: int = Query(12, ge=1, le=12, description="End month (default: 12)"),
    current_user: dict = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Get current user's salary history with trend analysis.

    **Access:** Authenticated users (any role)

    **Query Parameters:**
    - year: Year (required)
    - from_month: Start month (1-12), default 1
    - to_month: End month (1-12), default 12

    **Response:**
    - 200: Salary history with trend analysis
    - 404: No salary data found for any month in range
    - 422: Invalid month range (from_month > to_month)
    - 503: HRS API unavailable

    **Example:**
    ```
    GET /api/hrs-data/salary/history?year=2024&from_month=1&to_month=12
    ```
    """
    emp_id = current_user["localId"]

    logger.info(
        f"User {emp_id} querying salary history: "
        f"{year}-{from_month:02d} to {year}-{to_month:02d}"
    )

    try:
        history = await hrs_data_service.get_salary_history(
            db, emp_id, year, from_month, to_month
        )
        return history
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Unexpected error getting salary history: {e}", exc_info=True)
        raise HTTPException(
            status_code=503,
            detail="Failed to retrieve salary history. Please try again later."
        )
```

### Endpoint 3: GET /salary/{employee_id} (Admin)

```python
@router.get(
    "/salary/{employee_id}",
    response_model=SalaryResponse,
    summary="Get employee salary (admin)",
    description="Admin: Get any employee's salary for specific month"
)
async def get_employee_salary_admin(
    employee_id: str,
    year: int = Query(..., ge=2000, le=2100, description="Year"),
    month: int = Query(..., ge=1, le=12, description="Month"),
    current_user: dict = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """
    Admin: Get any employee's salary for specific month.

    **Access:** Admin only

    **Path Parameters:**
    - employee_id: Employee ID (e.g., VNW0006204)

    **Query Parameters:**
    - year: Year (required)
    - month: Month (1-12, required)

    **Response:**
    - 200: Salary data returned
    - 400: Invalid employee ID format
    - 403: Forbidden (not admin)
    - 404: Salary not found or employee doesn't exist
    - 503: HRS API unavailable

    **Example:**
    ```
    GET /api/hrs-data/salary/VNW0006204?year=2024&month=12
    ```
    """
    logger.info(
        f"Admin {current_user['localId']} querying salary for {employee_id}: "
        f"{year}-{month:02d}"
    )

    try:
        salary = await hrs_data_service.get_employee_salary(
            db, employee_id, year, month
        )
        return salary
    except HTTPException:
        raise
    except Exception as e:
        logger.error(
            f"Unexpected error getting employee {employee_id} salary: {e}",
            exc_info=True
        )
        raise HTTPException(
            status_code=503,
            detail="Failed to retrieve salary data. Please try again later."
        )
```

### Register Router in main.py

Add to `backend/app/main.py`:

```python
from app.routers import hrs_data

# Register routers
app.include_router(employees.router, prefix="/api")
app.include_router(hrs_data.router, prefix="/api")  # <-- Add this line
```

### OpenAPI Examples

Add example responses to schemas (if not done in Task 001):

```python
# In schemas/hrs_data.py
class SalaryResponse(BaseModel):
    # ... fields ...

    class Config:
        json_schema_extra = {
            "example": {
                "employee_id": "VNW0006204",
                "employee_name": "PHAN ANH TUẤN",
                "period": {"year": 2024, "month": 12},
                "summary": {
                    "tong_tien_cong": 15000000,
                    "tong_tien_tru": 3331510,
                    "thuc_linh": 11668490
                },
                "income": {
                    "luong_co_ban": 7205600,
                    "thuong_nang_suat": 2000000,
                    # ... (abbreviated)
                },
                "deductions": {
                    "bhxh": 1080840,
                    "bhyt": 144112,
                    # ... (abbreviated)
                }
            }
        }
```

### Error Response Format

All errors return consistent format:

```json
{
  "detail": "Descriptive error message"
}
```

**Common Error Responses:**

| Status | Scenario | Detail Message |
|--------|----------|----------------|
| 400 | Invalid employee ID | "Invalid employee ID format: XYZ" |
| 403 | Non-admin accessing admin endpoint | "Admin role required" |
| 404 | Salary not found | "Salary not found for employee VNW0006204 in 2024-12" |
| 404 | No history data | "No salary data found for employee VNW0006204 in 2024" |
| 422 | Invalid month range | "Invalid month range: from_month (6) > to_month (3)" |
| 422 | Month out of range | "Month must be between 1-12: month=15" |
| 503 | HRS API down | "HRS API unavailable. Please try again later." |
| 503 | Unexpected error | "Failed to retrieve salary data. Please try again later." |

### Authorization Testing

Test matrix:

| Endpoint | User Role | Own Salary | Other Salary | Expected |
|----------|-----------|------------|--------------|----------|
| GET /salary | user | ✅ | N/A | 200 OK |
| GET /salary/history | user | ✅ | N/A | 200 OK |
| GET /salary/{id} | user | ✅ | ❌ | 403 Forbidden |
| GET /salary/{id} | admin | ✅ | ✅ | 200 OK |

## Dependencies

- [x] Task 003: Service layer implemented
- [x] Existing `get_current_user()` dependency
- [x] Existing `require_role()` dependency
- [x] Database session `get_db()`
- [x] Pydantic schemas from Task 001

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 4-6 hours
  - 1h: Create router file and setup
  - 1h: Implement Endpoint 1 (GET /salary)
  - 1h: Implement Endpoint 2 (GET /salary/history)
  - 1h: Implement Endpoint 3 (GET /salary/{employee_id})
  - 0.5h: Register router in main.py
  - 0.5h: Add OpenAPI documentation and examples
  - 1h: Testing all endpoints with Postman/cURL
- **Parallel:** false (depends on Task 003)

## Definition of Done

- [ ] Router file created with 3 endpoints
- [ ] Authorization implemented correctly
- [ ] Input validation with Query parameters
- [ ] Default year/month to current values (Endpoint 1)
- [ ] Error handling for all failure cases
- [ ] OpenAPI documentation complete
- [ ] Response models match Pydantic schemas
- [ ] Router registered in main.py
- [ ] Tested with authenticated user (own salary)
- [ ] Tested with admin user (other employee's salary)
- [ ] Tested error cases (404, 422, 503)
- [ ] Code follows existing router patterns
- [ ] Ready for integration tests (Task 005)

## Testing Checklist

### Manual Testing with cURL

**1. Test GET /salary (own, current month):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary" \
  -H "Authorization: Bearer USER_TOKEN"
```

**2. Test GET /salary (own, specific month):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary?year=2024&month=12" \
  -H "Authorization: Bearer USER_TOKEN"
```

**3. Test GET /salary/history (own, full year):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/history?year=2024" \
  -H "Authorization: Bearer USER_TOKEN"
```

**4. Test GET /salary/history (own, partial year):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/history?year=2024&from_month=6&to_month=12" \
  -H "Authorization: Bearer USER_TOKEN"
```

**5. Test GET /salary/{employee_id} (admin):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/VNW0006204?year=2024&month=12" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

**6. Test authorization (user accessing admin endpoint):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/VNW0009999?year=2024&month=12" \
  -H "Authorization: Bearer USER_TOKEN"
# Expected: 403 Forbidden
```

**7. Test error handling (invalid month range):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary/history?year=2024&from_month=6&to_month=3" \
  -H "Authorization: Bearer USER_TOKEN"
# Expected: 422 Validation Error
```

**8. Test error handling (salary not found):**
```bash
curl -X GET "http://localhost:8000/api/hrs-data/salary?year=1990&month=1" \
  -H "Authorization: Bearer USER_TOKEN"
# Expected: 404 Not Found
```

### OpenAPI Docs

**Verify in browser:**
- Navigate to: http://localhost:8000/docs
- Verify all 3 endpoints visible under "hrs-data" tag
- Verify descriptions and examples display correctly
- Test "Try it out" functionality

## Related Files

**Create:**
- `backend/app/routers/hrs_data.py`

**Modify:**
- `backend/app/main.py` (register router)

**Reference:**
- `backend/app/services/hrs_data_service.py` (Task 003 output)
- `backend/app/schemas/hrs_data.py` (Task 001 output)
- `backend/app/routers/employees.py` (pattern reference)
- `backend/app/core/security.py` (authorization dependencies)
