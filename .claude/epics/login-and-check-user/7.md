---
name: Viết unit tests cho auth flow và JWT changes
status: closed
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T11:45:00Z
completed: 2026-01-08T11:45:00Z
github: https://github.com/PATCoder97/fhs-prosight/issues/7
depends_on: [6]
parallel: true
conflicts_with: []
---

# Task: Viết unit tests cho auth flow và JWT changes

## Description

Viết comprehensive unit tests để cover:
1. `get_or_create_user()` function với localId support
2. JWT token creation/validation với localId và oauth_provider
3. Admin endpoints (assign localId, update role, list users)
4. Role checking và authorization
5. Input validation

Target: > 80% test coverage cho auth-related code.

## Acceptance Criteria

- [ ] Test file `tests/test_auth_service.py` created
- [ ] Test file `tests/test_jwt_handler.py` created
- [ ] Test file `tests/test_admin_endpoints.py` created
- [ ] Test coverage > 80% cho auth service
- [ ] Test coverage > 80% cho JWT handler
- [ ] Test coverage > 80% cho admin endpoints
- [ ] All tests pass
- [ ] Tests chạy được với `pytest`
- [ ] Mock database và OAuth APIs properly

## Technical Details

### Test File 1: `tests/test_auth_service.py`

```python
import pytest
from app.services.auth_service import get_or_create_user
from app.models import User

@pytest.mark.asyncio
async def test_create_new_user():
    """Test creating new user with default role='guest' and localId=None"""
    user_data = await get_or_create_user(
        social_id="12345",
        provider="google",
        email="test@example.com",
        full_name="Test User",
        avatar="https://avatar.url"
    )

    assert user_data["role"] == "guest"
    assert user_data["localId"] is None
    assert user_data["provider"] == "google"
    assert user_data["email"] == "test@example.com"


@pytest.mark.asyncio
async def test_get_existing_user_with_localId():
    """Test getting existing user preserves localId and role"""
    # Setup: Create user với localId='VNW001', role='user'
    # ...

    user_data = await get_or_create_user(
        social_id="12345",
        provider="google",
        email="test@example.com",
        full_name="Test User",
        avatar="https://avatar.url"
    )

    assert user_data["localId"] == "VNW001"
    assert user_data["role"] == "user"  # Not 'guest'


@pytest.mark.asyncio
async def test_get_existing_user_without_localId():
    """Test existing user without localId returns None"""
    # Setup: Create user without localId
    # ...

    user_data = await get_or_create_user(
        social_id="67890",
        provider="github",
        email="user@example.com",
        full_name="User",
        avatar="https://avatar.url"
    )

    assert user_data["localId"] is None
    assert user_data["role"] == "user"  # Keeps existing role
```

### Test File 2: `tests/test_jwt_handler.py`

```python
import pytest
from app.core.jwt_handler import create_access_token, verify_token

def test_create_token_with_localId():
    """Test JWT token includes localId and oauth_provider"""
    token = create_access_token(
        user_id="123",
        full_name="Test User",
        role="user",
        localId="VNW001",
        provider="google"
    )

    payload = verify_token(token, required_scope="access")

    assert payload is not None
    assert payload["user_id"] == "123"
    assert payload["role"] == "user"
    assert payload["localId"] == "VNW001"
    assert payload["oauth_provider"] == "google"


def test_create_token_without_localId():
    """Test JWT token works without localId (backward compatible)"""
    token = create_access_token(
        user_id="123",
        full_name="Test User",
        role="guest"
    )

    payload = verify_token(token, required_scope="access")

    assert payload is not None
    assert payload["user_id"] == "123"
    assert payload["role"] == "guest"
    assert payload["localId"] is None
    assert payload["oauth_provider"] is None


def test_verify_old_token():
    """Test old tokens without localId still verify successfully"""
    # Create token using old format (manually)
    import jwt
    from datetime import datetime, timedelta

    old_payload = {
        "user_id": "123",
        "full_name": "Old User",
        "role": "user",
        "scope": "access",
        "exp": int((datetime.utcnow() + timedelta(hours=1)).timestamp()),
        "iat": int(datetime.utcnow().timestamp()),
    }

    old_token = jwt.encode(old_payload, SECRET_KEY, algorithm="HS256")

    # Verify it still works
    payload = verify_token(old_token, required_scope="access")

    assert payload is not None
    assert payload["user_id"] == "123"
    assert payload["localId"] is None  # Should be set to None
    assert payload["oauth_provider"] is None


def test_token_expiration():
    """Test expired token returns None"""
    # Create token với expiration trong quá khứ
    # ...
    payload = verify_token(expired_token, required_scope="access")
    assert payload is None
```

### Test File 3: `tests/test_admin_endpoints.py`

```python
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_assign_localId_as_admin():
    """Test admin can assign localId"""
    # Login as admin, get token
    admin_token = "..."  # Get from auth

    response = client.put(
        "/users/123/localId",
        json={"localId": "VNW001"},
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 200
    assert response.json()["success"] is True
    assert response.json()["user"]["localId"] == "VNW001"


def test_assign_localId_as_non_admin():
    """Test non-admin cannot assign localId"""
    # Login as regular user
    user_token = "..."

    response = client.put(
        "/users/123/localId",
        json={"localId": "VNW001"},
        headers={"Authorization": f"Bearer {user_token}"}
    )

    assert response.status_code == 403
    assert "admin" in response.json()["detail"].lower()


def test_update_role_as_admin():
    """Test admin can update user role"""
    admin_token = "..."

    response = client.put(
        "/users/123/role",
        json={"role": "user"},
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 200
    assert response.json()["user"]["role"] == "user"


def test_update_role_invalid_value():
    """Test role validation rejects invalid values"""
    admin_token = "..."

    response = client.put(
        "/users/123/role",
        json={"role": "superadmin"},  # Invalid
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 422  # Validation error


def test_list_users_as_admin():
    """Test admin can list users"""
    admin_token = "..."

    response = client.get(
        "/users",
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 200
    assert "users" in response.json()
    assert "total" in response.json()


def test_list_users_with_filters():
    """Test filtering users by localId"""
    admin_token = "..."

    response = client.get(
        "/users?localId=VNW001",
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 200
    users = response.json()["users"]
    assert all(u["localId"] == "VNW001" for u in users)
```

### Test Configuration

**`tests/conftest.py`** - Shared fixtures:

```python
import pytest
from app.database.session import AsyncSessionLocal
from app.models import User, Base
from sqlalchemy.ext.asyncio import create_async_engine

@pytest.fixture
async def test_db():
    """Create test database"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    yield engine

    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)


@pytest.fixture
async def admin_user(test_db):
    """Create admin user for testing"""
    async with AsyncSessionLocal() as db:
        admin = User(
            social_id="admin123",
            provider="google",
            email="admin@example.com",
            full_name="Admin User",
            role="admin",
            localId="ADM001"
        )
        db.add(admin)
        await db.commit()
        await db.refresh(admin)
        return admin


@pytest.fixture
def admin_token(admin_user):
    """Generate JWT token for admin"""
    from app.core.jwt_handler import create_access_token
    return create_access_token(
        user_id=str(admin_user.id),
        full_name=admin_user.full_name,
        role=admin_user.role,
        localId=admin_user.localId,
        provider=admin_user.provider
    )
```

### Key Test Cases

**Auth Service:**
- ✅ New user → role='guest', localId=None
- ✅ Existing user → preserve role và localId
- ✅ Update last_login timestamp

**JWT Handler:**
- ✅ Token with localId
- ✅ Token without localId
- ✅ Old tokens still valid
- ✅ Token expiration
- ✅ Invalid token

**Admin Endpoints:**
- ✅ Admin can assign localId
- ✅ Admin can update role
- ✅ Admin can list users
- ✅ Non-admin gets 403
- ✅ Input validation works
- ✅ Filters work correctly

## Dependencies

- [x] Task 005 completed (admin endpoints implemented)
- [ ] pytest installed
- [ ] pytest-asyncio installed
- [ ] Test database setup (SQLite in-memory)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 5-6 hours
  - 2h: Auth service tests
  - 1.5h: JWT handler tests
  - 2h: Admin endpoints tests
  - 0.5h: Setup test fixtures và config
- **Parallel:** true (không conflict với tasks khác)

## Definition of Done

- [ ] All test files created
- [ ] Test coverage > 80%
- [ ] All tests pass với `pytest`
- [ ] Tests có clear descriptions
- [ ] Mock dependencies properly
- [ ] Test fixtures reusable
- [ ] CI/CD ready (nếu có)
- [ ] Documentation về cách chạy tests
