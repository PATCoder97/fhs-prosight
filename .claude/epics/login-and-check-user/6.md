---
name: Thêm admin endpoints - assign localId, update role, list users
status: open
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T02:35:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/6
depends_on: [5]
parallel: true
conflicts_with: []
---

# Task: Thêm admin endpoints - assign localId, update role, list users

## Description

Tạo protected admin endpoints để quản lý users:
1. `PUT /users/{user_id}/localId` - Admin assign/update localId cho user
2. `PUT /users/{user_id}/role` - Admin thay đổi role của user
3. `GET /users` - Admin list users với filters (localId, provider, email)

Tất cả endpoints require role = "admin" và có input validation.

## Acceptance Criteria

- [ ] Endpoint `PUT /users/{user_id}/localId` created
- [ ] Endpoint `PUT /users/{user_id}/role` created
- [ ] Endpoint `GET /users` created
- [ ] Tất cả endpoints có decorator `@require_roles(["admin"])`
- [ ] Non-admin users nhận 403 Forbidden khi access
- [ ] Input validation: localId format (alphanumeric, max 50 chars)
- [ ] Input validation: role chỉ accept ["guest", "user", "admin"]
- [ ] Endpoints return proper error messages khi validation fails
- [ ] List users có pagination (limit, offset)
- [ ] List users có filters: localId, provider, email

## Technical Details

### File to Modify

**`backend/app/routers/users.py`**

### Endpoint 1: Assign LocalId

```python
from fastapi import APIRouter, Depends, HTTPException, status
from app.core.security import get_current_user
from app.core.permissions import require_roles
from app.models import User
from app.database.session import AsyncSessionLocal
from sqlalchemy import select
from pydantic import BaseModel, Field
import re

router = APIRouter(prefix="/users", tags=["users"])

class AssignLocalIdRequest(BaseModel):
    localId: str = Field(..., min_length=1, max_length=50)

    @validator('localId')
    def validate_localId(cls, v):
        # Only alphanumeric characters allowed
        if not re.match(r'^[A-Za-z0-9]+$', v):
            raise ValueError('localId must be alphanumeric')
        return v


@router.put("/{user_id}/localId")
async def assign_local_id(
    user_id: int,
    request: AssignLocalIdRequest,
    current_user: dict = Depends(get_current_user)
):
    """
    Admin assigns or updates localId for a user

    Requires: role = 'admin'
    """
    # Check admin permission
    if current_user.get("role") != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Only admins can assign localId"
        )

    async with AsyncSessionLocal() as db:
        # Get user
        stmt = select(User).where(User.id == user_id)
        result = await db.execute(stmt)
        user = result.scalars().first()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User {user_id} not found"
            )

        # Update localId
        user.localId = request.localId
        await db.commit()
        await db.refresh(user)

        return {
            "success": True,
            "message": f"LocalId assigned to user {user.email}",
            "user": {
                "id": user.id,
                "email": user.email,
                "localId": user.localId,
                "role": user.role,
                "provider": user.provider
            }
        }
```

### Endpoint 2: Update Role

```python
class UpdateRoleRequest(BaseModel):
    role: str = Field(..., regex="^(guest|user|admin)$")


@router.put("/{user_id}/role")
async def update_user_role(
    user_id: int,
    request: UpdateRoleRequest,
    current_user: dict = Depends(get_current_user)
):
    """
    Admin updates user role

    Requires: role = 'admin'
    Allowed roles: guest, user, admin
    """
    # Check admin permission
    if current_user.get("role") != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Only admins can update user roles"
        )

    async with AsyncSessionLocal() as db:
        # Get user
        stmt = select(User).where(User.id == user_id)
        result = await db.execute(stmt)
        user = result.scalars().first()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User {user_id} not found"
            )

        # Prevent self-demotion from admin
        if user.id == int(current_user.get("user_id")) and request.role != "admin":
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Cannot demote yourself from admin role"
            )

        # Update role
        old_role = user.role
        user.role = request.role
        await db.commit()
        await db.refresh(user)

        return {
            "success": True,
            "message": f"Role updated: {old_role} → {request.role}",
            "user": {
                "id": user.id,
                "email": user.email,
                "localId": user.localId,
                "role": user.role,
                "provider": user.provider
            }
        }
```

### Endpoint 3: List Users

```python
from typing import Optional

@router.get("")
async def list_users(
    localId: Optional[str] = None,
    provider: Optional[str] = None,
    email: Optional[str] = None,
    limit: int = 50,
    offset: int = 0,
    current_user: dict = Depends(get_current_user)
):
    """
    Admin lists users with optional filters

    Requires: role = 'admin'
    Filters: localId, provider, email
    Pagination: limit, offset
    """
    # Check admin permission
    if current_user.get("role") != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Only admins can list users"
        )

    async with AsyncSessionLocal() as db:
        # Build query
        stmt = select(User)

        # Apply filters
        if localId:
            stmt = stmt.where(User.localId == localId)
        if provider:
            stmt = stmt.where(User.provider == provider)
        if email:
            stmt = stmt.where(User.email.ilike(f"%{email}%"))

        # Apply pagination
        stmt = stmt.limit(limit).offset(offset)

        result = await db.execute(stmt)
        users = result.scalars().all()

        # Count total (for pagination)
        count_stmt = select(func.count(User.id))
        if localId:
            count_stmt = count_stmt.where(User.localId == localId)
        if provider:
            count_stmt = count_stmt.where(User.provider == provider)
        if email:
            count_stmt = count_stmt.where(User.email.ilike(f"%{email}%"))

        count_result = await db.execute(count_stmt)
        total = count_result.scalar()

        return {
            "users": [
                {
                    "id": u.id,
                    "email": u.email,
                    "full_name": u.full_name,
                    "localId": u.localId,
                    "role": u.role,
                    "provider": u.provider,
                    "is_active": u.is_active,
                    "created_at": u.created_at.isoformat()
                }
                for u in users
            ],
            "total": total,
            "limit": limit,
            "offset": offset
        }
```

### Key Considerations

1. **Authorization:**
   - All endpoints check `role == "admin"`
   - Return 403 Forbidden if not admin

2. **Input Validation:**
   - localId: alphanumeric only, max 50 chars
   - role: must be one of ["guest", "user", "admin"]
   - Use Pydantic models for validation

3. **Error Handling:**
   - 404 if user not found
   - 400 if validation fails
   - 403 if not admin
   - Clear error messages

4. **Safety:**
   - Prevent admin from demoting themselves
   - Log all admin actions (optional but recommended)

## Dependencies

- [x] Task 004 completed (OAuth flows working với localId)
- [ ] RBAC decorators available (`@require_roles`)
- [ ] `get_current_user` dependency working
- [ ] Database session management

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 4-5 hours
  - 1.5h: Implement assign localId endpoint
  - 1.5h: Implement update role endpoint
  - 1.5h: Implement list users endpoint
  - 0.5h: Input validation và error handling
  - 1h: Testing all endpoints
- **Parallel:** true (không conflict với tasks khác)

## Definition of Done

- [ ] All 3 endpoints implemented
- [ ] Authorization checks working (admin only)
- [ ] Input validation working
- [ ] Error handling comprehensive
- [ ] Tested: admin can assign localId
- [ ] Tested: admin can update role
- [ ] Tested: admin can list users với filters
- [ ] Tested: non-admin gets 403 Forbidden
- [ ] Tested: invalid input gets 400 Bad Request
- [ ] Tested: prevent self-demotion
- [ ] Code formatted, có docstrings
- [ ] Ready for testing phase (Task 006)
