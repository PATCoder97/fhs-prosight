---
name: Extend JWT handler để include localId và oauth_provider
status: open
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T02:35:16Z
github: https://github.com/PATCoder97/fhs-prosight/issues/4
depends_on: [3]
parallel: false
conflicts_with: [3, 5]
---

# Task: Extend JWT handler để include localId và oauth_provider

## Description

Mở rộng JWT handler để:
1. Thêm parameters `localId` và `provider` vào `create_access_token()` function
2. Include `localId` và `oauth_provider` trong JWT payload
3. Đảm bảo backward compatibility - old tokens (không có localId) vẫn valid
4. Update token verification logic nếu cần

JWT payload mới sẽ có thêm 2 fields:
- `localId`: Mã nhân viên (nullable)
- `oauth_provider`: Provider used for login ("github" hoặc "google")

## Acceptance Criteria

- [ ] `create_access_token()` có parameters mới: `localId` (optional) và `provider` (optional)
- [ ] JWT payload chứa `localId` (nullable) và `oauth_provider`
- [ ] Token size vẫn < 1KB
- [ ] `verify_token()` function vẫn hoạt động với old tokens (không có localId)
- [ ] New tokens có đầy đủ fields: user_id, email, role, localId, oauth_provider, exp, iat, scope
- [ ] Token signing/verification performance < 10ms
- [ ] Backward compatible - không break existing auth flow

## Technical Details

### File to Modify

**`backend/app/core/jwt_handler.py`**

### Current Implementation

```python
def create_access_token(
    user_id: str,
    full_name: str,
    role: str,
    scope: str = "access",
) -> str:
    payload = {
        "user_id": user_id,
        "full_name": full_name,
        "role": role,
        "scope": scope,
        "exp": expiration_time,
        "iat": current_time,
    }
    return jwt.encode(payload, SECRET_KEY, algorithm="HS256")
```

### Updated Implementation

```python
def create_access_token(
    user_id: str,
    full_name: str,
    role: str,
    localId: Optional[str] = None,  # NEW parameter
    provider: Optional[str] = None,  # NEW parameter
    scope: str = "access",
) -> str:
    """
    Create JWT access token with user information

    Args:
        user_id: User ID from database
        full_name: User's full name
        role: User role (guest, user, admin)
        localId: Employee local ID (optional, e.g., VNW0014732)
        provider: OAuth provider used (optional, e.g., 'github', 'google')
        scope: Token scope (default: 'access')

    Returns:
        Encoded JWT token string
    """
    current_time = datetime.utcnow()
    expiration_time = current_time + timedelta(hours=24)  # 24h expiry

    payload = {
        "user_id": user_id,
        "full_name": full_name,
        "role": role,
        "scope": scope,
        "exp": int(expiration_time.timestamp()),
        "iat": int(current_time.timestamp()),
    }

    # Add optional fields if provided
    if localId is not None:
        payload["localId"] = localId

    if provider is not None:
        payload["oauth_provider"] = provider

    return jwt.encode(payload, SECRET_KEY, algorithm="HS256")
```

### Verification Function

**Ensure `verify_token()` handles missing fields gracefully:**

```python
def verify_token(token: str, required_scope: str = "access") -> Optional[dict]:
    """
    Verify and decode JWT token

    Backward compatible - old tokens without localId/oauth_provider still valid
    """
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])

        # Check scope
        if payload.get("scope") != required_scope:
            return None

        # Optional fields - set to None if not present (backward compatibility)
        if "localId" not in payload:
            payload["localId"] = None

        if "oauth_provider" not in payload:
            payload["oauth_provider"] = None

        return payload
    except jwt.ExpiredSignatureError:
        return None
    except jwt.InvalidTokenError:
        return None
```

### Key Considerations

1. **Backward Compatibility:**
   - Old tokens (issued before this change) không có `localId` và `oauth_provider`
   - `verify_token()` phải handle gracefully, set defaults to `None`
   - Không reject old tokens cho đến khi chúng expire naturally

2. **Token Size:**
   - Thêm 2 fields tăng ~50-80 bytes
   - Typical localId: "VNW0014732" (11 chars)
   - oauth_provider: "github" hoặc "google" (6-7 chars)
   - Total token size vẫn < 500 bytes, well under 1KB limit

3. **Optional Parameters:**
   - Use `Optional[str] = None` để tránh breaking existing calls
   - Only add to payload if not None (giảm token size khi không cần)

## Dependencies

- [x] Task 002 completed (auth service đã return localId và provider)
- [ ] JWT library (PyJWT) installed và working
- [ ] SECRET_KEY configured trong environment

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 2-3 hours
  - 1h: Update `create_access_token()` function
  - 0.5h: Update `verify_token()` for backward compatibility
  - 0.5h: Test token creation với localId và provider
  - 0.5h: Test old tokens vẫn verify được
  - 0.5h: Performance testing (token size, encode/decode speed)
- **Parallel:** false (depends on 002, conflicts with 002, 004)

## Definition of Done

- [ ] `create_access_token()` có parameters: localId, provider
- [ ] JWT payload includes localId và oauth_provider (when provided)
- [ ] `verify_token()` handles missing fields gracefully
- [ ] Tested: create token với localId → decode thành công
- [ ] Tested: create token không có localId → vẫn hoạt động
- [ ] Tested: old tokens vẫn verify thành công
- [ ] Token size measured và < 1KB
- [ ] Performance < 10ms cho sign/verify operations
- [ ] Code có docstrings và type hints
- [ ] Ready to integrate với OAuth callbacks (Task 004)
