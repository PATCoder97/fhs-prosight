---
name: Tạo Alembic migration để thêm localId và fix role default
status: open
created: 2026-01-08T02:23:12Z
updated: 2026-01-08T02:41:31Z
github: https://github.com/PATCoder97/fhs-prosight/issues/2
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Tạo Alembic migration để thêm localId và fix role default

## Description

Tạo Alembic migration script để:
1. Thêm cột `localId` (VARCHAR 50, nullable, indexed) vào bảng `users`
2. Thay đổi default value của cột `role` từ `"user"` sang `"guest"` cho users mới
3. Tạo unique constraint cho `(provider, social_id)` để đảm bảo không duplicate OAuth accounts
4. Viết downgrade script để rollback nếu cần

Migration phải backward compatible - không ảnh hưởng đến existing users, chỉ áp dụng cho users mới.

## Acceptance Criteria

- [ ] File migration được tạo tại `alembic/versions/xxxx_add_localid_and_fix_role.py`
- [ ] Migration có cả `upgrade()` và `downgrade()` functions
- [ ] Upgrade thêm cột `localId` với type VARCHAR(50), nullable=True
- [ ] Upgrade tạo index `idx_users_localid` trên cột `localId`
- [ ] Upgrade thay đổi default value của `role` thành `'guest'`
- [ ] Upgrade tạo unique constraint `uq_provider_social_id` trên `(provider, social_id)`
- [ ] Downgrade rollback tất cả changes theo thứ tự ngược lại
- [ ] Migration test thành công trên local dev database
- [ ] Rollback (downgrade) test thành công
- [ ] Existing users vẫn giữ nguyên role hiện tại sau migration

## Technical Details

### Implementation Approach

**File location:** `alembic/versions/YYYYMMDD_HHMMSS_add_localid_and_fix_role.py`

**Upgrade steps:**
1. Add column: `localId VARCHAR(50) NULL`
2. Create index: `idx_users_localid` on `localId`
3. Alter column default: `role` server_default = `'guest'`
4. Create unique constraint: `uq_provider_social_id` on `(provider, social_id)`

**Downgrade steps (reverse order):**
1. Drop constraint: `uq_provider_social_id`
2. Alter column default: `role` server_default = `'user'`
3. Drop index: `idx_users_localid`
4. Drop column: `localId`

### Key Considerations

- **Backward compatibility:** Không update existing data, chỉ thay đổi schema
- **NULL safety:** `localId` phải nullable vì existing users chưa có giá trị
- **Index performance:** Index trên `localId` giúp query nhanh khi admin search users
- **Unique constraint:** Đảm bảo không có duplicate OAuth accounts (same provider + social_id)

### Code Example

```python
"""add localId and fix role default

Revision ID: xxxx
Revises: yyyy
Create Date: 2026-01-08 02:23:12.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'xxxx'
down_revision = 'yyyy'  # ID của migration trước đó
branch_labels = None
depends_on = None

def upgrade():
    # Add localId column
    op.add_column('users', sa.Column('localId', sa.String(50), nullable=True))

    # Create index on localId
    op.create_index('idx_users_localid', 'users', ['localId'], unique=False)

    # Change default role for NEW users only
    op.alter_column('users', 'role',
                    existing_type=sa.String(50),
                    server_default='guest',
                    existing_nullable=False)

    # Ensure unique constraint for OAuth accounts
    op.create_unique_constraint('uq_provider_social_id', 'users', ['provider', 'social_id'])


def downgrade():
    # Reverse order of upgrade
    op.drop_constraint('uq_provider_social_id', 'users', type_='unique')

    op.alter_column('users', 'role',
                    existing_type=sa.String(50),
                    server_default='user',
                    existing_nullable=False)

    op.drop_index('idx_users_localid', table_name='users')

    op.drop_column('users', 'localId')
```

### Testing Strategy

**Test on local dev:**
```bash
# Run migration
alembic upgrade head

# Verify schema
# Check users table has localId column, index, and constraint

# Test rollback
alembic downgrade -1

# Verify schema reverted
# Check users table không còn localId
```

**Verify existing users:**
```sql
-- After migration, existing users should keep their current role
SELECT id, email, role, localId FROM users LIMIT 10;
-- Expected: role = 'user' (or whatever they had), localId = NULL
```

## Dependencies

- [ ] Alembic installed và configured (alembic.ini có sẵn)
- [ ] Database connection working
- [ ] Biết revision ID của migration trước đó (`down_revision`)
- [ ] Backup database trước khi test migration

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 2-3 hours
  - 1h: Viết migration script
  - 0.5h: Test upgrade/downgrade locally
  - 0.5h: Verify không breaking existing data
  - 1h: Documentation và review
- **Parallel:** true (có thể làm song song với tasks khác, không conflict)

## Definition of Done

- [ ] Migration file created và formatted đúng
- [ ] Code có docstring và comments rõ ràng
- [ ] Upgrade script chạy thành công trên local DB
- [ ] Downgrade script rollback thành công
- [ ] Existing users data không bị thay đổi (verified bằng SQL query)
- [ ] Schema changes documented trong migration message
- [ ] Code reviewed (nếu có team member)
- [ ] Ready to deploy lên staging environment
