---
name: Create API router with 4 endpoints
status: open
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
github: https://github.com/PATCoder97/fhs-prosight/issues/58
depends_on: [57]
parallel: false
conflicts_with: [59]
---

# Task: Create API router with 4 endpoints

## Description
Create the FastAPI router with four endpoints: POST /check, GET /search, GET /products, and POST /sync (basic version). All endpoints require admin authentication and use the service layer for business logic.

## Acceptance Criteria
- [ ] Router created at `backend/app/routers/pidms.py`
- [ ] POST /api/pidms/check endpoint with PIDMSKeyCheckRequest validation
- [ ] GET /api/pidms/search endpoint with query parameters
- [ ] GET /api/pidms/products endpoint
- [ ] POST /api/pidms/sync endpoint (basic stub, will be enhanced in task 007)
- [ ] All endpoints require admin authentication
- [ ] Proper error handling and HTTP status codes
- [ ] OpenAPI documentation auto-generated

## Technical Details

**File:** `backend/app/routers/pidms.py`

**Implementation:**
```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional

from app.core.security import require_admin
from app.core.config import get_settings
from app.database.session import get_db
from app.schemas.pidms import (
    PIDMSKeyCheckRequest,
    PIDMSCheckResponse,
    PIDMSSearchResponse,
    PIDMSProductsResponse,
    PIDMSSyncRequest,
    PIDMSSyncResponse
)
from app.services import pidms_service
from app.integrations.pidkey_client import PIDKeyClient

router = APIRouter(prefix="/api/pidms", tags=["PIDMS Key Management"])
settings = get_settings()


def get_pidkey_client() -> PIDKeyClient:
    """Dependency to get PIDKey client instance"""
    return PIDKeyClient(
        api_key=settings.PIDKEY_API_KEY,
        base_url=settings.PIDKEY_BASE_URL
    )


@router.post("/check", response_model=PIDMSCheckResponse, dependencies=[Depends(require_admin)])
async def check_keys(
    request: PIDMSKeyCheckRequest,
    db: AsyncSession = Depends(get_db),
    client: PIDKeyClient = Depends(get_pidkey_client)
):
    """
    Check product keys against PIDKey.com and import/update in database

    - Validates keys with PIDKey.com API
    - Inserts new keys or updates existing ones
    - Returns summary of operations
    """
    # Parse keys from request (split by \r\n or \n)
    keys_list = [k.strip() for k in request.keys.replace("\\r\\n", "\n").split("\n") if k.strip()]

    if not keys_list:
        raise HTTPException(status_code=422, detail="No valid keys provided")

    result = await pidms_service.check_and_upsert_keys(db, keys_list, client)
    return result


@router.get("/search", response_model=PIDMSSearchResponse, dependencies=[Depends(require_admin)])
async def search_keys(
    product: Optional[str] = Query(None, description="Partial product name match"),
    min_remaining: Optional[int] = Query(None, ge=0, description="Minimum activations remaining"),
    max_remaining: Optional[int] = Query(None, ge=0, description="Maximum activations remaining"),
    blocked: Optional[int] = Query(None, description="Blocked status (-1 or 1)"),
    page: int = Query(1, ge=1, description="Page number"),
    page_size: int = Query(50, ge=1, le=100, description="Items per page"),
    db: AsyncSession = Depends(get_db)
):
    """
    Search product keys with fuzzy matching and filters

    - Supports partial product name matching (e.g., 'Office' matches all Office products)
    - Filter by remaining activation count
    - Filter by blocked status
    - Paginated results
    """
    result = await pidms_service.search_keys(
        db, product, min_remaining, max_remaining, blocked, page, page_size
    )
    return result


@router.get("/products", response_model=PIDMSProductsResponse, dependencies=[Depends(require_admin)])
async def get_products(db: AsyncSession = Depends(get_db)):
    """
    Get all product types with aggregated statistics

    - Groups keys by product code
    - Shows total keys, remaining activations, and averages
    - Flags low inventory products
    """
    result = await pidms_service.get_product_summary(db)
    return result


@router.post("/sync", response_model=PIDMSSyncResponse, dependencies=[Depends(require_admin)])
async def sync_keys(
    request: PIDMSSyncRequest,
    db: AsyncSession = Depends(get_db),
    client: PIDKeyClient = Depends(get_pidkey_client)
):
    """
    Sync all keys in database with PIDKey.com (basic version)

    Note: Full batching implementation in Task 007
    """
    # Stub for now - will be implemented in task 007
    return {
        "success": False,
        "summary": {},
        "error_details": [{"error": "Sync not yet implemented - see task 007"}]
    }
```

**Files Affected:**
- `backend/app/routers/pidms.py` (new)

## Dependencies
- [x] Task 004: Service layer must exist

## Effort Estimate
- Size: M
- Hours: 4-5 hours
- Parallel: false (depends on task 004)

## Definition of Done
- [x] All 4 endpoints implemented
- [x] Admin authentication tested (401 for non-admin)
- [x] Request/response validation working
- [x] Error handling tested
- [x] OpenAPI docs generated correctly
- [x] Manual testing with curl/Postman
