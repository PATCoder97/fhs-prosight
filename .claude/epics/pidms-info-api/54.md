---
name: Create database model and migration for pidms_keys table
status: open
created: 2026-01-12T07:14:18Z
updated: 2026-01-12T07:24:05Z
github: https://github.com/PATCoder97/fhs-prosight/issues/54
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create database model and migration for pidms_keys table

## Description
Create the SQLAlchemy model for the pidms_keys table and corresponding Alembic migration. The model should store all 14 fields from the PIDKey.com API response with proper types, constraints, and indexes.

## Acceptance Criteria
- [ ] SQLAlchemy model created at `backend/app/models/pidms_key.py`
- [ ] Model includes all 14 fields: id, keyname, keyname_with_dash, prd, eid, is_key_type, is_retail, remaining, blocked, errorcode, sub, had_occurred, invalid, datetime_checked_done, created_at, updated_at
- [ ] Unique constraint on keyname field
- [ ] Indexes created on: prd, remaining, blocked
- [ ] Alembic migration script generated and tested
- [ ] Model imported in `backend/app/models/__init__.py`
- [ ] Migration runs successfully (upgrade and downgrade)

## Technical Details

**File:** `backend/app/models/pidms_key.py`

**Model Structure:**
```python
from sqlalchemy import Column, Integer, String, DateTime, Index
from sqlalchemy.sql import func
from app.database.base import Base

class PIDMSKey(Base):
    __tablename__ = "pidms_keys"

    id = Column(Integer, primary_key=True, index=True)
    keyname = Column(String(255), unique=True, nullable=False, index=True)
    keyname_with_dash = Column(String(255), nullable=False)
    prd = Column(String(255), nullable=False, index=True)
    eid = Column(String(255), nullable=True)
    is_key_type = Column(String(50), nullable=True)
    is_retail = Column(Integer, nullable=True)
    remaining = Column(Integer, nullable=False, default=0, index=True)
    blocked = Column(Integer, nullable=False, default=-1, index=True)
    errorcode = Column(String(255), nullable=True)
    sub = Column(String(255), nullable=True)
    had_occurred = Column(Integer, default=0)
    invalid = Column(Integer, default=0)
    datetime_checked_done = Column(String(255), nullable=True)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

**Migration Commands:**
```bash
# Generate migration
alembic revision --autogenerate -m "Create pidms_keys table"

# Apply migration
alembic upgrade head

# Test rollback
alembic downgrade -1
alembic upgrade head
```

**Files Affected:**
- `backend/app/models/pidms_key.py` (new)
- `backend/app/models/__init__.py` (update to import PIDMSKey)
- `backend/alembic/versions/xxxx_create_pidms_keys_table.py` (generated)

## Dependencies
- [ ] PostgreSQL database configured
- [ ] Alembic migration system set up
- [ ] SQLAlchemy Base class available

## Effort Estimate
- Size: S
- Hours: 2-3 hours
- Parallel: true (no dependencies on other tasks)

## Definition of Done
- [x] Code implemented
- [x] Migration script generated and tested
- [x] Model imported in __init__.py
- [x] Indexes verified in database (EXPLAIN ANALYZE queries)
- [x] Rollback tested successfully
