---
name: Extend HRS client with achievement data retrieval
status: completed
created: 2026-01-10T01:12:36Z
updated: 2026-01-10T04:26:43Z
github: https://github.com/PATCoder97/fhs-prosight/issues/28
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Extend HRS Client with Achievement Data Retrieval

## Description

Add `get_achievement_data()` method and `_split_blocks()` helper function to the existing `FHSHRSClient` class in `backend/app/integrations/fhs_hrs_client.py`. This extends the HRS client to fetch and parse achievement/evaluation data from the HRS API endpoint `s11`.

The parsing logic is provided and tested. Total new code: ~30 lines.

## Acceptance Criteria

- [ ] `_split_blocks()` helper function created to split pipe-delimited text
- [ ] `get_achievement_data()` async method added to FHSHRSClient class
- [ ] Method fetches from HRS endpoint: `s11/VNW00{emp_id:05d}`
- [ ] Parses pipe-delimited format: `2024|甲o|o2023|甲o|o`
- [ ] Validates: year > 1990, score non-empty
- [ ] Returns list sorted by year (descending)
- [ ] Error handling: returns None if API fails, logs errors
- [ ] UTF-8 encoding handles Japanese characters correctly

## Technical Details

**File to modify**: `backend/app/integrations/fhs_hrs_client.py`

**New Helper Function**:
```python
def _split_blocks(text: str) -> List[str]:
    """
    Split pipe-delimited achievement text into blocks.

    Args:
        text: Raw text from HRS API (e.g., "2024|甲o|o2023|甲o|o")

    Returns:
        List of blocks (e.g., ["2024|甲", "2023|甲"])
    """
    return [b for b in text.split("o|o") if b.strip()]
```

**New Method** (add to FHSHRSClient class):
```python
async def get_achievement_data(self, emp_id: int) -> List[dict]:
    """
    Fetch employee achievement/evaluation data from HRS API.

    Args:
        emp_id: Employee numeric ID (e.g., 6204 for VNW0006204)

    Returns:
        List of achievement records, sorted by year (descending):
        [{"year": "2024", "score": "甲"}, {"year": "2023", "score": "甲"}]
        Returns empty list if no data or on error.

    Raises:
        Exception: If HRS API is unavailable (caller handles)
    """
    path = f"s11/VNW00{emp_id:05d}"

    try:
        raw_text = await self._fetch_text(path)
        if not raw_text:
            return []

        results = []
        for block in _split_blocks(raw_text):
            try:
                parts = block.split("|")
                if len(parts) >= 2:
                    year = int(parts[0])
                    score = parts[1].strip()
                    if year > 1990 and score:
                        results.append({"year": str(year), "score": score})
            except (ValueError, IndexError):
                # Skip malformed blocks
                continue

        # Sort by year, descending (most recent first)
        return sorted(results, key=lambda x: x["year"], reverse=True)

    except Exception as e:
        logger.error(f"Error fetching achievement data for emp_id {emp_id}: {e}")
        raise
```

**Integration Pattern**: Follow the same structure as `get_salary_data()` method in the same file

**Error Handling**: Use existing logger, reuse `_fetch_text()` infrastructure

## Dependencies

- [ ] FHSHRSClient class exists (from salary API)
- [ ] `_fetch_text()` method exists (from salary API)
- [ ] Logger configured (from salary API)

## Effort Estimate

- Size: S
- Hours: 2 hours
- Parallel: false (can run in parallel with Task 001, but not with 003)

## Definition of Done

- [ ] Helper function `_split_blocks()` implemented
- [ ] Method `get_achievement_data()` implemented
- [ ] Code follows existing patterns in fhs_hrs_client.py
- [ ] Error handling matches existing methods
- [ ] UTF-8 encoding tested with Japanese characters
- [ ] Manual test with sample HRS data successful
- [ ] Committed with message: "Issue #XX: Extend HRS client with achievement data retrieval"
- [ ] No breaking changes to existing HRS client methods
